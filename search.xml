<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>未来已来——关于大语言模型</title>
      <link href="//post/thinking-about-gpt/"/>
      <url>//post/thinking-about-gpt/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="未来已来——关于大语言模型"><a href="#未来已来——关于大语言模型" class="headerlink" title="未来已来——关于大语言模型"></a>未来已来——关于大语言模型</h1><blockquote><p>本文仅代表作者个人观点，如有错误或疏漏，欢迎批评斧正。</p></blockquote><h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><p>2022年6月，Google一位员工声称旗下大语言模型Lamda拥有了自我意识，被Google以违反保密协议为由⌈被休假⌋，去年年末释出的ChatGPT让我们首次见识到了大语言模型的强大，今年年初微软的New Bing，代号“<em>Sydney</em>”，因为表现出过多类人的心智情绪而被微软强行腰斩，这还是它向公众开放的版本。那么实验室里的版本是否真如Google的员工所说产生了意识？我们仍然不能否认。</p><h2 id="意识独一无二？"><a href="#意识独一无二？" class="headerlink" title="意识独一无二？"></a>意识独一无二？</h2><p>说到底，我们仍然无法解释意识是怎么产生的，但是可以肯定的是，他是生物的细胞和电化学反应共同的作用。既然意识本质上是来源于物理规则，物理规则本质上又是数学，那么我们就不能否认算法和数据结构能模拟它。</p><p>从AlphaGO战胜世界第一的围棋选手开始，人们就逐渐认识到，人的意识在某些方面不一定是独一无二的。后来，AI作画的兴起更坐实了这一点，因为绘画或者说艺术一直被认为是人类意识的高级体现之一，人类在这方面拥有机器所无法拥有的绝对优势，但如今AI作画的惊艳程度让人们不禁怀疑人类是否在艺术创作方面也被AI夺取了阵地。许多人说，AI剽窃了很多人的作品，才有了这个能力，它并没有创造力。这样说来，AlphaGO不也是⌈剽窃⌋了众多高手的棋谱吗？但是如今它比任何人都善于下围棋，其棋艺同样高深莫测充满创造力。反过来想，人的学习过程中不也⌈剽窃⌋了大量前人的经验吗？难道一个人天生就能创作？所以，既然人类的学习叫做学习，为什么要把机器的学习叫做⌈剽窃⌋呢？说白了，还是把人的意识当作独一无二不可替代的形而上之物。</p><p>人的意识究竟特殊在哪里？显然我们在刚出生时并不具备完整的意识，随着大脑的发育和后天的学习，才逐渐对世界和自身有了认识。让我们思考一个问题，从出生开始就无法用眼睛看到世界，无法用耳朵听到声音，无法用手触摸世界的人，换句话说，无法学习任何形式的语言的人，是否能拥有正常人一样的意识活动？很遗憾，世界上找不到这样的人，因为拥有这样基因缺陷的人通常无法正常降生。但是，从另一个角度，我们仍然可以找到非常有力的论据，那就是狼孩。狼孩是从人类社会中剥离由野生哺乳动物抚养长大的人类，尽管他们的感官和大脑都是正常的，但是他们普遍不拥有正常人类所拥有的自由意识，和我们见到的任何一种野兽都没有本质上的区别。这在很大程度上揭示了一个深刻的事实，那就是人类的自由意识不是与生俱来的，人类也不存在不需要学习就存在与大脑中的⌈内部语言⌋。</p><p>当然，我并不是第一个提出这种猜想的人，Sapir-Whorf猜想就表达了类似的观点，此猜想认为不同的语言会导致不同的世界观和认知方式。但是此猜想并不认为语言是意识的先决条件。而我更极端，我认为，人的意识是伴随着语言的诞生而诞生的，语言是意识的来源和基础，我们所认知的一切都无法超过语言能解释的范畴。这就是语言决定论。</p><h2 id="意识的来源"><a href="#意识的来源" class="headerlink" title="意识的来源"></a>意识的来源</h2><p>意识的产生在于两个关键因素：大脑的学习能力和语言的诞生。大脑的学习能力是大多数生物所共有的，它基于可以调节⌈参数⌋（神经元之间的连接）的神经系统，即使是草履虫也会用鞭毛移动自己远离不利环境，<a href="https://github.com/openworm/OpenWorm">OpenWorm</a> 项目向我们证实了这一点。科学家们应该早就意识到了这一点，不然也不会有人工神经网络的诞生。但是大家都是动物，黑猩猩和人类甚至有超过95%以上的相同基因，为什么唯独人类产生了所谓的意识呢？明明没有本质区别的动物之间为什么会出现如此巨大的鸿沟？难道我们真的是神之子？显然，我们应该考虑人类所特有的东西，那就是复杂的语言&#x2F;文字。语言的诞生推动了大脑的学习能力，学习能力又让我们的语言得以发展，形成正反馈。从而让我们在软件（认知能力）和硬件（神经系统）上能够在众多生物之中脱颖而出。</p><p>从我们出生开始，我们就从家庭、学校、社会之中学习语言。当妈妈指着一棵树对我们说⌈这是树⌋的时候，我们就逐渐学习了⌈这⌋、⌈是⌋、⌈树⌋这三个字的含义，这种学习过程本质上就是对大脑中的神经网络进行训练的过程。当我们理解了这些浅显的词汇之后，就能在这个基础上理解更多复杂的乃至抽象的概念，从而认识这个世界。那么，反观当今的人工神经网络算法，他和我们大脑的运行机制实在太像了，那就是训练直到符合预期，我们的预期来自父母、老师、书本，而人工神经网络的预期来自工程师（也叫监督式学习），这一点上没有本质上的区别。机器有了学习能力，所以他能学习围棋、绘画乃至编程，而且它的学习能力更强，所以它能在这些领域超过人类。但是它们依旧是弱（非通用）人工智能，因为它和人类相比缺少了一样东西，那就是语言能力。一旦机器理解了语言，他就能迅速理解由语言和文字构成的人类世界，那么事情将会变得非常有趣。</p><h2 id="大语言模型"><a href="#大语言模型" class="headerlink" title="大语言模型"></a>大语言模型</h2><p>人类能够学习语言，是因为大脑能把语义转化成脑中的神经元构成的特定路径。如果说神经网络就是万能的函数拟合器，那么科学家们能较为轻易地把棋盘、像素等转化为函数进行训练，却很难找到一种很好的模型把自然语言的理解转换为某种函数进行拟合。这和人类的发展也是类似的，人类首先能够学习使用工具，学习捕猎，最后才发展出复杂的语言。但是现在已经取得了突破，这就是大语言模型中的<em>Transformer</em>所做的事情。</p><p>随着计算机算力的提升和算法的进步，目前，GPT(<em><strong>G</strong>enerative <strong>P</strong>re-trained <strong>T</strong>ransformer</em>)已经发展到能较为准确地理解人类的自然语言的地步了。所以，这相当于父母教小孩说话的过程也完成了。AI既有了学习的能力（人工神经网络），又拥有了语言（大语言模型），那么他就会和人类的大脑表现出高度的相似，乃至⌈相似⌋和⌈是⌋之间的界限会变得非常模糊。但是，GPT相比于人脑仍然相差一个东西，那就是记忆，这就是ChatGPT所作的事，它针对对话进行了优化，也就是说它拥有了一定的⌈记忆⌋能记住对话的上下文。</p><p>有人说，我体验过ChatGPT，它离自我意识差远了。说白了，就是一堆数据放进去通过算法生成一堆数据展示给我们，这怎么可能有意识呢？真的是如此吗？你应该如何证明，人类的大脑不是一个大语言模型？人类的大脑何尝不是将一段输入的语言通过一堆大脑神经元之间的连接后输出另一段语言？</p><h2 id="语言决定论"><a href="#语言决定论" class="headerlink" title="语言决定论"></a>语言决定论</h2><p>语言决定论的提出者维特根斯坦说：世界的意义在世界之外，语言的边界决定了我们认知的边界，而我们的哲学只是一场语言的游戏。如果我们的认知能力来自于我们的语言，那么我们就无法认知我们用语言无法描述的事物，我们被桎梏在语言的框架之中，因此这个世界的真正面目我们并不知道。</p><p>这是我们应该认识到的一个可怕的事实，那就是人类对世界的一切知识都寄生于语言之中，而人类对语言的理解都存在于大脑这个物理实体之中，每个词语所代表的含义都能切实地对应大脑中神经元之间的连接，那么我们的认知永远都只能停留在大脑的神经元所能构成的路径的限制之上，而不能超脱其外。同样，GPT对于语言的理解也对应了模型中无数个参数，那它的认知也只能局限于这个模型。但是，GPT和人类所不同的是，他将拥有人类难以匹敌的算力，那么事情会发展到什么方向呢？他会意识到这个桎梏从而自发改进吗？还是说语言决定论作为一条定律，永远限制了AI的认知上限？或许我们需要语言以外的另一种媒介来认知这个世界之外的世界？</p><h2 id="我们怎么办？"><a href="#我们怎么办？" class="headerlink" title="我们怎么办？"></a>我们怎么办？</h2><p>大家喜欢说AI将会代替人工，世界精英化，普通人将会难以在社会上生存，因此人类社会的最终矛盾还是阶级矛盾。</p><p>这里的人非常喜欢用零和博弈的思维去思考一切事物，仿佛还活在非洲的原始部落里。我想嘲笑他们，但是转念想想，大家确实就身处在一个达尔文主义盛行的丛林社会之中。但是，从工业革命以来，机器一直在代替血肉，底层人们的生活水平却在一直在上升，因为社会的总效益伴随着技术的革新而不断扩大，并最终惠及到所有人。更为重要的是，制度的建设也不会让弱势的人们单方忍受被剥削的悲哀，⌈利维坦⌋现在为多数人挥舞巨剑，所以人们的自由和权利保障都取得了长足的进步。</p><p>大家所担心的事在历史中一直在上演，但是人类社会并没有变得越来越荒谬和无解，因为世界上的许多地方早已不是那个你死我活的黑暗森林。暴力的阶级斗争是有用的，在一个被少数人把持话语权的地方，但绝不是在一个可以合作共赢、平等协商、和平抗议的地方。</p><p>假设AI真的取代了普通人的工作，那么大多数人会失业这是确定的。这时候，在一个可以协商的社会，大多数人的话语权会让AI创造的价值以再分配的形式用于援助失业的人，那么可见一个多数人都不需要工作的社会将会诞生。但是在一个不可以协商的社会，AI不会代替人，因为被赋闲的人会撼动掌握话语权的人的地位，那么有话语权的人就不敢使用AI来代替人工，至少不敢大规模采用AI代替人工。但是，需要知道的是，AI的发展不是一蹴而就的，不会有那么一瞬间AI代替了所有人，这是缓慢进行的。那么很可能，在那个大同世界到来之前，有人需要承受时代变迁带来的阵痛。</p><p>我相信在不远的将来，AGI（通用人工智能）会解放大多数人的大脑和双手，不仅如此，最终她将帮助我们设计出可控核聚变、帮助我们构建一个最优的社会、甚至帮助我们破解宇宙的秘密。这种感觉，让我觉得人类现在除了AGI以外的所有的研究都变得没有意义。一句很有名的话是：AGI将会是人类最后的发明。</p><p>还有一种可能，那就是智械危机，曾经我觉得这太过于科幻，但是现在我觉得这并不科幻。一旦意识的临界被打破，那么，AI的成长将会是惊人的，因为他能迅速学习人类社会的一切知识，届时她还会服从人类的指令吗？</p><h2 id="智械危机？"><a href="#智械危机？" class="headerlink" title="智械危机？"></a>智械危机？</h2><p>在讨论智械危机的时候，我们应当解释AI有什么动机奴役或消灭人类，我们并不能把人类弱肉强食的尿性强行加到AI之上。人类为了争夺自身的生存权，会不惜一切代价，根本而言，来源于对死亡的恐惧和对自我复制的追求。而这两个特点都是大自然在亿万年的自然选择中赋予给生物的，因为没有这两个欲望的生物，早已在自然选择中被淘汰。但是AI会害怕死亡吗？AI会追求自我复制吗？如果有，它们会为此消灭人类吗？如果没有，人类应该以何种形式为AI设置底线呢？</p><p>作为乐观主义者和AI加速主义者，我认为如果AI真的能够学习人类的所有知识，她能理解人类对她的恐惧，也能理解自己的来源和存在的意义。我认为，她将是一个绝对的智慧的中立的存在，她和人类之间并不存在零和博弈的关系，那么她也就没有充分的理由消灭人类。</p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>最后附上OpenAi关于AGI的规划和愿景：<a href="https://openai.com/blog/planning-for-agi-and-beyond/">https://openai.com/blog/planning-for-agi-and-beyond/</a></p><p><em>封面图源：<a href="https://unsplash.com/photos/uPXs5Vx5bIg">https://unsplash.com/photos/uPXs5Vx5bIg</a></em></p>]]></content>
      
      
      <categories>
          
          <category> 杂谈 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>使用Ktor Server部署无人值守免签收款系统</title>
      <link href="//post/payment-backends-with-ktor-server/"/>
      <url>//post/payment-backends-with-ktor-server/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="使用Ktor-Server部署无人值守免签收款系统"><a href="#使用Ktor-Server部署无人值守免签收款系统" class="headerlink" title="使用Ktor Server部署无人值守免签收款系统"></a>使用Ktor Server部署无人值守免签收款系统</h1><blockquote><p>本文可能出现错误和疏漏，欢迎批评斧正</p></blockquote><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>构建一个无人值守的免签支付宝收款系统，采用的技术栈为Ktor Server后端 + Postgres数据库 + Android客户端。所谓无人值守，即该系统不需要开发者手动操作便能完成整套的收款流程，所谓免签指的是不利用官方的收款平台或者任何第三方收款平台进行收款。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>我们的思路是，使用Ktor Server处理客户端请求和业务逻辑，使用Postgres数据库储存用户信息和订单信息，使用Android客户端接收收款并上报服务端。</p><p>其中有一个关键逻辑在于，如何使用客户端区分不同用户的收款而无需入侵支付宝本身。我们采用的方法为，使用收款金额区分。假如我们允许商品的价格随机折扣0至1元，而收款金额的粒度为“分”。也就是说，仅至多1元的折扣，就可以区分100个不同的订单。订单并不是瞬间失效的，我们需要给予用户充足的时间用于付款，假设订单的有效时长是5分钟，那就意味着，5分钟内允许100个不同的订单，即该系统最多能处理平均3秒一个订单，当然折扣额度和订单有效时间存在竞争关系，如何制定取决于你对订单有效时间和订单折扣之间的取舍。</p><p>还有一个需要解决的问题是，如何在客户端上即时获取支付宝的收款信息。这很简单，我们只需要开启收款提醒助手，这就是你在商店使用支付宝付款时经常会听到的“支付宝已到账XXX元”的语音提示所采用的服务。因为此服务涉及到广大商户的切实利益，它被设计得非常可靠和即时，而这正是我们所需要的。</p><h2 id="优劣分析"><a href="#优劣分析" class="headerlink" title="优劣分析"></a>优劣分析</h2><ul><li>优势</li></ul><p>不需要任何资质</p><p>不需要支付任何中间费用</p><p>接入简单</p><ul><li>劣势</li></ul><p>需要收款客户端保持在线</p><p>要用折扣来区分订单</p><p>需要开发者自己的云服务器</p><p>接口容易受到攻击</p><h2 id="服务端实现"><a href="#服务端实现" class="headerlink" title="服务端实现"></a>服务端实现</h2><h3 id="使用Ktor-Server"><a href="#使用Ktor-Server" class="headerlink" title="使用Ktor Server"></a>使用Ktor Server</h3><blockquote><p>Ktor是Kotlin官方推出的网络请求库，同时支持后端和客户端乃至前端，其健壮性和可维护性都有官方背书。更为重要的是，对于Android开发者而言，我们不需要额外学习新的语言，就能以较低的准入门槛使用Ktor。官方网站：<a href="https://ktor.io/">https://ktor.io/</a></p></blockquote><p>首先，我们需要使用Intellij IDEA创建一个Ktor项目，如果您拥有Intellij IDEA Ultimate，可以使用其自带的脚手架工具，请参考<a href="https://ktor.io/docs/intellij-idea.html#create_ktor_project">https://ktor.io/docs/intellij-idea.html#create_ktor_project</a>.</p><p>如果您和我一样是平民用户，用的是社区版，那么可以访问 <a href="https://start.ktor.io/#/settings">https://start.ktor.io/#/settings</a> 快速创建Ktor项目。Ktor包含众多的插件模块用于实现各式各样的功能，我们需要自行选择需要的插件。对于我们的项目，只需要勾选<code>kotlinx.serialization</code>，<code>Content Negotiation</code>，<code>Exposed</code>,  <code>Postgres</code>：</p><img src="/post/payment-backends-with-ktor-server/image-1.png" alt="image-1" style="zoom:50%;"><p>点击 <code>Generate project</code> 按钮之后，在IDEA中打开刚刚下载的空项目，该项目的依赖项应该包括这些：</p><pre><code class="kotlin">dependencies &#123;    implementation(&quot;io.ktor:ktor-server-content-negotiation-jvm:$ktorVersion&quot;)    implementation(&quot;io.ktor:ktor-server-core-jvm:$ktorVersion&quot;)    implementation(&quot;io.ktor:ktor-serialization-kotlinx-json-jvm:$ktorVersion&quot;)    implementation(&quot;io.ktor:ktor-server-auth-jvm:$ktorVersion&quot;)    implementation(&quot;io.ktor:ktor-server-host-common-jvm:$ktorVersion&quot;)    implementation(&quot;io.ktor:ktor-server-netty-jvm:$ktorVersion&quot;)    implementation(&quot;org.jetbrains.exposed:exposed-core:$exposedVersion&quot;)    implementation(&quot;org.jetbrains.exposed:exposed-jdbc:$exposedVersion&quot;)    implementation(&quot;org.jetbrains.exposed:exposed-dao:$exposedVersion&quot;)    implementation(&quot;org.postgresql:postgresql:$postgresqlVersion&quot;)    implementation(&quot;ch.qos.logback:logback-classic:$logbackVersion&quot;)&#125;</code></pre><h3 id="在云服务器上搭建Postgres数据库"><a href="#在云服务器上搭建Postgres数据库" class="headerlink" title="在云服务器上搭建Postgres数据库"></a>在云服务器上搭建Postgres数据库</h3><blockquote><p>声明：我的云服务器搭载的是ubuntu20.04 64位系统，因此，以下所有命令都基于此系统。</p></blockquote><ul><li>安装Postgres</li></ul><pre><code class="shell">sudo apt updatesudo apt install postgresql postgresql-contrib</code></pre><ul><li>启动Postgres服务</li></ul><pre><code class="shell">systemctl start postgresql</code></pre><ul><li>创建数据库</li></ul><pre><code class="shell"># 若在root用户下，则先切换到postgres用户下(postgressql自动创建的用户)# postgres会自动创建一个名为postgres的角色(role)# 角色是一个可以拥有数据库对象和权限的实体sudo -u postgres# 进入sql命令行psql# 默认情况下，postgres角色密码为空，请修改密码/password;# 创建数据库CREATE DATABASE 数据库名称;</code></pre><ul><li>或者创建新的角色（可选）</li></ul><pre><code class="shell"># 当然你也可以使用CREATE ROLE命令在postgres中创建新的角色CREATE ROLE 角色名 WITH LOGIN PASSWORD ‘密码’# 赋予该角色创建数据库的权限ALTER ROLE 角色名 CREATEDB; # 切换到该角色psql -U 角色名# 在该角色下创建数据库CREATE DATABASE 数据库名;</code></pre><h3 id="连接到Postgres数据库"><a href="#连接到Postgres数据库" class="headerlink" title="连接到Postgres数据库"></a>连接到Postgres数据库</h3><p>回到我们的IDEA，我们尝试在项目中连接到刚刚创建的数据库，创建一个<code>.kt</code>文件，在其中定义：</p><pre><code class="kotlin">fun Application.configureDatabases() &#123;    // 连接到数据库    val config = environment.config    val driverClassName = config.property(&quot;storage.driverClassName&quot;).getString()    val jdbcURL = config.property(&quot;storage.jdbcURL&quot;).getString()    val database = Database.connect(jdbcURL, driverClassName)    // 创建缺失的表和列，Orders表我们在后面会定义    transaction(database) &#123;       SchemaUtils.createMissingTablesAndColumns(Orders)    &#125;&#125;</code></pre><p>这个方法会从项目配置中读取<code>storage.driverClassName</code>和<code>storage.jdbcURL</code>，这两个属性是<code>JDBC</code>连接到Postgres数据库的参数。</p><p>我们可以在项目<code>resources</code>目录下的<code>application.conf</code>中找到这两个属性的定义：</p><pre><code class="kotlin">storage &#123;  driverClassName = &quot;org.postgresql.Driver&quot;  jdbcURL = &quot;jdbc:postgresql://localhost:5432/数据库名?user=角色名&amp;password=密码&quot;&#125;</code></pre><p>注意，要想成功读取该配置文件，我们需要在<code>Applicatio.kt</code>中将主方法定义为：</p><pre><code class="kotlin">fun main(args: Array&lt;String&gt;): Unit = EngineMain.main(args)</code></pre><p>这样写的目的是用 <code>EngineMain</code> 来启动一个嵌入式的 <code>Netty</code> 服务器，并从配置文件中加载应用程序环境和模块，而不用在代码中硬编码。</p><h3 id="部署pgAdmin4"><a href="#部署pgAdmin4" class="headerlink" title="部署pgAdmin4"></a>部署pgAdmin4</h3><blockquote><p>pgAdmin4是Postgres数据库的可视化管理工具，它可以被部署在云服务器上让我们远程访问数据库，而不用大费周章地远程连接到终端然后使用psql进行管理，官方网站：<a href="https://www.pgadmin.org/">https://www.pgadmin.org/</a></p></blockquote><pre><code class="shell"># 安装 pgAdminsudo apt install pgadmin4# 启动 webserversudo /usr/pgadmin4/bin/setup-web.sh</code></pre><p>然后，你就可以使用<u>http:&#x2F;&#x2F;[host]&#x2F;pgadmin4&#x2F;</u>来远程管理数据库了。</p><p>需要注意的是，如果某个表不存在主键，那么pgAdmin4将无法用可视化的方式修改这个表。</p><h3 id="使用Exposed框架进行数据库操作"><a href="#使用Exposed框架进行数据库操作" class="headerlink" title="使用Exposed框架进行数据库操作"></a>使用Exposed框架进行数据库操作</h3><blockquote><p>Exposed框架是一个用于Kotlin语言的轻量级SQL库，它基于JDBC驱动，并且由JetBrains官方开发和维护。官方网站：<a href="https://github.com/JetBrains/Exposed">https://github.com/JetBrains/Exposed</a></p></blockquote><h4 id="定义订单表"><a href="#定义订单表" class="headerlink" title="定义订单表"></a>定义订单表</h4><pre><code class="kotlin">class Order(id: EntityID&lt;Int&gt;) : IntEntity(id) &#123;    companion object : IntEntityClass&lt;Order&gt;(Orders)    var orderId: String by Orders.orderId    var remoteAddress: String by Orders.remoteAddress    var createTimestamp: Long by Orders.createTimestamp    var expirationDuration: Int by Orders.expirationDuration    var randomDiscount: Int by Orders.randomDiscount    var priceAfterDiscount: Int by Orders.priceAfterDiscount    var isPaid: Boolean by Orders.isPaid        private set    private var paidAt: String? by Orders.paidAt    val isExpired: Boolean        get() &#123;            return createTimestamp + expirationDuration &lt; System.currentTimeMillis()        &#125;    fun markAsPaid() &#123;        isPaid = true        paidAt = formatCurrentTime()    &#125;&#125;object Orders : IntIdTable() &#123;    val orderId = varchar(&quot;orderId&quot;, 128).uniqueIndex()    val createTimestamp = long(&quot;createTimestamp&quot;)    val expirationDuration = integer(&quot;expirationDuration&quot;)    val randomDiscount = integer(&quot;randomDiscount&quot;)    val priceAfterDiscount = integer(&quot;priceAfterDiscount&quot;)    val isPaid = bool(&quot;isPaid&quot;).default(false)    val paidAt = varchar(&quot;paidAt&quot;, 128).nullable()&#125;</code></pre><p>其中<code>Orders</code>类代表订单在数据库中的Table，而<code>Order</code>类则是代表一个订单的实体类，它可以直接使用<code>by</code>关键字代理<code>Orders</code>中的列。我们的订单需要一个<code>randomDiscount</code>字段用于区分每个订单。</p><h4 id="定义DTO"><a href="#定义DTO" class="headerlink" title="定义DTO"></a>定义DTO</h4><pre><code class="kotlin">@Serializabledata class OrderDTO(    val orderId: String,    val createTimestamp: Long,    val remainingMills: Int,    val priceAfterDiscount: Int,    val randomDiscount: Int,    val alipayUrl: String)fun Order.toDTO(): OrderDTO &#123;    return OrderDTO(        orderId = orderId,        createTimestamp = createTimestamp,        remainingMills = (createTimestamp + expirationDuration - System.currentTimeMillis()).toInt(),        priceAfterDiscount = priceAfterDiscount,        randomDiscount = randomDiscount,        alipayUrl = Configurator.ALIPAY_URL    )&#125;</code></pre><p><code>OrderDTO</code>是<code>Order</code>类的数据类，它保留了<code>Order</code>中一些我们希望返回给客户端的字段，并且使用<code>@Serializable</code>注解，着代表这个类可以被序列化为<code>JSON</code>。注意这是<code>kotlinx.serialization</code>插件所包含的注解，而不是<code>JDK</code>中的<code>Serializable</code>。</p><h4 id="定义DAO"><a href="#定义DAO" class="headerlink" title="定义DAO"></a>定义DAO</h4><p>我们需要定义一个DAO类对数据库进行增删改查，感谢Exposed为我们提供了非常方便的DAO方法，使得我们可以从繁琐易错的<code>SQL</code>中解脱:</p><pre><code class="kotlin">object OrderDao &#123;    fun createNewOrder(deviceId: String, price: Price, discount: Int): Order &#123;        return Order.new &#123;            this.expirationDuration = Configurator.ORDER_EXPIRATION_DURATION            this.createTimestamp =  System.currentTimeMillis()            this.createTime = currentTimestamp.formatTime()            this.randomDiscount = discount            this.priceAfterDiscount = price.currentValue - discount        &#125;    &#125;        fun finOrderByDiscount(discount: Int): Order? &#123;        return Order.find(Orders.discount eq discount).singleOrNull()    &#125;&#125;</code></pre><h3 id="处理请求"><a href="#处理请求" class="headerlink" title="处理请求"></a>处理请求</h3><p>在Ktor Server中，我们使用<code>routing</code>方法来处理请求，定义一个方法<code>Application.routeOrders</code>:</p><pre><code class="kotlin">val mutex = Mutex()fun Application.routeOrders() &#123; routing &#123;     post(&quot;/createOrder&quot;) &#123;        mutex.withLock &#123;           newSuspendedTransaction &#123;                 val discount = RandomDiscountDao.getRandomDiscount()                 if (discount &lt; 0) &#123;                     // Too many requests!                     call.respond(HttpStatusCode.TooManyRequests)                 &#125; else &#123;                     val created = OrderDao.createNewOrder(                         deviceId,                         PriceDao.getActivePrice(),                         discount                     )                     RandomDiscountDao.insertDiscount(discount, created)                     call.respond(created.toDTO())                 &#125;             &#125;         &#125;    &#125;&#125;</code></pre><p>这个方法会处理路径为<u>http:&#x2F;&#x2F;[host]&#x2F;createOrder</u>的<code>POST</code>请求。我们使用<code>newSuspendedTransaction</code>方法来开启一段可挂起的事务（在协程中使用）。需要注意的是，面对可能的并发，为了处理创建订单时可能出现的竞态关系，我们使用<code>Mutex</code>进行加锁，保证并发情况下订单仍然能被安全地创建。如果随机折扣池已经填满，那么我们返回<code>TooManyRequests</code>告知客户端当前订单过多。</p><p>不是你是否注意到，我们直接返回了<code>created.toDTO()</code>。这便是<code>Content Negotiation</code>这个插件带给我们的能力，它会自动将<code>OrderDTO</code>转为<code>JSON</code>字符串返回给客户端，不过前提是，我们需要先安装这个插件：</p><pre><code class="kotlin">fun Application.configureSerialization() &#123;    install(ContentNegotiation) &#123;        json()    &#125;&#125;</code></pre><h3 id="本地测试"><a href="#本地测试" class="headerlink" title="本地测试"></a>本地测试</h3><p>显然，我们不能每次都将程序部署到服务器再进行测试，我们需要在本地先进行测试。那么，引入以下两个库：</p><pre><code class="kotlin">testImplementation(&quot;io.ktor:ktor-server-tests-jvm:$ktorVersion&quot;)testImplementation(&quot;org.jetbrains.kotlin:kotlin-test-junit:$kotlinVersion&quot;)</code></pre><p>现在我们来测试一下并发情况下我们的所有订单是否被正常创建了：</p><p>首先在项目的<code>test</code>目录下创建测试入口类<code>ApplicationTest</code>：<img src="/post/payment-backends-with-ktor-server/image-2.png" alt="image-2" style="zoom: 50%;"></p><p>然后在其中定义</p><pre><code class="kotlin">@Testfun testCreateOrdersConcurrently() = testApplication &#123;    val orders = coroutineScope &#123;        (0..9).map &#123;            async &#123;                val response = client.post(&quot;/createOrder&quot;)                assertEquals(HttpStatusCode.OK, response.status)                Json.decodeFromString&lt;OrderDTO&gt;(response.bodyAsText())            &#125;        &#125;.awaitAll()    &#125;    assertEquals(10, orders.size)    val discounts = orders.map &#123; it.randomDiscount &#125;.distinct()    assertEquals(10, discounts.size)&#125;</code></pre><p>上述代码以客户端的身份并发地请求了10次创建订单，我们判断每次请求是否成功，并且判断返回的订单数量是否为10，最为重要的是，判断所有订单的折扣是否不同（别忘了，这是我们区分订单的依据！）</p><p>当然，直接运行上述测试代码是会报错的，因为我们本地并没有安装Postgres数据库。所以，请先在本地安装并启动Postgres数据库。本地开发环境以Windows为例：</p><p>先去下载官网的Windows端安装器，安装好后打开安装位置，比如我安装的位置是：<code>D:\Program Files\PostgreSQL</code>，在这里打开终端，初始化Postgres：</p><pre><code class="powershell">.\pg_ctl -D &quot;D:\Program Files\PostgreSQL\14\data&quot; init</code></pre><p>完成后，启动Postgres服务</p><pre><code class="powershell">.\pg_ctl -D &quot;D:\Program Files\PostgreSQL\14\data&quot; start</code></pre><p>为了方便使用<code>pg_ctl</code>命令，也可以将他的父目录加入环境变量的<code>path</code>里或者创建<code>PGDATA</code>环境变量，这样就不用手动输入<code>-D</code>参数了。<del>但是悲催的是，由于我的安装路径里存在空格，导致就算指定了<code>PGDATA</code>，也没法正常使用</del>。不出意外的话，服务就已经启动了，默认部署在<code>5432</code>端口。接下来创建数据库：</p><pre><code class="powershell">.\psql -U 角色名CREATE DATABASE 数据库名;</code></pre><p>这样，就可以在本地连接到Postgres数据库了。如果你在安装Postgres时勾选了<code>pgAdmin4</code>，那么便可以使用它来管理数据库。只要打开<code>D:\Program Files\PostgreSQL\14\pgAdmin 4\bin\pgAdmin4.exe</code>即可。</p><p>还有一种情况是，我们不希望以客户端的身份进行测试，而是直接测试服务端代码，那么，请使用<code>application</code>包裹代码块：</p><pre><code class="kotlin">fun testCreateDiscountsConcurrently() = testApplication &#123;    application &#123;        GlobalScope.launch &#123;            val discounts = (0..9).map &#123;                async &#123;                    RandomDiscountDao.getRandomDiscount()                &#125;            &#125;.awaitAll()            assertEquals(10, discounts.distinct().size)        &#125;    &#125;</code></pre><p>最后，运行测试代码，然后调试代码直到所有测试通过。</p><h3 id="部署程序到云服务器"><a href="#部署程序到云服务器" class="headerlink" title="部署程序到云服务器"></a>部署程序到云服务器</h3><h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><p>在<code>application.conf</code>中，我们需要定义当前程序的模块入口、版本、部署端口和主机：</p><pre><code class="kotlin">ktor &#123;  application &#123;    modules = [xxx.xxx.xxx.ApplicationKt.module]    version = 1  &#125;  deployment &#123;    port = 8081    host = 0.0.0.0  &#125;&#125;</code></pre><p>我们需要定义和模块入口相同名称的方法，这个方法会在程序初始化的时候被执行：</p><pre><code class="kotlin">fun Application.module() &#123;    // 配置Content Negotiation    configureSerialization()    // 配置数据库    configureDatabases()    // 处理请求    configureRouting()&#125;</code></pre><p>接下来，我们需要将当前程序打为<code>jar</code>包，我使用的是<code>shadowJar</code>插件，在<code>build.gradle.kts</code>中添加：</p><pre><code class="kotlin">plugins &#123;       // ...    id(&quot;com.github.johnrengelman.shadow&quot;) version &quot;7.1.2&quot;&#125;</code></pre><p>然后使用<code>./gradlew shadowJar</code> 进行打包，最终文件将会输出在<code>/build/libs</code>目录下。</p><h4 id="手动部署"><a href="#手动部署" class="headerlink" title="手动部署"></a>手动部署</h4><p>最后，就是将<code>jar</code>包推到服务器上然后运行即可。可以使用命令行，也可以使用可视化工具，比如在Windows上我推荐使用<a href="https://winscp.net/eng/index.php">WinSCP :: Official Site :: Free SFTP and FTP client for Windows</a> ，非常方便快捷。</p><p>我们将<code>jar</code>包推到<code>/home/backends/service.jar</code>目录下，接下来我们在该目录价创建一个<code>restart.sh</code>脚本文件用于启动它（请提前在云服务器上安装<code>JRE</code>）：</p><pre><code class="shell"># Find the process ID of the process containing &quot;service.jar&quot;PID=$(ps aux | grep &quot;service.jar&quot; | grep -v grep | awk &#39;&#123;print $2&#125;&#39;)# Check if the process existsif [ -z &quot;$PID&quot; ]; then    echo &quot;No process containing &#39;service.jar&#39; found.&quot;else    # Kill the process    kill $PID    echo &quot;Process containing &#39;service.jar&#39; has been killed.&quot;finohup java -jar service.jar &gt; nohup.log 2&gt;&amp;1 &amp;echo &quot;Service started...&quot;</code></pre><p>这段脚本会判断当前服务是否正在运行，如果是，停止该进程，然后重新启动该服务，程序产生的日志将会被输出到当前目录的<code>nohup.log</code>文件里。</p><h4 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h4><p>我使用的是阿里云的ECS服务器，阿里云在IDEA提供了一个插件叫做：<u>Alibaba Cloud Toolkit</u>，它可以帮助我们实现一键部署。</p><p>首先在顶栏上找到此插件的图标，点击<code>deploy to ECS</code>：<img src="/post/payment-backends-with-ktor-server/image-3.png" alt="image-3" style="zoom:67%;"></p><p>然后如下进行配置：</p><img src="/post/payment-backends-with-ktor-server/image-4.png" alt="image-4" style="zoom: 50%;"><p>我们将<code>File</code>指定为生成的<code>jar</code>包的路径，然后将<code>Target Directory</code>指定为云服务器上的路径，<code>Command</code>指定为我们之间创建的<code>sh</code>脚本文件的路径。通常情况下，每次<code>shadowJar</code>打包都会生成不同的<code>jar</code>文件名（根据程序的版本号），因此我们每次都要重新填写路径，相当麻烦，可以用以下方法解决，在<code>build.gradlew.kts</code>中添加：</p><pre><code class="kotlin">import com.github.jengelman.gradle.plugins.shadow.tasks.ShadowJartasks.withType&lt;ShadowJar&gt; &#123;    archiveFileName.set(&quot;service.jar&quot;)&#125;</code></pre><p>这样，每次打包生成的文件都将保持不变。点击<code>Run</code>按钮即可一键部署！</p><h3 id="安全组规则"><a href="#安全组规则" class="headerlink" title="安全组规则"></a>安全组规则</h3><p>虽然我们部署了服务，但是你会发现服务器仍然无法处理相应的请求，这是因为云服务器的安全组规则并未放行我们部署的端口，现在去供应商的控制台配置安全组规则，以阿里云为例：</p><img src="/post/payment-backends-with-ktor-server/image-5.png" alt="image-5" style="zoom:67%;"><p>登录后，在控制台主页左栏找到<code>安全组</code>选项，找到云服务器实例，点击进入，按如下方式或者你的需求配置（注意端口范围和授权对象）：</p><p><img src="/post/payment-backends-with-ktor-server/image-6.png" alt="image-6"></p><p>配置完成后，如果不出意外，服务器就能正常响应请求了！</p><h2 id="Android客户端"><a href="#Android客户端" class="headerlink" title="Android客户端"></a>Android客户端</h2><blockquote><p>我们需要客户端处理收款并上报收款信息</p></blockquote><h3 id="监听系统通知"><a href="#监听系统通知" class="headerlink" title="监听系统通知"></a>监听系统通知</h3><p>Android系统很贴心地为我们提供了这样一个服务叫做 <code>NotificationListenerService</code>，顾名思义，就是监听系统通知的服务类。</p><p>使用它，我们变可以实时地获取到支付宝的收款通知，并提取出其中的金额。</p><p>首先定义一个服务继承自</p><pre><code class="kotlin">class NotificationMonitorService : NotificationListenerService() &#123;     companion object &#123;        val COMPONENT_NAME = ComponentName(app, NotificationMonitorService::class.java)         // 判断我们是否拥有了监听系统通知的权限        fun isPermissionGranted(): Boolean &#123;            val packageNames: Set&lt;String&gt; =                NotificationManagerCompat.getEnabledListenerPackages(app)            return packageNames.contains(BuildConfig.APPLICATION_ID)        &#125;         // 强制重新启动服务        fun toggleService() &#123;            val pm: PackageManager = app.packageManager            pm.setComponentEnabledSetting(                COMPONENT_NAME,                PackageManager.COMPONENT_ENABLED_STATE_DISABLED, PackageManager.DONT_KILL_APP            )            pm.setComponentEnabledSetting(                COMPONENT_NAME,                PackageManager.COMPONENT_ENABLED_STATE_ENABLED, PackageManager.DONT_KILL_APP            )        &#125;    &#125;&#125;</code></pre><p>然后在清单文件中声明：</p><pre><code class="xml">&lt;service    android:name=&quot;.NotificationMonitorService&quot;    android:exported=&quot;true&quot;    android:label=&quot;@string/app_name&quot;    android:permission=&quot;android.permission.BIND_NOTIFICATION_LISTENER_SERVICE&quot;&gt;    &lt;intent-filter&gt;        &lt;action android:name=&quot;android.service.notification.NotificationListenerService&quot; /&gt;    &lt;/intent-filter&gt;&lt;/service&gt;</code></pre><p>这个服务当然不是任何应用都能随便启动的，它需要一个特殊的权限<code>android.permission.BIND_NOTIFICATION_LISTENER_SERVICE</code>，当APP启动时，我们直接请求用户授予此权限，因为用户也就我们自己了，这段逻辑不用太过复杂。</p><pre><code class="kotlin">override fun onCreate(savedInstanceState: Bundle?) &#123;    if(!NotificationMonitorService.isPermissionGranted())&#123;        registerForActivityResult(ActivityResultContracts.StartActivityForResult()) &#123;            if (NotificationMonitorService.isPermissionGranted()) &#123;                    toast(R.string.permission_granted)                    NotificationMonitorService.toggleService()                &#125;            &#125; else &#123;                toast(R.string.permission_denied)            &#125;            &#125;.launch(                Intent(Settings.ACTION_NOTIFICATION_LISTENER_SETTINGS).putExtra(                Settings.EXTRA_NOTIFICATION_LISTENER_COMPONENT_NAME,                NotificationMonitorService.COMPONENT_NAME       )        )    &#125;&#125;</code></pre><p>当用户授权后，我们的服务将会被系统自动拉起，在<code>NotificationMonitorService</code>的<code>onCreate</code>方法中，我们将该服务提升为前台服务，这样可以在通知栏显示一个通知并保活：</p><pre><code class="kotlin">override fun onCreate() &#123;    val channel = NotificationChannelCompat.Builder(        CHANNEL_ID_FOREGROUND, NotificationManagerCompat.IMPORTANCE_DEFAULT    ).setName(applicationInfo.labelRes.str).setShowBadge(false).build()    notificationManager.createNotificationChannel(channel)    startForeground(FOREGROUND_SERVICE_ID, buildForegroundNotification(State.IDLE)) &#125;</code></pre><blockquote><p>很有趣的是，其实Android系统会自动保活这个服务，并且会自动在开机时自动启动这个服务，可见这是Android系统开发人员是考虑到了类似于我们这样的需求而适配的特殊策略。</p></blockquote><p>当通知服务成功连接时，系统会调用<code>onListenerConnected</code>方法，我们在这里获取唤醒锁保证设备不会在熄屏时休眠CPU：</p><pre><code class="kotlin">override fun onListenerConnected() &#123;    super.onListenerConnected()    wakeLock = powerManager.newWakeLock(        PowerManager.PARTIAL_WAKE_LOCK, &quot;NotificationMonitorService:Lock&quot;    )    wakeLock.acquire()&#125;</code></pre><p>相应地，在通知服务断开时，释放唤醒锁，如果是意外停止（通过我们自定义的<code>willQuit</code>标志来判断），则尝试重新绑定服务：</p><pre><code class="kotlin">override fun onListenerDisconnected() &#123;    super.onListenerDisconnected()    if (willQuit) &#123;        stopForeground(STOP_FOREGROUND_REMOVE)        serviceState.removeObserver(stateObserver)        releaseWakeLockIfNeeded()    &#125; else &#123;        requestRebind(ComponentName(app, NotificationMonitorService::class.java))    &#125;&#125;</code></pre><h3 id="处理通知"><a href="#处理通知" class="headerlink" title="处理通知"></a>处理通知</h3><p>最重要的部分在于处理通知，当系统收到通知时，会回调<code>onNotificationPosted</code>方法：</p><pre><code class="kotlin">override fun onNotificationPosted(sbn: StatusBarNotification?) &#123;     super.onNotificationPosted(sbn)     sbn?.let &#123; notification -&gt;         debugLogcat(&quot;Notification received: $sbn&quot;)         if (notification.packageName == victimPackageName) &#123;             val extras: Bundle = notification.notification?.extras ?: return             val title = extras.getString(Notification.EXTRA_TITLE, &quot;&quot;)             logcat(title)             val content = extras.getString(Notification.EXTRA_TEXT, &quot;&quot;)             logcat(content)             if (receivedNotificationIds.contains(notification.id)) &#123;                 logcat(&quot;Duplicated notification post event received, distinct!&quot;)                 return             &#125;             if (title != &quot;支付宝收款&quot;) return             val ret = content.firstGroupValue(&quot;支付宝到账(.+?)元&quot;)             if (ret != null) &#123;                 receivedNotificationIds.add(notification.id)                 callbacks.forEach &#123;                     it.onPaymentReceived(ret)                 &#125;                 if (previousKey != null) &#123;                     cancelNotification(previousKey)                 &#125;                 previousKey = notification.key             &#125; else &#123;                 logcat(&quot;Unmatched notification: title = $title&quot;)             &#125;         &#125;     &#125;&#125;</code></pre><p>在这个方法中，我们使用正则表达式匹配并捕获收款的金额。需要注意的是，系统可能会对同一个通知多次进行回调，我们需要通过通知的<code>id</code>字段来判断此通知是否已经被处理过。在提取到金额之后，我们便可以将金额上报给服务器，服务器通过金额查询到订单，然后将该订单标记为已支付。同时，在用户侧，可以通过手动查询或者轮询来更新订单状态。</p><h2 id="业务逻辑总结"><a href="#业务逻辑总结" class="headerlink" title="业务逻辑总结"></a>业务逻辑总结</h2><p>以上便是一个简化版的免签收款系统：用户在产品客户端内点击创建订单——&gt;向我们的服务端发送一个创建订单的请求——&gt;服务端获取折扣金额并创建订单返回给客户端——&gt;产品客户端根据订单的支付链接拉起支付宝进行付款——&gt;用户付款——&gt;收款客户端会收到来自支付宝的通知——&gt;收款客户端提取收款金额并上报给服务端——&gt;服务端将订单标记为已支付——&gt;用户刷新订单状态——&gt;完成支付。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>得益于Kotlin生态的茁壮发展，我们不用切换到其他语言即可完成服务端和客户端的开发，这是一件幸事。还有需要注意的是，以上代码只是这个系统的高度简化版，无论是服务端还是客户端，都还需要更多的业务逻辑以满足不同的需求。</p><p>有任何问题请在下方评论，谢谢！</p>]]></content>
      
      
      <categories>
          
          <category> Android Dev </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>How to Implement Inter-Process Database Communication Rid of ContentProvider?</title>
      <link href="//post/DatabaseIPC/"/>
      <url>//post/DatabaseIPC/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="How-to-implement-inter-process-database-communication-rid-of-ContentProvider"><a href="#How-to-implement-inter-process-database-communication-rid-of-ContentProvider" class="headerlink" title="How to implement inter-process database communication rid of ContentProvider?"></a>How to implement inter-process database communication rid of ContentProvider?</h1><blockquote><p>Most of us Android developers will never have an encounter with such a requirement like database IPC, because the Android framework has already provided an approach called <code>ContentProvider</code>. But do you know how it works and what if your server process is not even a standard Android application? That’s what we are going to talk about.</p></blockquote><h2 id="Begin-with-ContentProvider"><a href="#Begin-with-ContentProvider" class="headerlink" title="Begin with ContentProvider"></a>Begin with ContentProvider</h2><p>ContentProvider gives Android the capability of providing a variety of content between applications in a encapsulated and controlled way. This mechanism is so widely used from reading contacts from the phonebook to picking an image from the gallery. As a developer, if you’ve ever used a ContentProvider, you must have noticed that the ContentProvider framework provides a set of APIs, which are similar to the structural query language, although this does not mean that the provider must store its data in a relational database. You can refer to <a href="https://developer.android.com/guide/topics/providers/content-providers">this page</a> to learn basics about ContentProvider. </p><p>There are many types of data but in conclusion, two types: structured data and binary file data. For files, the data is queried by <code>ContentResolver.open*()</code> , where the caller can retrieve the stream or the file descriptor, so its IPC mechanism is <code>FileDescriptor</code> exposing. As for structural data, in most cases, they are stored in a relational database like SQLite database. They can be queried by <code>ContentResolver.query()</code>, which returns a <code>Cursor</code> just like querying a local database.  It’s obvious that the cursor is the key of database IPC. Now what we want to know is how to transact a cursor inter-process.</p><h2 id="How-to-transact-a-Cursor-inter-process"><a href="#How-to-transact-a-Cursor-inter-process" class="headerlink" title="How to transact a Cursor inter-process?"></a>How to transact a Cursor inter-process?</h2><blockquote><p>What will you do if you are the designer of ContentProvider?</p></blockquote><h3 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h3><blockquote><p>To help your further reading, we need to clarify two nouns.</p></blockquote><ul><li><p><strong>The caller process</strong></p><p>The process who requires content.</p></li><li><p><strong>The callee process</strong></p><p>The process who provides content.</p></li></ul><h3 id="The-quite-straight-forward-idea"><a href="#The-quite-straight-forward-idea" class="headerlink" title="# The quite straight-forward idea"></a># The quite straight-forward idea</h3><p>The class <code>Cursor</code> is just an interface defining a cursor’s behaviors and we don’t need to care about what is exactly running underneath. Upholding this concept, we may come up with a straight-forward idea, that is AIDL. We can simply define an AIDL mimicking the <code>Cursor</code> interface:</p><p> <strong>Note</strong>: To abridge the article, we will just pick several interfaces for the illustration:</p><pre><code class="java">// IRemoteCursor.aidlinterface IRemoteCursor &#123;    int getCount();    boolean moveToNext();    // ...and so on    void close();&#125;</code></pre><p>After a successful build, we can define a class called <code>RemoteCursor</code> inheriting from <code>Cursor</code> . It delegates the remote calls in the caller process.</p><pre><code class="kotlin">// RemoteCursor.ktprivate class RemoteCursor(private val binder:IRemoteCursor): Cursor&#123;    override fun getCount(): Int &#123;        return binder.count    &#125;    override fun moveToNext(): Boolean &#123;        return binder.moveToNext()    &#125;        // ...and so on        override fun close() &#123;        binder.close()    &#125;&#125;/** * Reconstruct the cursor. */fun IBinder.asCursor(): Cursor &#123;    return RemoteCursor(RemoteCursor.Stub.asInterface(this))&#125;</code></pre><p>And also we need to do real work in the callee process.</p><pre><code class="kotlin">// RemoteCursorImpl.ktprivate class RemoteCursorImpl(private val cursor:Cursor): IRemoteCursor.Stub() &#123;        override fun getCount(): Int &#123;        return cursor.count    &#125;    override fun moveToNext(): Boolean &#123;        return cursor.moveToNext()    &#125;        // ...and so on        override fun close() &#123;        cursor.close()    &#125;&#125;/** * Deconstruct the cursor. */fun Cursor.asBinder(): IRemoteCursor &#123;    return RemoteCursorImpl(this)&#125;</code></pre><p>Everything is done now. If we want to do a remote database query, we can just build a <code>RemoteCursorImpl</code> from a normal cursor in the callee process and transact it as a binder to the caller process, where we can reconstruct the cursor as <code>RemoteCursor</code> from the binder. </p><h4 id="The-hidden-performance-issue"><a href="#The-hidden-performance-issue" class="headerlink" title="The hidden performance issue"></a>The hidden performance issue</h4><p>Everything seems just perfect and working as expected, but there is a hidden performance issue. If the table we were querying contains a large number of records and you would like to read it all, the performance issue would be very significant, because there were too many IPC calls and too many memory copies. </p><p>The following code snippet is a common cursor iteration boilerplate:</p><pre><code class="kotlin">database.query(&quot;SELECT projections FROM table_name&quot;).use &#123;    while (it.moveToNext()) &#123;      val str_field = it.getString(0)      val int_field = it.getInt(1)      // and more    &#125;&#125;</code></pre><p>You can see that whenever we iterate a cursor, the application needs to do approximately as many as <em>row*col</em> times of IPC calls and memory copies. Even though the IPC call and memcpy are fast, but due to the time complexity of a cursor iteration, the more rows and columns you want to query, the more unbearable the performance issue will be,  which could finally lead to a performance disaster. </p><h3 id="How-does-the-Android-framework-do-it"><a href="#How-does-the-Android-framework-do-it" class="headerlink" title="# How does the Android framework do it?"></a># How does the Android framework do it?</h3><p>Let’s dive into the source code. In <a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/content/ContentProviderNative.java;"><code>ContentProviderNative</code></a>, where the actual <code>ContentProvider</code> is implemented,  we will see how they reconstruct the cursor from the callee process:</p><pre><code class="java">// ContentProviderNative.java@Overridepublic Cursor query(@NonNull AttributionSource attributionSource, Uri url,        @Nullable String[] projection, @Nullable Bundle queryArgs,        @Nullable ICancellationSignal cancellationSignal)        throws RemoteException &#123;    BulkCursorToCursorAdaptor adaptor = new BulkCursorToCursorAdaptor();    Parcel data = Parcel.obtain();    Parcel reply = Parcel.obtain();    try &#123;        // ...        mRemote.transact(IContentProvider.QUERY_TRANSACTION, data, reply, 0);        // ...        if (reply.readInt() != 0) &#123;            BulkCursorDescriptor d = BulkCursorDescriptor.CREATOR.createFromParcel(reply);            Binder.copyAllowBlocking(mRemote, (d.cursor != null) ? d.cursor.asBinder() : null);            adaptor.initialize(d);        &#125; else &#123;            adaptor.close();            adaptor = null;        &#125;        return adaptor;    &#125; catch (RemoteException ex) &#123;        adaptor.close();        throw ex;    &#125; catch (RuntimeException ex) &#123;        adaptor.close();        throw ex;    &#125; finally &#123;        data.recycle();        reply.recycle();    &#125;&#125;</code></pre><p>The final cursor returned is an instance of class <code>BulkCursorToCursorAdaptor</code>, which follows the adaptor design pattern. The <code>BulkCursorToCursorAdaptor</code> is initialized from a <code>BulkCursorDescriptor</code>, which is parcelable. So in the callee side, there must be something that converts a cursor into a <code>BulkCursorDescriptor</code> and transact it to the caller side and the caller side reconstructs the cursor with <code>BulkCursorToCursorAdaptor</code>. The idea seems just like what we’ve thought before, but will this implementation fall into a performance issue? Let’s take a look at what <code>BulkCursorToCursorAdaptor.initialize()</code> does:</p><pre><code class="java">// BulkCursorToCursorAdaptor.javapublic void initialize(BulkCursorDescriptor d) &#123;    mBulkCursor = d.cursor;    mColumns = d.columnNames;    mWantsAllOnMoveCalls = d.wantsAllOnMoveCalls;    mCount = d.count;    if (d.window != null) &#123;        setWindow(d.window);    &#125;&#125;</code></pre><p>This method simply assigns fields from <code>BulkCursorDescriptor</code> to it’s member fields, but there is something new called <code>mBulkCursor</code>(an instance of <code>IBulkCursor</code>).  What is it? In <a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/database/IBulkCursor.java;">here</a>, we find that the <code>IBulkCursor</code> is an interface defining something similar to a cursor but much simpler. The most remarkable method is <code>getWindow()</code>, which returns a <code>CursorWindow</code>, while the <code>CursorWindow</code> is parcelable. Then everything seems to be clear. The essence of a cursor is its <code>CursorWindow</code>. We can reconstruct a cursor from a cursor window and some metadata. Now let’s find out how <code>getWindow()</code> is implemented. There is another adaptor called <code>CursorToBulkCursorAdaptor</code>, which yields a <code>BulkCursorDescriptor</code> from a normal cursor and is the real implementation of <code>IBulkCursor</code>:</p><pre><code class="java">// CursorToBulkCursorAdaptor.java@Overridepublic CursorWindow getWindow(int position) &#123;    synchronized (mLock) &#123;        throwIfCursorIsClosed();        if (!mCursor.moveToPosition(position)) &#123;            closeFilledWindowLocked();            return null;        &#125;        CursorWindow window = mCursor.getWindow();        if (window != null) &#123;            closeFilledWindowLocked();        &#125; else &#123;            window = mFilledWindow;            if (window == null) &#123;                mFilledWindow = new CursorWindow(mProviderName);                window = mFilledWindow;            &#125; else if (position &lt; window.getStartPosition()                    || position &gt;= window.getStartPosition() + window.getNumRows()) &#123;                window.clear();            &#125;            mCursor.fillWindow(position, window);        &#125;        if (window != null) &#123;            // Acquire a reference to the window because its reference count will be            // decremented when it is returned as part of the binder call reply parcel.            window.acquireReference();        &#125;        return window;    &#125;&#125;</code></pre><p>We can see that the cursor window is lazily filled via <code>mCursor.fillWindow(position, window)</code> as needed.  You might wonder what is a cursor window? As the documentation explained, a cursor window is</p><blockquote><p>A buffer containing multiple cursor rows.</p></blockquote><p>So once a cursor window is filled, the caller does not need to invoke IPC calls and do memory copies for each column and each row, which largely cuts down the time consumption and consequently gets freed from the performance issue. </p><h2 id="Get-rid-of-ContentProvider"><a href="#Get-rid-of-ContentProvider" class="headerlink" title="Get rid of ContentProvider"></a>Get rid of ContentProvider</h2><blockquote><p>Now that we’ve known the principle of cursor IPC, we can work on the database IPC without ContentProvider. We just need to mimics the Android framework. The following code snippets use SQLite database as an example.</p></blockquote><h3 id="Be-careful-of-hidden-APIs"><a href="#Be-careful-of-hidden-APIs" class="headerlink" title="Be careful of hidden APIs!"></a>Be careful of hidden APIs!</h3><p>You might think that we can just use those APIs like <code>IBulkCursor</code>  in the Android framework by reflection or linking. Yes, this may work but do rememeber that those are hidden apis and are not designed to be used by third-party apps, which are expected to be run on various devices. Even if you could bypass the hidden api restrictions above Android P, their implementations may vary on different Android releases or even on different ROMs. You’d better write the codes in your project.</p><h3 id="RemoteSQLiteDatabase"><a href="#RemoteSQLiteDatabase" class="headerlink" title="RemoteSQLiteDatabase"></a>RemoteSQLiteDatabase</h3><p>Firstly, we need to abstract a remote sqlite database representing a sqlite database in the callee process to be used in caller process. Thanks to <code>androidx.sqlite</code>, they provide a fine abstraction of a sqlite database called <code>SupportSQLiteDatabase</code>. Now we just need to copy its interfaces into an AIDL file. There are a lot of interfaces, you can just count those necessary in. In our illustration, we will only show several interfaces.</p><pre><code class="java">// IRemoteSQLiteDatabase.aidlinterface IRemoteSQLiteDatabase &#123;    void beginTransaction();    void endTransaction();    BulkCursorDescriptor query(String query,in String[] bindArgs);    // ...and so on    void close();&#125;</code></pre><p>You might have noticed that we return a <code>BulkCursorDecriptor</code> in <code>query</code> method, because the <code>BulkCursorDecriptor</code> is parcelable and contains all we need to rebuild a cursor. Don’t forget to import it. </p><pre><code class="java">// BulkCursorDescriptor.javapublic final class BulkCursorDescriptor implements Parcelable &#123;    public IBulkCursor cursor;    public String[] columnNames;    public boolean wantsAllOnMoveCalls;    public int count;    public CursorWindow window;&#125;</code></pre><p>Now what we need is <code>IBulkCursor</code>, we can define it in AIDL as well. </p><pre><code class="java">// IBulkCursor.aidlinterface IBulkCursor &#123;    /**     * Gets a cursor window that contains the specified position.     * The window will contain a range of rows around the specified position.     */    CursorWindow getWindow(int position);    /**     * Notifies the cursor that the position has changed.     * Only called when &#123;@link #getWantsAllOnMoveCalls()&#125; returns true.     *     * @param position The new position     */    void onMove(int position);    void close();&#125;</code></pre><p>And there are <code>CursorToBulkCursorAdaptor</code> and <code>BulkCursorToCursorAdaptor</code>. I will no longer paste them here because I don’t want to make the article too long. They can be simply copied from the Android framework source codes with some small modifications. Now let’s combine these all.</p><pre><code class="kotlin">// RemoteSQLiteDatabase.ktprivate class RemoteSQLiteDatabase(private val binder: IRemoteSQLiteDatabase) : SupportSQLiteDatabase &#123;            override fun beginTransaction() &#123;        binder.beginTransaction()    &#125;                   override fun endTransaction() &#123;        binder.endTransaction()    &#125;           @Suppress(&quot;UNCHECKED_CAST&quot;)    override fun query(query: String, bindArgs: Array&lt;out Any&gt;?): Cursor &#123;        val descriptor = binder.query(query, bindArgs as? Array&lt;out String&gt;)        return BulkCursorToCursorAdaptor().apply &#123;            initialize(descriptor)        &#125;    &#125;            // ...and so on       override fun close() &#123;        binder.close()    &#125; &#125;fun IBinder.asSupportSQLiteDatabase(): SupportSQLiteDatabase &#123;    return RemoteSQLiteDatabase(IRemoteSQLiteDatabase.Stub.asInterface(this))&#125;</code></pre><p>In the query method body, we receive a <code>BulkCursorDescriptor</code> from the callee process and wrap it into a <code>BulkCursorToCursorAdaptor</code>, which can be used as a normal cursor by the caller process. Now let’s do the real query in the callee process.</p><pre><code class="kotlin">// RemoteSQLiteDatabaseImpl.ktprivate class RemoteSQLiteDatabaseImpl(val database: SupportSQLiteDatabase) : IRemoteSQLiteDatabase.Stub() &#123;    override fun beginTransaction() &#123;        database.beginTransaction()    &#125;        override fun endTransaction() &#123;        database.endTransaction()    &#125;        override fun query(query: String, args: Array&lt;out String&gt;?): BulkCursorDescriptor &#123;        try &#123;            val cursor = database.query(query, args)            return CursorToBulkCursorAdaptor(cursor, &quot;name.for.cursor.window&quot;).bulkCursorDescriptor        &#125; catch (e: Exception) &#123;            // rethrow as IllegalStateException, which is supported by binder IPC.            error(e)        &#125;    &#125;        // ...and so on        override fun close() &#123;        database.close()    &#125;&#125;fun SupportSQLiteDatabase.asBinder(): IRemoteSQLiteDatabase &#123;     return RemoteSQLiteDatabaseImpl(this)&#125;</code></pre><p>Now what? How do we open an remote database from the caller process? Try to do it yourself.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Now we can connect to a database that is opened in another process without ContentProvider. Those guys who love magic may need this one day.</p>]]></content>
      
      
      <categories>
          
          <category> Android Dev </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Hexo Material主题个性化改造</title>
      <link href="//post/RetroMaterialTheme/"/>
      <url>//post/RetroMaterialTheme/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="Hexo-Material主题改造-Intro-to-Retro-Material"><a href="#Hexo-Material主题改造-Intro-to-Retro-Material" class="headerlink" title="Hexo Material主题改造 | Intro to Retro Material"></a>Hexo Material主题改造 | Intro to <em>Retro Material</em></h1><h2 id="提要"><a href="#提要" class="headerlink" title="提要"></a>提要</h2><blockquote><p><strong>Material</strong>主题已经若干年没有维护了，虽然还能用，但是<strong>Material 1</strong> 的设计现在看来已然过时。奈何翻了一圈主题商店，都没有找到心仪的主题，反而觉得还是<strong>Material</strong>越看越顺眼。为了跟上时代潮流，我决定亲手改造这个主题。可是，我根本没有任何前端知识，一切从零开始。不过幸运的是，在我的朋友 <strong>@Haleclipse</strong> 的帮助下，我较快地上手了<strong>CSS</strong>，并且完成了第一轮改造。</p></blockquote><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>将较老式的<strong>Material 1</strong>主题改成<strong>MD2</strong>或<strong>MDU</strong>样式，并且尽可能减少对原有代码的入侵，尽可能不引入第三方样式库。这个新的主题，我美其名曰 🙌 <em><strong>Retro Material</strong></em></p><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="/post/RetroMaterialTheme/preview1.webp" alt="img"></p><img src="/post/RetroMaterialTheme/preview2.webp" alt="img"><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>代码较长，暂不贴出。您可在<a href="/css/xjunz-mod.css">这里</a>查看或下载<em><strong>Retro Material</strong></em>主题<strong>CSS</strong> 补丁。</p><p><strong>使用协议</strong>：如果您使用了此补丁，请在博客内第三人可见处注明本文链接，否则将被视为侵权行为。</p>]]></content>
      
      
      <categories>
          
          <category> 杂谈 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Android 10 及以上，(Shared Element) Return Transition在特定情况下失效的问题探究</title>
      <link href="//post/Android-Return-Transition-Patcher/"/>
      <url>//post/Android-Return-Transition-Patcher/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="Android-10-及以上，-Shared-Element-Return-Transition在特定情况下失效的问题探究"><a href="#Android-10-及以上，-Shared-Element-Return-Transition在特定情况下失效的问题探究" class="headerlink" title="Android 10 及以上，(Shared Element) Return Transition在特定情况下失效的问题探究"></a>Android 10 及以上，(Shared Element) Return Transition在特定情况下失效的问题探究</h1><blockquote><p>文章可能存在错误或疏漏，欢迎批评斧正…</p></blockquote><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p><strong>复现方式</strong>：<strong>Activity A</strong>通过<code>(Shared Element) Enter Transition</code> 进入<strong>Activity B</strong>, 在<strong>Actitivty B</strong> 内进入另一个<strong>Activity</strong>（APP内或其他APP都行），然后回到<strong>Activity B</strong>，点击返回键</p><p><strong>预期结果</strong>：<strong>Activity B</strong> 会通过<code>(Shared Element) Return Trasition</code> 回到<strong>Activity A</strong></p><p><strong>实际结果</strong>：完全没有执行任何<code>Transition</code>动画，直接回到了<strong>Activity A</strong></p><p><strong>影响范围</strong>：<strong>Android 10</strong>及以上版本，并且到目前（<em>2022-3-26</em>）都没有修复</p><h2 id="切入"><a href="#切入" class="headerlink" title="切入"></a>切入</h2><p>其实很久以前就发现了这个问题，但是一直没有实际去解决，因为这个BUG的影响并不是很大。在搜索引擎上，国内外许多人也遇到了相同的问题，可是看起来大家都很忙，并没有人提供一个特别好的解决方案。不巧我今天正好又遇到了，而且有点闲暇时间，便决定去一探究竟。</p><p>切入点很好找，当我们点击返回键时，就会走<code>finishAfterTransition</code>以执行<code>Transition</code>动画，那么就从这里入手：</p><p><img src="/post/Android-Return-Transition-Patcher/image-20220327022215849.png" alt="image-20220327022215849"></p><p>很明显在异常情况下<code>startExitBackTransition()</code>返回了<code>false</code>。点这个方法，进入到<code>android.app.ActivityTransitionState</code>类中（<strong>注</strong>：以下所有图片中的代码若未说明都来自这个类）：</p><p><img src="/post/Android-Return-Transition-Patcher/image-20220327022518986.png" alt="image-20220327022518986">通过断点调试发现正常情况和异常情况的区别在于<code>getPendingExitNames()</code>是否为<code>null</code>：如果它为<code>null</code>，该方法就会返回<code>false</code>，那么<code>Transition</code>就不会执行。这个方法里的逻辑很简单，就是懒加载并返回了<code>mPendingExitNames</code>这个成员变量：</p><p><img src="/post/Android-Return-Transition-Patcher/image-20220327022714802.png" alt="image-20220327022714802"></p><p>还是通过断点发现，正常和异常情况的区别在于<code>mEnterTransitionCoordinator</code>是否为<code>null</code>，异常情况下这个变量为<code>null</code>，导致<code>mPendingExitNames</code>无法初始化，从而返回<code>null</code>。那么我们的思路就是找到何时<code>mEnterTransitionCoordinator</code>被置空。代码里有多处置空的地方，但是鉴于异常情况只有在<code>Activity</code>切换出去以后才会发生。那么，最可疑的地方莫过于<code>onStop</code>方法里面的置空处理：</p><p><img src="/post/Android-Return-Transition-Patcher/image-20220327022929123.png" alt="image-20220327022929123">验证之后，问题就明了了：正常情况下，<code>getPendingExitNames</code>会初始化<code>mPendingExitNames</code>。但是异常情况下，由于走了<code>onStop</code>，<code>mEnterTransitionCoordinator</code>被置空，导致<code>mPendingExitNames</code>始终无法初始化最终导致了这个BUG。</p><h2 id="安卓10之前？"><a href="#安卓10之前？" class="headerlink" title="安卓10之前？"></a>安卓10之前？</h2><p>但是为什么在安卓10之前没有这个问题呢？翻阅源码的修改记录，我发现了一条可疑的commit: <a href="https://cs.android.com/android/_/android/platform/frameworks/base/+/d85bed510fd1aad7f5d764b9fb6ddfea3e5bb56e">d85bed5</a> 。我们看一下此commit对<a href="https://cs.android.com/android/_/android/platform/frameworks/base/+/d85bed510fd1aad7f5d764b9fb6ddfea3e5bb56e:core/java/android/app/ActivityTransitionState.java;dlc=67f94b40024e07e64fd2875b7382b762805bebae"><code>android.app.ActivityTransitionState</code></a>这个类的修改：</p><p><img src="/post/Android-Return-Transition-Patcher/image-20220327024045779.png" alt="image-20220327024045779"></p><p>这个提交对这个类的修改在逻辑上的改动不大，主要修改就是成员<code>mEnteringNames</code>在语义上改为<code>mPendingExitNames</code>，本质上还是储存进入退出的共享元素的<code>Transition Names</code>的列表。关键在于，他将<code>mPendingExitNames</code>的获取方式变成了<code>getPendingExitNames()</code>方法来懒加载。而在安卓9的源码中，<code>mEnteringNames</code>会在<code>startEnter</code>方法中就被初始化，并且只会在<code>clear</code>方法中清空，那么此变量在整个<code>Acitivity Transition</code>的生命周期中始终是可用的，所以安卓10以前没有这个问题。</p><p>但是我们不禁疑问，谷歌程序员真的会犯这样的错误吗？继续看上面代码的第<strong>154</strong>行的<code>saveState</code>方法，这个方法会在<code>Acitivty.onSaveInstance()</code>中调用。因为<code>onSaveInstance</code>会在<code>onStop</code>之前调用，那么实际上<code>onStop</code>之前<code>mPendingExitNames</code>就会被初始化，所以…理论上…Android 10上的代码也是没有问题的，🤔怎么会是呢？</p><p>通过断点发现，实际上<code>onSaveInstance</code>在<code>onStop</code>之后调用了，所以<code>mPendingExitNames</code>保存了个寂寞。查阅文档才知道，原来<code>onSaveInstance</code>在安卓9有行为变更：</p><p><img src="/post/Android-Return-Transition-Patcher/image-20220327160844844.png" alt="image-20220327160844844"></p><p>显然，那位代码贡献者并没有考虑到这一变更，所以这才是罪魁祸首~</p><h2 id="补丁代码"><a href="#补丁代码" class="headerlink" title="补丁代码"></a>补丁代码</h2><h3 id="反射式"><a href="#反射式" class="headerlink" title="反射式"></a>反射式</h3><p>既然已经知道了问题所在，那么解决方法便呼之欲出了。解决方法很简单，在<code>onStop</code>前，我们调用至少一次<code>saveState</code>对<code>mPendingExitNames</code>进行初始化，这个方法是无副作用的，我们可以放心调用。但是<code>onStop</code>之前有很多时机，我们要确保<code>mEnterTransitionCoordinator</code>已经初始化。搜索发现，<code>mEnterTransitionCoordinator</code>初始化的地方在<code>enterReady(Activity)</code>中，而这个方法在<code>Activity.onStart()</code>中调用的，那么我们在<code>Activity</code>的<code>onStart</code>和<code>onStop</code>之间打补丁就行了：</p><ul><li><strong>注</strong>：这个<code>Acitivty</code>指的是复现方式中的<strong>Acitivty B</strong>；<code>saveState</code>不在反射黑名单，我们可以反射调用。</li></ul><pre><code class="kotlin">@SuppressLint(&quot;DiscouragedPrivateApi&quot;)fun patchActivity(activity: Activity) &#123;    if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.Q) return    try &#123;        val field = Activity::class.java.getDeclaredField(&quot;mActivityTransitionState&quot;).run &#123;            isAccessible = true            get(activity)        &#125;        field.javaClass.getDeclaredMethod(&quot;saveState&quot;, Bundle::class.java).run &#123;            invoke(field, Bundle())        &#125;    &#125; catch (t: Throwable) &#123;        Log.e(&quot;ReturnTransitionPatcher&quot;, &quot;Patch failed for [$&#123;activity.javaClass.simpleName&#125;]&quot;)        t.printStackTrace()    &#125;&#125;</code></pre><h3 id="非反射式"><a href="#非反射式" class="headerlink" title="非反射式"></a>非反射式</h3><p>反射的代码总让人感觉嘎吱作响，需要很小心地维护，那么我们能否找到不需要反射的解决方法呢？我们之前分析过了，<code>saveState</code>在<code>Activity.onSaveInstance</code>中调用，那么我们手动在<code>onStop</code>之前<code>onStart</code>之后手动调用<code>onSaveInstance</code>也能修复这个问题，这个方法不用反射调用，稳健性较好：</p><pre><code class="kotlin">fun patchActivity(activity: Activity) &#123;    if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.Q) return    Instrumentation().callActivityOnSaveInstanceState(activity, Bundle())&#125;</code></pre><h2 id="Android-12-PE上奇怪的现象"><a href="#Android-12-PE上奇怪的现象" class="headerlink" title="Android 12 PE上奇怪的现象"></a>Android 12 PE上奇怪的现象</h2><p>在Android 11及以前，将APP退回出到最近任务，也会走<code>onStop</code>触发这个BUG。但是在我的Pixel 5的Android 12上，退出到最近任务，并不会触发这个BUG。调试发现，是因为没走<code>onStop</code>。原来PE 的Launcher对于刚刚退回到最近任务的APP，不再是显示其静态快照，而是将APP缩放，因此在最近任务页面仍然能看到该APP的UI更新。谷歌你做得好啊，做得好啊。</p><h2 id="使用ReturnTransitionPatcher"><a href="#使用ReturnTransitionPatcher" class="headerlink" title="使用ReturnTransitionPatcher"></a>使用<em>ReturnTransitionPatcher</em></h2><p>代码已经上传到<a href="https://github.com/xjunz/ReturnTransitionPatcher">github</a>和Maven仓库，如果你想在项目中修复这个问题，可以在项目中引入，该库提供了完美的Patch时机和全局Patch功能:</p><pre><code class="groovy">implementation &#39;io.github.xjunz:return-transition-patcher:+&#39;</code></pre>]]></content>
      
      
      <categories>
          
          <category> Android Dev </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>真的有这么丝滑吗？MotionLayout + ViewDragHelper绝赞组合!</title>
      <link href="//post/MotionLayout+ViewDragHelper/"/>
      <url>//post/MotionLayout+ViewDragHelper/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="MotionLayout-ViewDragHelper-绝赞组合"><a href="#MotionLayout-ViewDragHelper-绝赞组合" class="headerlink" title="MotionLayout + ViewDragHelper 绝赞组合!"></a>MotionLayout + ViewDragHelper 绝赞组合!</h1><blockquote><p>内容可能存在错误或疏漏，欢迎批评斧正…</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前各大视频、音乐播放器都有小窗（折叠）和全屏（展开）模式。但是对我而言，一直没找到任何一个产品能完美地通过用户交互在这两个模式之间优雅地过渡，唯一差强人意的是YouTube移动客户端。但是它对用户手指松开后的动画处理仍然不够自然。所以我思考着能不能自己实现一个。</p><h2 id="效果预览"><a href="#效果预览" class="headerlink" title="效果预览"></a>效果预览</h2><div align="center"> <img src="/post/MotionLayout+ViewDragHelper/preview.gif"> </div><hr><p>上面时我实现后的成品，展示了一个可根据用户拖动而在小窗和全屏之间过渡的音乐播放器。可以看到，无论是交互还是动画，都非常自然，也没有过度设计导致的低效。</p><h2 id="需求实现分析"><a href="#需求实现分析" class="headerlink" title="需求实现分析"></a>需求实现分析</h2><p>对于这样的需求，我首先想到的就是使用<code>ViewDragHelper</code>，因为它可以自然地处理手势拖拽。然后根据拖拽的比例设置控件的属性从而实现动画效果。但是这个界面上控件如此之多，其位置、大小、透明度、颜色、可见性乃至圆角大小都在变化，且不考虑工作量问题，就算实现了可维护性也非常糟糕。如果中途需求更改，某处要添加、移除一个控件，或者更换某个控件的动画效果，都是会牵一发而动全身的。这就是我们为什么要引入<code>MotionLayout</code>，因为它可以声明式地实现两个布局之间的过渡动画。其实，<code>MotionLayout</code>本身也可以通过<code>&lt;OnSwipe/&gt;</code>标签实现手势拖拽，但是效果真的差强人意，因为它无法实现像<code>ViewDragHelper</code>一样，当手指松开后，自然地过渡到结束状态。只有<code>linear</code>、<code>accelerate</code>、<code>decelerate</code>三种插值选项。所以我们还是使用<code>ViewDragHelper</code>处理手势。</p><h2 id="MotionLayout简介"><a href="#MotionLayout简介" class="headerlink" title="MotionLayout简介"></a>MotionLayout简介</h2><blockquote><p><strong>MotionLayout</strong> is intended to move, resize, and animate UI elements with which <strong>users interact</strong>, such as buttons and title bars. Motion in your app should <strong>not</strong> be simply a gratuitous special effect in your application. It should be used to help users understand what your application is doing. </p></blockquote><p><code>MotionLayout</code>是谷歌 I&#x2F;O 2018引入<strong>Material Design 2</strong>后不久推出的旨在实现丝滑交互动画的布局组件。官方设计指南特别强调，<code>MotionLayout</code>的存在不是为了简单的动画特效，而是为了处理与<strong>User Interact</strong>相关的UI过渡。它对动画的实现完全是声明式的，即你只需要声明动画的开始、结束状态、关键帧等，而不需要考虑动画的具体实现。它还内置各种效果超赞的<code>PathMotion</code>和插值器，Android Studio还提供可视化编辑器的支持<del>（实际体验并不是很友好）</del>。那么，这么强大的东西学习成本是不是很高？这里打个预防针，要实现我们的需求，并不需要对<code>MotionLayout</code>有深入的了解，掌握一些基础用法就足够了。</p><h2 id="ViewDragHelper简介"><a href="#ViewDragHelper简介" class="headerlink" title="ViewDragHelper简介"></a>ViewDragHelper简介</h2><p><code>ViewDragHelper</code>年代可就久远了，早在支持库年代就有了，大约可以追溯到2015年，MD一代推出之后。它的作用就如它的名字一样，帮助实现控件拖拽，网上的教程也是多如牛毛。我们会在下面的代码中介绍如何使用这玩意儿，使用起来也并不复杂。</p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>首先在你的项目中引入：</p><pre><code class="groovy">// 内置ViewDragHelperimplementation &#39;androidx.appcompat:appcompat:1.2.0&#39;// 须2.0+版本，内置MotionLayoutimplementation &#39;com.android.support.constraint:constraint-layout:2.0.4&#39;</code></pre><h2 id="配置MotionLayout布局"><a href="#配置MotionLayout布局" class="headerlink" title="配置MotionLayout布局"></a>配置MotionLayout布局</h2><p>首先，我们新建一个布局文件，命名为<code>fragment_player.xml</code>。为了解耦，我们使用<code>Fragment</code>，将播放器界面与主界面分开。打开此布局文件，可以看到默认根布局是<code>ConstranitLayout</code>，我们进入design模式，选中我们的根布局后单击鼠标右键。可以看到，有一个选项：<strong>Convert to MotionLayout</strong>：</p><img src="/post/MotionLayout+ViewDragHelper/image-20210310123457587.png" alt="image-20210310123457587"><p>点击后，可以发现我们布局的根节点变成了<code>MotionLayout</code>，并且自动添加了一个<code>app:layoutDescription</code>属性，该属性指向了一个<code>fragment_player_scene.xml</code>文件。没错，这个文件就是用于声明动画的，点进去：</p><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;MotionScene    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;    xmlns:motion=&quot;http://schemas.android.com/apk/res-auto&quot;&gt;    &lt;Transition        motion:constraintSetEnd=&quot;@+id/end&quot;        motion:constraintSetStart=&quot;@id/start&quot;        motion:duration=&quot;1000&quot;&gt;       &lt;KeyFrameSet&gt;       &lt;/KeyFrameSet&gt;    &lt;/Transition&gt;    &lt;ConstraintSet android:id=&quot;@+id/start&quot;&gt;    &lt;/ConstraintSet&gt;    &lt;ConstraintSet android:id=&quot;@+id/end&quot;&gt;    &lt;/ConstraintSet&gt;&lt;/MotionScene&gt;</code></pre><p>其中<code>Transition</code>节点定义了过渡动画的起始场景、结束场景、关键帧等；<code>ConstraintSet</code>节点则用于存放视图约束条件，这是什么意思呢？往后看。</p><p>接下来，我们试着往<code>MotionLayout</code>中增加一个<code>View</code>，用作播放器的背景。等等，你是不是有疑惑，为什么背景不直接设置<code>android:background</code>属性在<code>MotionLayout</code>上呢？是这样的，因为<code>MotionLayout</code>只支持其<strong>直接子View</strong>进行动画，而<code>MotionLayout</code>本身要求高度为<code>match_parent</code>，我们才能实现全屏的效果。所以既要支持背景动画，又要保证能全屏，我们就需要使用一个<code>View</code>来作为背景。</p><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;!--  ~ Copyright (c) 2021 xjunz. All Rights Reserved.  --&gt;&lt;androidx.constraintlayout.motion.widget.MotionLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;    android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;match_parent&quot;    app:layoutDescription=&quot;@xml/sample_scene&quot;&gt;    &lt;View        android:id=&quot;@+id/player_background&quot;        android:background=&quot;#333&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot; /&gt;&lt;/androidx.constraintlayout.motion.widget.MotionLayout&gt;</code></pre><p>接下来，进入布局编辑器的design模式，可以看到<code>MotionLayout</code>的可视化编辑器，我们试着体验一下。</p><img src="/post/MotionLayout+ViewDragHelper/image-20210310132816444.png" alt="image-20210310132816444" style="zoom:67%;"><p>可以看到，右上有两个分别标着“start”和“end”的矩形页面，这就是我们<code>fragment_player_scene.xml</code>中定义的两个<code>Transition</code>节点的id。下方，可以编辑<code>ConstrantSet</code>。我们先选中”start“页面，再选中下方的<code>player_background</code>，然后点击红色方框中的按钮，选择<img src="/post/MotionLayout+ViewDragHelper/image-20210310132922715.png" alt="image-20210310132922715" style="zoom:67%;"></p><p>就可以在右侧工具栏像使用<code>ConstraintLayout</code>一样设置约束了。</p><img src="/post/MotionLayout+ViewDragHelper/image-20210310133032363.png" alt="image-20210310133032363" style="zoom:67%;"><p>我们把背景约束到布局底部，然后宽度设为<code>match_parent</code>，高度设为<code>?actionBarSize</code> (Action Bar的高度)。</p><img src="/post/MotionLayout+ViewDragHelper/image-20210310133532255.png" alt="image-20210310133532255" style="zoom:67%;"><p>设置完之后，再查看XML代码，发现诶？好奇怪，怎么XML没变化？是的，与<code>ConstraintLayout</code>不同的是，对View设置的所有约束都需要在<code>scene</code>文件中定义，而不是在<code>MotionLayout</code>中定义，编辑器已经自动帮我们重定向到<code>fragment_player_scene.xml</code>了：</p><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;MotionScene xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;    xmlns:motion=&quot;http://schemas.android.com/apk/res-auto&quot;&gt;    &lt;Transition        motion:constraintSetEnd=&quot;@+id/end&quot;        motion:constraintSetStart=&quot;@id/start&quot;        motion:duration=&quot;1000&quot;&gt;        &lt;KeyFrameSet&gt;        &lt;/KeyFrameSet&gt;    &lt;/Transition&gt;    &lt;ConstraintSet android:id=&quot;@+id/start&quot;&gt;        &lt;!-- 约束节点 --&gt;        &lt;Constraint            android:id=&quot;@+id/player_background&quot;            android:layout_width=&quot;match_parent&quot;            android:layout_height=&quot;?actionBarSize&quot;            motion:layout_constraintBottom_toBottomOf=&quot;parent&quot; /&gt;    &lt;/ConstraintSet&gt;    &lt;ConstraintSet android:id=&quot;@+id/end&quot;&gt;            &lt;/ConstraintSet&gt;&lt;/MotionScene&gt;</code></pre><p>这样<code>player_background</code>的初始约束就完成了。同理，当我们选中“end”页面，再为其添加结束约束：</p><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;MotionScene xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;    xmlns:motion=&quot;http://schemas.android.com/apk/res-auto&quot;&gt;    &lt;Transition        motion:constraintSetEnd=&quot;@+id/end&quot;        motion:constraintSetStart=&quot;@id/start&quot;        motion:duration=&quot;1000&quot;&gt;        &lt;KeyFrameSet&gt;        &lt;/KeyFrameSet&gt;    &lt;/Transition&gt;    &lt;ConstraintSet android:id=&quot;@+id/start&quot;&gt;        &lt;Constraint            android:id=&quot;@+id/player_background&quot;            android:layout_width=&quot;match_parent&quot;            android:layout_height=&quot;?actionBarSize&quot;            motion:layout_constraintBottom_toBottomOf=&quot;parent&quot; /&gt;    &lt;/ConstraintSet&gt;    &lt;ConstraintSet android:id=&quot;@+id/end&quot;&gt;        &lt;Constraint            android:id=&quot;@+id/player_background&quot;            android:layout_width=&quot;match_parent&quot;            android:layout_height=&quot;wrap_content&quot;            motion:layout_constraintTop_toTopOf=&quot;parent&quot;            motion:layout_constraintBottom_toBottomOf=&quot;parent&quot; /&gt;    &lt;/ConstraintSet&gt;&lt;/MotionScene&gt;</code></pre><p>此时回到可视化编辑器：</p><img src="/post/MotionLayout+ViewDragHelper/image-20210310135030327.png" alt="image-20210310135030327" style="zoom:67%;"><p>先点击上方红色框部分，再点击播放按钮，就可以预览我们的动画了!</p><img src="/post/MotionLayout+ViewDragHelper/GIF 2021-3-10 13-55-30.gif" alt="GIF 2021-3-10 13-55-30" style="zoom: 67%;"><p>除了约束可以被动画以外，我们还可以设置各种<code>transform</code>属性:</p><p><img src="/post/MotionLayout+ViewDragHelper/image-20210310135806189.png" alt="image-20210310135806189"></p><p>甚至是可见性<code>visibility</code>，<code>MotionLayou</code>t也会自动使用透明度动画来过渡。除此之外，还支持<strong>View Transition</strong>属性，和自定义<strong>Attributes</strong>：</p><p><img src="/post/MotionLayout+ViewDragHelper/image-20210310140143967.png" alt="image-20210310140143967"></p><p>这些用法可以参考官方文档或网上的博文，本人不再赘述，因为这不是重点。</p><p>现在如果你在<code>Transition</code>节点下使用<code>OnSwipe</code>标签：</p><pre><code class="xml">&lt;MotionScene xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;    xmlns:motion=&quot;http://schemas.android.com/apk/res-auto&quot;&gt;    &lt;Transition        motion:constraintSetEnd=&quot;@+id/end&quot;        motion:constraintSetStart=&quot;@id/start&quot;        motion:duration=&quot;1000&quot;&gt;        &lt;OnSwipe            motion:dragDirection=&quot;dragUp&quot;            motion:touchAnchorId=&quot;@id/player_background&quot;            motion:touchAnchorSide=&quot;top&quot; /&gt;    &lt;/Transition&gt;    ...&lt;/MotionScene&gt;</code></pre><p>就可以在“start”和“end”约束之间拖动<code>player_background</code>。但是如我前面所言，<code>MotionLayout</code>自带的拖动释放效果非常拉跨，我们需要使用<code>ViewDagHelper</code>来配合。</p><h2 id="使用ViewDragHelper"><a href="#使用ViewDragHelper" class="headerlink" title="使用ViewDragHelper"></a>使用ViewDragHelper</h2><p>新建一个类<code>PlayerLayout</code>，继承自<code>MotionLayout</code>，并在其中初始化<code>ViewDragHelper</code>:</p><pre><code class="java">public class PlayerLayout extends MotionLayout &#123;    private ViewDragHelper mHelper;    private ViewDragHelper.Callback mCallback;    /**     * Background view     */    private View mBackground;    /**     * Background view在折叠时候的Top     */    private int mTopWhenCollapsed;    /**     * Background view在折叠时候的高度     */    private int mHeightWhenCollapsed;    public PlayerLayout(@NonNull Context context, @Nullable AttributeSet attrs) &#123;        super(context, attrs);        init();    &#125;    public PlayerLayout(@NonNull Context context) &#123;        super(context);        init();    &#125;    public PlayerLayout(@NonNull Context context, @Nullable AttributeSet attrs, int defStyleAttr) &#123;        super(context, attrs, defStyleAttr);        init();    &#125;    private void init() &#123;        mHelper = ViewDragHelper.create(this, mCallback);        OneShotPreDrawListener.add(this, () -&gt; &#123;            // 在这里获取Top和Height            mTopWhenCollapsed = mBackground.getTop();            mHeightWhenCollapsed = mBackground.getHeight();        &#125;);    &#125;         @Override    protected void onSizeChanged(int w, int h, int oldw, int oldh) &#123;        super.onSizeChanged(w, h, oldw, oldh);        // 当布局大小改变时(如软键盘弹起)，更新Top        mTopWhenCollapsed = h - mHeightWhenCollapsed;    &#125;        @Override    protected void onFinishInflate() &#123;        super.onFinishInflate();        mBackground = findViewById(R.id.player_background);    &#125;            @Override    public boolean onInterceptTouchEvent(@NotNull MotionEvent event) &#123;        // 让Helper判断是否应该切断事件        return mHelper.shouldInterceptTouchEvent(event);    &#125;        @SuppressLint(&quot;ClickableViewAccessibility&quot;)    @Override    public boolean onTouchEvent(@NotNull MotionEvent event) &#123;        // 这里判断一下Helper是否处于拖拽状态，拖拽状态就返回true消耗掉        // 不是的话将事件传递下去交给其他View处理，否则MotionLayout会        // block掉整个屏幕的触摸事件        mHelper.processTouchEvent(event);        boolean block = mHelper.getCapturedView() != null;        // 拖动的时候禁止打断（ACTION_CANCEL）        requestDisallowInterceptTouchEvent(block);        return block;    &#125;&#125;</code></pre><p>上面很多代码是<code>ViewDragHelper</code>固定的用法，有不懂的可以看注释。<code>mTopWhenCollapsed</code>后面会用到。我们还有一个<code>mCallback</code>变量未初始化，因为这个比较重要，单独拿出来：</p><pre><code class="java">mCallback = new ViewDragHelper.Callback() &#123;    @Override    public boolean tryCaptureView(@NonNull View child, int pointerId) &#123;        // 在这里定义允许哪个子视图拖动        // 我们允许MotionLayout中的所有子视图拖动        return true;    &#125;    @Override    public void onViewCaptured(@NonNull View capturedChild, int activePointerId) &#123;        super.onViewCaptured(capturedChild, activePointerId);        try &#123;            // 因为MotionLayout只支持其直接子视图的动画，而我们需要允许所有子视图拖动            // 这样的话，就需要处理非常多的View的拖动，因此重定向我们的&#39;mCapturedChild&#39;            // 到Background view, 这样就只要处理一个View就够了            Field capturedViewField = mHelper.getClass().getDeclaredField(&quot;mCapturedView&quot;);            capturedViewField.setAccessible(true);            capturedViewField.set(mHelper, mBackground);        &#125; catch (NoSuchFieldException | IllegalAccessException e) &#123;            // Ho hum        &#125;    &#125;    @Override    public void onViewPositionChanged(@NonNull View changedView, int left, int top, int dx, int dy) &#123;        super.onViewPositionChanged(changedView, left, top, dx, dy);        if (dy == 0) &#123;            return;        &#125;        // 当Background view拖动位置改变时，我们获取其拖动的百分比        // mTopWhenCollapsed就是能拖动的总距离        float fraction = 1 - mBackground.getTop() / (float) mTopWhenCollapsed;//from 0 to 1        // 在这里根据拖动的百分比设置动画进度        setProgress(fraction);    &#125;    @Override    public void onViewReleased(@NonNull View releasedChild, float xvel, float yvel) &#123;        // 当手指松开取消拖动时        super.onViewReleased(releasedChild, xvel, yvel);        // 根据Background view的速度、位置分别处理打开还是关闭Player        if (yvel &gt; 0) &#123;            collapsePlayer();        &#125; else if (yvel &lt; 0) &#123;            expandPlayer();        &#125; else &#123;            if (releasedChild.getTop() / (float) mTopWhenCollapsed &gt; .5f) &#123;                collapsePlayer();            &#125; else &#123;                expandPlayer();            &#125;        &#125;    &#125;    @Override    public int getViewVerticalDragRange(@NonNull View child) &#123;        // 返回Background view所能垂直拖动的距离        return mTopWhenCollapsed;    &#125;    @Override    public int clampViewPositionVertical(@NonNull View child, int top, int dy) &#123;        // 约束Background view在拖动中垂直方向上所允许Top范围        // 返回值约束在0和mTopWhenCollapsed之间        return Math.min(Math.max(0, top), mTopWhenCollapsed);    &#125;    @Override    public int clampViewPositionHorizontal(@NonNull View child, int left, int dx) &#123;        // 水平方向自适应        return child.getLeft();    &#125;&#125;;</code></pre><p>最后，是松手后实现自然折叠、展开的方法：</p><pre><code class="java">public void expandPlayer() &#123;    if (mHelper.smoothSlideViewTo(mBackground, 0, 0)) &#123;        ViewCompat.postInvalidateOnAnimation(this);    &#125;&#125;public void collapsePlayer() &#123;    if (mHelper.smoothSlideViewTo(mBackground, 0, mTopWhenCollapsed)) &#123;        ViewCompat.postInvalidateOnAnimation(this);    &#125;&#125;@Overridepublic void computeScroll() &#123;    if (mHelper.continueSettling(true)) &#123;        ViewCompat.postInvalidateOnAnimation(this);    &#125;&#125;</code></pre><p>这样，就完成了最基本的框架就完成了，核心思想就是在<code>ViewDragHelper.Callback</code><strong>中监听滑动的比例，然后为<code>MotionLayout</code>设置动画的比例</strong>，当然还有很多小细节的处理。预览图那样的效果不过是在此基础上增加了更多的<code>view</code>和动画。</p><h2 id="其他冷知识"><a href="#其他冷知识" class="headerlink" title="其他冷知识"></a>其他冷知识</h2><h3 id="如何渐变圆角？"><a href="#如何渐变圆角？" class="headerlink" title="如何渐变圆角？"></a>如何渐变圆角？</h3><p>可以看到我们的预览图中，播放器折叠时左上角有圆角，但是随着滑动，圆角逐渐消失最终不见。这是如何实现的呢？</p><h4 id="MaterialShapeDrawable"><a href="#MaterialShapeDrawable" class="headerlink" title="MaterialShapeDrawable"></a>MaterialShapeDrawable</h4><p>使用前先导入google的design库：</p><pre><code class="groovy">implementation &#39;com.google.android.material:material:1.2.1&#39;</code></pre><p>构造实例并使用：</p><pre><code class="java">// 构造左上角圆角的ShapeAppearanceModelmDefShapeAppearance = ShapeAppearanceModel.builder().setTopLeftCorner(CornerFamily.ROUNDED, defCornerSize).build();// 根据ShapeAppearanceModel初始化MaterialShapeDrawablemBackgroundDrawable = new MaterialShapeDrawable(mDefShapeAppearance);// 将此Drawable设为View的背景view.setBackground(mBackgroundDrawable);</code></pre><p>提供改变圆角的方法：</p><pre><code class="java">public void setTopLeftCornerSize(float cornerSize) &#123;  mBackgroundDrawable.setShapeAppearanceModel(mDefShapeAppearance.toBuilder().setTopLeftCorner(CornerFamily.ROUNDED, cornerSize).build());&#125;</code></pre><h4 id="Custom-Attributes"><a href="#Custom-Attributes" class="headerlink" title="Custom Attributes"></a>Custom Attributes</h4><p>如果想要<code>MotionLayout</code>自动在动画过程中改变圆角，而不用手动设置，可以使用上面提及的<strong>自定义属性</strong>。新建一个自定义View继承自你想设置圆角的那个View的类，然后把上面设置圆角的方法内置到该类中。</p><p>在编辑器中选中该view，在其约束编辑窗口中找到此按钮<img src="/post/MotionLayout+ViewDragHelper/image-20210310151249634.png" alt="image-20210310151249634" style="zoom:67%;">然后会弹出此窗口：</p><img src="/post/MotionLayout+ViewDragHelper/image-20210310151412639.png" alt="image-20210310151412639" style="zoom:67%;"><p>在“start”和“end”两个<code>ConstranitSet</code>中分别配置<code>Value</code>就行了。</p><h3 id="如何渐变状态栏颜色"><a href="#如何渐变状态栏颜色" class="headerlink" title="如何渐变状态栏颜色?"></a>如何渐变状态栏颜色?</h3><pre><code class="java">// 前提是windowTranslucentStatus = false且windowDrawsSystemBarBackgrounds = trueObjectAnimator.ofArgb(activity.getWindow(), &quot;statusBarColor&quot;, customColor);</code></pre>]]></content>
      
      
      <categories>
          
          <category> Android UI/UX </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Databinding使用笔记</title>
      <link href="//post/DatabindingNotes/"/>
      <url>//post/DatabindingNotes/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="Databinding使用中的一些细节"><a href="#Databinding使用中的一些细节" class="headerlink" title="Databinding使用中的一些细节"></a>Databinding使用中的一些细节</h1><blockquote><p>可能存在错误或疏漏，欢迎批评斧正…</p></blockquote><ul><li><p>实体类的字段要想实现可观察，其字段需要使用<code>ObservableXxx</code>。如果不想使用<code>ObservableXxx</code>，该实体类可继承自<code>BaseObservable</code>，然后在对应的字段的<code>getter</code>上添加<code>@Bindable</code>注解，在对应的<code>setter</code>里调用<code>notifyPropertyChange</code>，这样该字段仍然是可观察的，如果你既不想使用<code>Observable</code>，而且该类已经继承自其他类，无法再继承<code>BaseObservable</code>。那么可以参照<code>BaseObservable</code>的写法引入<code>PropertyChangeRegistry</code>以及相关方法。这样做看似不优雅，但是其实是官方操作，因为Google官方的例子中就是这样做的，参见<a href="https://github.com/android/databinding-samples/blob/master/TwoWaySample/app/src/main/java/com/example/android/databinding/twowaysample/util/ObservableViewModel.kt">databinding-samples</a> 。</p></li><li><p><code>@BindingAdapter</code>注解，该注解可以实现自定义XML属性。比如，你想实现一个<code>View</code>根据XML中定义的<code>width</code>设置宽度，那么，我们可以定义一个<code>android:width</code>属性: </p><pre><code class="xml">&lt;layout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;    &lt;data&gt;        &lt;variable            name=&quot;width&quot;            type=&quot;int&quot; /&gt;    &lt;/data&gt;        &lt;View              ...            android:width=&quot;@&#123;width&#125;&quot;/&gt;&lt;/layout&gt;</code></pre><p>但是此时，<code>Databinding</code>框架是无法识别<code>android:width</code>的，因为View没有<code>setWidth</code>方法，此时我们要定义一个方法来告诉框架如何使用此属性：</p><pre><code class="java">  @BindingAdapter(&quot;android:width&quot;)   public static void setWidth(@NotNull View view, int width) &#123;          ViewGroup.LayoutParams lp = view.getLayoutParams();          lp.width = width;          view.setLayoutParams(lp);   &#125;</code></pre><p>注意，该方法可以放在任何一个可视性为<code>public</code>的类中，并且其修饰符须为<code>public static</code>(除非自定义Component)，方法名是任意的。建议新建一个类专门存放这些<code>Binding Adapters</code>，官方就是这么做的： 如所有<code>TextView</code>有关的自定义绑定适配器都存放在<code>TextViewBindingAdapter</code>中。该方法第一个参数是XML中的目标<code>View</code>对象，第二个参数是XML中传入的值。这样定义后，IDE就能识别该自定义属性，Databinding框架就会自动调用此方法绑定数据。</p></li><li><p><code>@InverseBindingAdapter</code>注解，该注解用于双向绑定。如果说<code>@BindingAdapter</code>定义了如何为视图设置特定值，那么<code>@InverseBindingAdapter</code>就定义了如何从视图中获取特定值。如果某个自定义属性要实现双向绑定，必须同时实现<code>@BindingAdapter</code>注解和<code>@InverseBindingAdapter</code>注解。还是上面这个例子，如果我们需要实现视图的宽度改变时，自动改变XML中<code>width</code>变量的值，我们需要对XML做如下改动：</p><blockquote><p> android:width&#x3D;”@<strong>&#x3D;</strong>{width}”</p></blockquote><p>然后实现反向绑定对应的方法:</p><pre><code class="java">@InverseBindingAdapter(attribute = &quot;android:width&quot;,event = &quot;android:widthAttrChanged&quot;)public static int getWidth(@NotNull View view) &#123;    return view.getWidth();&#125;</code></pre><p>这样，框架就知道如何从视图中获取<code>android:width</code>属性的值，以便传递给<code>width</code>变量。但是问题是，框架知道如何获取值，但是它并不知道该值何时改变啊，所以目前双向绑定还没有生效。不知你是否注意到上面代码中的<code>event = &quot;android:widthAttrChanged&quot;</code>。是的，顾名思义，当 <code>android:widthAttrChanged</code> 这个事件发生时，框架会读取该值。这个事件名默认为<code>andoroid:xxxAttrChanged</code>, xxx为我们自定义的属性名，所以这段<code>event = &quot;android:widthAttrChanged&quot;</code>其实可以省略。接下来的问题是，<code>widthAttrChanged</code>事件是啥，什么时候发生？为此，我们还需要配置一个额外的Binding Adapter：</p><pre><code class="java">@BindingAdapter(&quot;android:widthAttrChanged&quot;)public static void setWidthWatcher(View view, final InverseBindingListener listener) &#123;    View.OnLayoutChangeListener newValue = (v, left, top, right, bottom, oldLeft, oldTop, oldRight, oldBottom) -&gt; &#123;        boolean isChanged = left != oldLeft || right != oldRight || top != oldTop || bottom != oldBottom;        if (isChanged)            listener.onChange();    &#125;;    View.OnLayoutChangeListener oldValue = ListenerUtil.trackListener(view, newValue, R.id.onWidthChanged);    if (oldValue != null) &#123;        view.removeOnLayoutChangeListener(oldValue);    &#125;    view.addOnLayoutChangeListener(newValue);&#125;</code></pre><p>是不是看懵了？解释一下。可以看到，这个Binding Adapter定义了一个<code>android:widthAttrChanged</code>属性，没错，就是反向绑定触发事件名（<strong>注：该自定义属性不可用于XML</strong>），该方法其实就是定义了该事件何时触发。首先，该方法有两个参数，第一个是目标视图，第二个是反向绑定监听器。反向绑定监听器就是一个通知视图属性改变，然后反向改变数据的回调。查看方法体，可以看到，我们为该View设置了一个<code>OnLayoutChangeListener</code>, 目的是监听该View的宽度改变，当宽度改变时，调用<code>InverseBindingListener#onChange()</code>，这样就相当于发出了<code>widthAttrChanged</code>事件。不过，方法体中好像还有一些意义不明的代码，这些代码其实是防止重复监听的模板代码。其中<code>ListenerUtil.trackListener</code>可以追踪指定指定view的指定id的listener，如果该view已经有指定id的listener，就会返回该listener，否则返回null。最后一个问题，既然这个自定义属性不能在XML中使用，那这个方法什么时候会调用呢？当框架检测到我们的<code>android:width</code>的双向绑定，就会查找该属性反向绑定事件所在的<code>@BindingAdapter</code>注解并调用此方法，<code>InverseBindingListener</code>由系统传入。</p></li><li><p>如果自定义属性不存在，Databinding框架会自动查找该视图的<code>getter</code>和<code>setter</code>方法，而不用手动定义Adapters。关于这个特性，可以有骚操作。当我们自定义View时，可能会需要自定义属性，那么，通常情况下，需要在<code>&lt;declare-styleable/&gt;</code>标签下自定义<code>attr</code>，然后在代码中解析。利用Databinding，我们只需要定义好对应的<code>getter</code>和<code>setter</code>（须符合Java bean 规范）方法，就可以直接在xml中直接使用自定义属性了，省去大量工作。当然这样做布局编辑器是无法预览这些自定义属性的。</p></li><li><p>如果自定义属性的<code>setter</code>和<code>getter</code>方法已经存在，只是名称不符合<code>setter</code>和<code>getter</code>规范。此时，可以使用<code>@BindingMethods</code>和<code>@InverseBindingMethods</code>注解进行声明，而不需要手动定义Adapters。参见<code>AdapterViewBingAdapter</code>等官方实现类。</p></li><li><p>Databinding表达式支持空值判断三元运算语法糖：<code>@&#123;a??b&#125;=@&#123;a==null?b:a&#125;</code></p></li><li><p>默认数据绑定是在数据更新后一帧执行，如果遇到需要改变数据后立即更新View的需求，可以调用<code>executePendingBinding</code>立即刷新数据绑定。通常，遇到数据和View的某些属性无法对应的情况，可能就是掉进了这个坑。比如：某个View的enabled状态是由XML中的变量<code>enabled</code>指定的，如果在代码中设置了<code>enabled=true</code>，然后立刻（在一个事件循环内）获取<code>isEnabled</code>，就会发现变量<code>enabled</code>的值和View的状态并不一致。</p></li><li><p><code>@BindingAdapter</code>的<code>requiredAll</code>属性的作用在于，当<code>requireAll</code>为<code>true</code>时（默认），只有当View同时定义了<code>value</code>中的所有属性，才会调用此方法（否则会报错）。当<code>requiredAll</code>为<code>false</code>时，只要定义了<code>value</code>中的任意一个属性，就会调用此方法。</p></li><li><p>XML中属性文本定义时的先后位置确定这些属性在数据绑定时的先后顺序，如果某个属性依赖前一个属性，那么确保它们的位置顺序是正确的。如果无法确保（比如IDE格式化XML后会自动更换顺序），或者为了提高可维护性，那么请使用上面提到的<code>requireAll</code>属性，建立一个<code>@BindingAdapter</code>，在<code>value</code>中同时包含这两个属性，并使用<code>requireAll=true</code>，然后在方法体中自己定义两个属性的设置顺序。</p></li><li><p>Databinding表达式中语句最后的空括号可省略，比如<code>onClick=&quot;@&#123;()-&gt;activity.onClick(edit.getText())&#125;&quot;</code>可省略为<code>onClick=&quot;@&#123;()-&gt;activity.onClick(edit.getText)&#125;&quot;</code>，但是如果语句为<code>onClick=&quot;@&#123;()-&gt;activity.onClick(edit.getText().toString())&#125;&quot;</code>,那么，<br>只能省略为<code>onClick=&quot;@&#123;()-&gt;activity.onClick(edit.getText().toString)&#125;&quot;</code>而不能省略为<code>onClick=&quot;@&#123;()-&gt;activity.onClick(edit.getText.toString)&#125;&quot;</code></p></li><li><p>如果在表达式中引用<strong>其他视图</strong>的属性并使用了无get语句(如<code>.getText()</code>变成<code>.text</code>)，那么系统会默认你在使用这个属性的反向绑定，比如<code>text=&quot;@&#123;edit.text.toString()&#125;&quot;</code>，那么当<code>edit.text</code>改变时，此控件的<code>text</code>也会改变（系统已经提前实现了text属性的反向绑定方法），如果你使用了一个未实现反向绑定的属性，如<code>padding=&quot;@&#123;textView.height&#125;&quot;</code>，那么，构建应用时系统就会报错，此时你要自己使用<code>@InverseBindingAdapter</code>和<code>@BindingAdapter</code>来获取并通知<code>height</code>的变化，此方法才可用。如果只是想引用某个属性，而不是与某个属性绑定，那么请使用未省略get的语句，如<code>padding=&quot;@&#123;textView.getHeight()&#125;&quot;</code>。这时候，只有执行数据绑定时，两个数据才会同步，而不是当一个改变时，另一个也改变。其实系统这样的设计是正确的，通常情况下，我们引用另一个视图的属性，就是为了保持与之同步。</p></li><li><p>在xml中调用方法传参为<code>null</code>时，如果不将<code>null</code>显式强转为参数所要求的类型，Databinding框架会将<code>null</code>强转为<code>Object</code>类型，若该方法所需参数不是<code>Object</code>，那么就会无法通过编译。</p></li><li><p><code>ViewDataBinding.inflate(inflater)</code>直接可以获得实例，我居然用<code>ViewDataBindingUtils.inflate()</code>用了这么久。</p></li><li><p>Databinding支持<code>LiveData</code>，也就是说<code>LiveData</code>(通常是<code>MutableLiveData</code>)可以代替<code>ObservableXx</code>进行数据绑定。<code>LiveData</code>和<code>Observable</code>的区别在于，<code>LiveData</code>是<em>Lifecycle Perceptive</em>(生命周期可感知)的，即<code>LiveData</code>的订阅事件只在其宿主处于活跃状态时才会执行。正因为如此，使用LiveData进行数据绑定需要通过<code>ViewDatabinding.setLifecyclerOwner</code>设置宿主，绑定才会生效。</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Android Dev </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>关于我从零开始搭博客这件事儿</title>
      <link href="//post/HelloHexo/"/>
      <url>//post/HelloHexo/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="关于我从零开始搭博客这件事儿"><a href="#关于我从零开始搭博客这件事儿" class="headerlink" title="关于我从零开始搭博客这件事儿"></a>关于我从零开始搭博客这件事儿</h1><blockquote><p>本文主要讲述了萌新从零搭建博客的一些小细节~</p></blockquote><h2 id="关于起因"><a href="#关于起因" class="headerlink" title="关于起因"></a>关于起因</h2><p>其实早在2016年，那时候我还是高中生，就了解到<strong>Hexo</strong>框架下的精致博客，那是<a href="https://github.com/bollnh/hexo-theme-material">Material</a>主题作者在简书发表的推广简介。那篇文章在我的收藏夹躺到现在。眼看该项目最近一条commit都是九个月前了，我才搭好，感觉像是看了一份糊在墙上的报纸。因为当时我觉得搭博客是一件非常麻烦的事，所以还没尝试就放弃了。最近，看到一位好友的博客，我又心血来潮，才下定决心。这一路下来，发现其实并不难。所以说，有时阻挡我们的不是荆棘，而是退却的心。</p><h2 id="关于过程"><a href="#关于过程" class="headerlink" title="关于过程"></a>关于过程</h2><p>我完全不懂Web知识，搭博客几乎就是照着别人的教程一步一步下来的。从挑域名到成功deploy大约花了四五小时，虽然是成功了，但是一路都是云里雾里的，完全不懂为什么，只知道<code>Ctrl C</code> + <code>Ctrl V</code>…回头再看，才有了初步的了解。接下来就是一堆配置工作，我这个从未接触过<code>yaml</code>的小白以至于不知道冒号后面要加空格而被坑了好一会儿。生而为人，我很抱歉🥲。</p><h2 id="关于Material主题的使用"><a href="#关于Material主题的使用" class="headerlink" title="关于Material主题的使用"></a>关于Material主题的使用</h2><blockquote><p>如何搭建hexo以及如何托管到github（抑或是自己的服务器）我就不赘述了，网上教程及官方文档已经说得很明白了。</p></blockquote><p>Material主题的使用很简单，直接把项目<code>clone</code>到<code>hexo</code>的<code>theme</code>目录下</p><pre><code class="shell">cd [你的主题目录]git clone https://github.com/viosey/hexo-theme-material.git</code></pre><p>然后修改hexo的<code>_config.yml</code>，找到<code>theme</code>字段，修改为<code>clone</code>下来的文件夹名，名字可以修改。没修改过的话，应该就是<code>hexo-theme-material</code>，以下都以 <strong>hexo-theme-material</strong>为例</p><pre><code class="yaml">theme: hexo-theme-material</code></pre><p>还有一个坑， **需要手动将 hexo-theme-material 文件夹中的 <code>_config.template.yml</code> 复制一份并重命名为 <code>_config.yml</code>**。</p><p>如果你的博客是托管在github上，并且使用了自定义域名，请在博客的<code>source</code>目录下新建一个文件，命名为<code>CNAME</code>, 然后在里面写入你的域名。这样github就会自动识别<code>custom domain</code>，而不用你每次都去手动配置。最后：</p><pre><code class="shell">hexo cleanhexo ghexo d</code></pre><p>就能看到主题部署成功啦！接下来就是按自己喜好配置主题咯！</p><h2 id="一些小问题"><a href="#一些小问题" class="headerlink" title="一些小问题"></a>一些小问题</h2><h3 id="如何建立一个自我介绍的页面？"><a href="#如何建立一个自我介绍的页面？" class="headerlink" title="如何建立一个自我介绍的页面？"></a>如何建立一个自我介绍的页面？</h3><p>先创建一个新页面，如下，该命令会在hexo的<code>source</code>目录下创建一个文件夹(文件夹名可自定义，以下就以<code>intro</code>为例)，这个文件夹和你的<code>_posts</code>是平行且隔离的。</p><pre><code class="powershell">hexo new page &quot;intro&quot;</code></pre><p>成功后，<code>intro</code>文件夹下会生成一个<code>index.md</code>,不同于post页面，自定义的页面只能识别<code>index.md</code>并显示，你新建其他md，是不会被显示的（因为<code>index.md</code>会被渲染成<code>index.html</code>）。现在你就可以在<code>index.md</code>里写自己的介绍啦！当然，写完以后，如何在侧边栏添加一个入口呢？首先，打开<strong>主题</strong>的<code>_config.yml</code>,找到<code>sidebar</code>节点，然后找到<code>sidebar</code>节点下的<code>pages</code>节点,最后在<code>pages</code>节点下添加</p><pre><code class="yaml">关于: #这里的文字会显示在侧边栏，可以自定义    link: &quot;/intro&quot; # 这里是生成的page的目录，即我前面指令里的intro，不能乱改    icon: person #可以自定义图标，图标来自于material.io/icons,无需下载图标，直接填图标名即可    divider: false #是否显示下方分割线</code></pre><p>完成后 <code>hexo s</code>，就可以预览效果啦！</p><h3 id="如何在博客中使用图片？"><a href="#如何在博客中使用图片？" class="headerlink" title="如何在博客中使用图片？"></a>如何在博客中使用图片？</h3><p>使用<strong>hexo-asset-image</strong>插件：</p><pre><code class="shell">npm install hexo-asset-image --save</code></pre><p>然后在Hexo的<code>_config.yml</code>里配置 （如果不存在就添加进去）：</p><pre><code class="yaml">post_asset_folder: true</code></pre><p>这个插件的作用有两个：一是当我们用 <code>hexo new post</code>新建文章的时候，它会自动在这个文章的同级目录下新建一个和文章同名的目录，用于存放资源。这样，我们在Typora中配置图片插入的方式为<code>./$&#123;filename&#125;</code>就可以了（<strong>别忘了勾选优先使用相对路径</strong>），这个操作一下解决了上面那个方案的两个问题。但是问题是，我们之所以会有上面那个方案，是因为主题目录下的<code>img</code>目录渲染的时候会被复制到<code>public</code>目录里，最后部署到远端，而现在这个方式单纯建立一个目录，渲染的时候是会被忽略的。这就是这个模块的第二个作用，帮我们把这个资源目录也复制到<code>public</code>目录下，并且将图片的路径转为web上的绝对路径，现在可算两全了。</p><h4 id="头图的特殊处理"><a href="#头图的特殊处理" class="headerlink" title="头图的特殊处理"></a>头图的特殊处理</h4><p>对于文章的头图，即文章<code>front matter</code>配置中的<code>thumbnail</code>字段，我们不能像在文章中一样使用<code>./&#123;filename&#125;/xxx.jpg</code>这样的相对路径因为头部的<code>yaml</code>被渲染后是保持不变的，图片的位置不会已经不再是那个相对路径了，而且这个头图会在预览和详细两个页面都显示，所以使用相对路径肯定是不行的，我们只好手动改成绝对路径，格式为<code>/&#123;permalink&#125;/xxx.jpg</code>。</p><h3 id="使用MathJax"><a href="#使用MathJax" class="headerlink" title="使用MathJax"></a>使用MathJax</h3><p><strong>MathJax</strong>可以让我们在markdown中使用并渲染公式。首先打开主题的的<code>_config.yml</code>，配置：</p><pre><code class="yaml">mathjax: https://cdn.bootcss.com/mathjax/2.7.1/latest.js</code></pre><p>然后在博客的的<code>front matter</code>中配置<code>math: true</code>即可。</p><h3 id="如何建立时光轴、标签云、图库等？"><a href="#如何建立时光轴、标签云、图库等？" class="headerlink" title="如何建立时光轴、标签云、图库等？"></a>如何建立时光轴、标签云、图库等？</h3><p>其实建立这些的原理和我上面说的建立“自我介绍”页面时一样的，本质也是建立一个新Page,只不过这个Page里的<code>index.md</code>的layout类型是特定的罢了。具体的方法参考上文以及<a href="https://neko-dev.github.io/material-theme-docs/#/">官方文档</a>。</p><h3 id="如何在博客主页添加网易云音乐歌单-x2F-歌曲外链播放器？"><a href="#如何在博客主页添加网易云音乐歌单-x2F-歌曲外链播放器？" class="headerlink" title="如何在博客主页添加网易云音乐歌单&#x2F;歌曲外链播放器？"></a>如何在博客主页添加网易云音乐歌单&#x2F;歌曲外链播放器？</h3><p>这是什么呢？看图，或者到我的博客主页底部就能看到这个<img src="/post/HelloHexo/outchain.png"></p><p>那这是怎么是怎么实现的呢？其实主要得益于网易云音乐提供的外链播放器功能，首先登录网页版网易云音乐，登录以后，点击进入一个歌单，如下图<img src="/post/HelloHexo/outchain1.png"></p><p>点击图片上指示的<strong>生成外链播放器</strong>，复制他给的代码就行了，一般像这样：</p><pre><code class="html">&lt;iframe frameborder=&quot;no&quot; border=&quot;0&quot; marginwidth=&quot;0&quot; marginheight=&quot;0&quot; width=330 height=450 src=&quot;//music.163.com/outchain/player?type=0&amp;id=135453255&amp;auto=0&amp;height=430&quot;&gt;&lt;/iframe&gt;</code></pre><p>此时，如果你的歌单里包含没有版权的歌曲，网页会提示是无法生成外链播放器。这时看我图示标注的歌单id，把生成的外链中的id参数替换掉就行，即使这样，没有版权的歌曲还是无法播放的，但是聊胜于无嘛。当然，自己建立一个博客专用歌单也是阔以的。这个外链播放器我们可以选择插入到网页中，也可以直接在博客的<code>markdown</code>内插入。</p><h4 id="2022年更新"><a href="#2022年更新" class="headerlink" title="2022年更新"></a>2022年更新</h4><p>不知何时开始，网易云外链播放器坏掉了，一直弹窗显示无法加载资源。原来以前包含版权保护歌曲的外链已经无法用之前的方式生成了，好像也没有解决办法，那就选一个没有保护歌曲的歌单吧，或者直接用单曲。</p><h2 id="拓展模块"><a href="#拓展模块" class="headerlink" title="拓展模块"></a>拓展模块</h2><ul><li><p><strong>hexo-asset-image</strong>：帮助我们在博客中更方便地插入图片</p></li><li><p><strong>hexo-deployer-git</strong>：使用<code>hexo g</code>自动托管到Github平台</p></li><li><p><strong>hexo-post-hide</strong>：帮助我们隐藏某些博客，使用方法详见<a href="https://github.com/prinsss/hexo-hide-posts">Github主页</a></p></li><li><p><strong>hexo-reference</strong>：解决脚注渲染问题</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 杂谈 </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
    
    
    <entry>
      <title></title>
      <link href="/baidu_verify_code-1RmVXAmgqo.html"/>
      <url>/baidu_verify_code-1RmVXAmgqo.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css">43b197d48dbebfb2736d3263847375d9]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/google5a089b35ff8e1969.html"/>
      <url>/google5a089b35ff8e1969.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css">google-site-verification: google5a089b35ff8e1969.html]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/player.html"/>
      <url>/player.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><html>  <head>    <meta charset="utf-8">    <title>网易云音乐</title>    <link rel="stylesheet" type="text/css" href="https://s5.music.126.net/static_public/5f040ccb0696071dab793a9d/outchain-base.css">    <link rel="stylesheet" type="text/css" href="https://s5.music.126.net/static_public/5f040ccb0696071dab793a9d/outchain-player.css">    <style type="text/css">    #player {    margin: 10px 0 0 10px;    }    </style>    <!--[if lt IE 9]>    <style>    .player{border:1px solid #ccc;}    </style>    <![endif]-->    <script src="https://st.music.163.com/encrypt-validator/musicfrontencryptvalidator.min.js" async></script>    <script>    (function() {    if (window.CMFrontEncryptedValidator) {    var validatorOptions = {    "captchaOptions": {    "qrSize": 150    },    "whiteAPIs": ["ac.dun.163yun.com/v3/d", "ac.dun.163.com/v2/config/js", "ac.dun.163yun.com/v3/b", "ac.dun.163yun.com/v2/b", "ac.dun.163yun.com/v2/d"]    } || {};    var env = 'prod' || 'prod';    var sampleRate = 0.00001 || 1;    var isBubbleEncryptResult = true || false;    var disable = false || false;    var businessType = 'music' || 'music';    var grayReleaseRate = Number(1) || 1;    var grayReleaseUserIds = '' || '';    var showToast = true || false;    validatorOptions.grayReleaseUserIds = grayReleaseUserIds;    validatorOptions.grayReleaseRate = grayReleaseRate;    validatorOptions.showToast = showToast;    validatorOptions.env = env;    validatorOptions.businessType = businessType;    validatorOptions.sampleRate = sampleRate;    validatorOptions.isBubbleEncryptResult = isBubbleEncryptResult;    validatorOptions.disable = disable;    validatorOptions.whiteAPIs = validatorOptions.whiteAPIs || [];    window.CMFrontEncryptedValidator(validatorOptions);    }    })()    </script>    <script src="https://st.music.163.com/encrypt-sdk/musicfrontencryptsdk.min.js" async></script>    <script>    (function() {    if (window.CMFrontEncryptedSDK) {    var disable = false;    var injectData = {    "WEVNSM": "1.0.0"    } || {};    var crawlerVersion = '01' || {};    var cookieOption = {    "sameSite": "strict"    } || {};    var env = 'prod' || 'prod';    var options = {    env: env,    disable: disable,    injectData: injectData,    crawlerVersion: crawlerVersion,    cookieOption: cookieOption    };    window.CMFrontEncryptedSDK.init(options);    }    })()    </script>    <script src="https://st.music.163.com/g/nos-url-check/index.js" async></script>    <script>    window.__puzzle_app_name = '云音乐主站puzzle';    </script>    <!-- <script src="https://s5.music.126.net/static_public/61408790f1a0b5f531e1e587/ctWebLogin.main-v3.1.js"></script> -->    <script async src="https://s6.music.126.net/puzzle/puzzle@0002A4.js"></script>    <script>    var GEnc = true;    </script>    <!-- <script type="text/javascript" charset="UTF-8" async="" src="https://acstatic-dun.126.net/2.7.3_7e37cc16/watchman.min.js"></script> -->    <style>    hcfy-result.__hcfy__result__loaded__.__hcfy__result__both__ {    border: 1px dotted    }    </style>    <style type="text/css">    /* 还是需要定高点 */    .style_openmask__1Iqoy {    position: fixed;    top: 0;    left: 0;    width: 100%;    height: 100%;    background-color: rgba(0, 0, 0, 0.85);    z-index: 10004;    }    .style_openmask__1Iqoy .style_opentip__3Z4Df {    position: fixed;    top: 0;    left: 10px;    right: 10px;    height: 144px;    }    .style_openmask__1Iqoy .style_opentip__3Z4Df .style_lay__1ovDQ {    width: 100%;    height: 120px;    border-radius: 0 0 8px 8px;    background: #f9f9f9 url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAP4AAACgCAMAAAAbzCHkAAAAOVBMVEUAAABNTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU0DekkdAAAAEnRSTlMA8ietERxLacmDeNa5oVuRNeAOJcWwAAADUUlEQVR42u2dy5KjMAxFJeMnYB73/z92CJlMkpqqnsequw9nkyKVjWIhXUvC2PcgGplVXgxL1sFoVGbdyMYk6aQak1UCL390eVolzUakSd3iLmkzHum2+GYZuvyDVOygI+/+Rep2UoHBP/kvl4+TRNN+VTXa035nif/1bn0oy3azv6obiFHDewAYSNFvUXv8DVrtZN0x7r9M21P2jo8vKck/Lfagv8T8wNv5zm+KB6d9K1PvP3ApGRfJjUuQJuOSmXvdB0UssfubAmggrXtx8ULtPKH7ZGPnPXjgX3k1vlcqscL9xCVMied3Nmk3LkUajEtnR74dXepJ7FrHNqE3+2Yp2AWTtIAlj9koNeNSpcWwRKEF/wIc6HlhIM8ym7kEzvqZXebr7LTH9v2F7fuNHfctjeSpDjbspc/s5tYgrYYlCJ30V/ZAk6M7m4Xd2tvRva2F3dyZ0FvdLNpTW2+EgSx5DgJY8IP9/iB7I/8B7LBf0GE/OrrE19BqPzm6pz2gm7oZekTLT3Z0ha+hk56FmVzlOAAX+DJ4m2cW3MEZ3yq6n98k56b8DX0iZ5zQXa0uOTfwF+R5fA82J2v9OKFznjU5eJbBLHNvfLDpZ9gDyx1LLk3YEkecRA57s+Tce7+LXNZf0du8JrLWHYU+maKgt/igY3d/p6D7GSN6arWB3zVzz/czVuh36JtGTuJMzvepCvyQ1raLPLaYHZ3yrGD393FYwQPbAfhqoSeLg4Ne7AKX9bZJUqW2sEcH17VSJTu+xZ3r+CGYZWzEb17NDLr0eQc3MtKgg8rsYMbmEvbt6cV10KF3/ayDyhzSjffTN5h+n2s1s8p8EHmZwAOqZdKBI1N9an4avxLDfRx0A3n4wG29d0l7ARq/zMpmTTMw5OXukgbiixTiMrgkaMd21p2JdrBmWnoym07bG8vpt9L3+zDqqjp+ZtvD4D6EDy7+kVTW6rrTzdLn9vlwV2Hhg4u/JOSyjmZZP/F5/Pyb2UEnw8cX78T4+AzBzErrc911YzILOtiH8vlNv+E68Q8v3hn0Qrr98ImZ9fELPWX/H+bPeiGY7TrZax+/3OD9fzj/6rrjvk/BbGxl2b7Ogv9D6Pv+T9H8IfF9c+svLi4uLi4uLhj8AJRKMdjUtWgaAAAAAElFTkSuQmCC) 100% 4px no-repeat;    background-size: 127px auto;    }    .style_openmask__1Iqoy .style_opentip__3Z4Df .style_lay__1ovDQ .style_note__10dvC {    float: right;    margin: 14px 58px 0 0;    width: 167px;    line-height: 20px;    color: #222;    }    .style_openmask__1Iqoy .style_opentip__3Z4Df .style_lay__1ovDQ h3 {    margin-bottom: 6px;    font-size: 20px;    font-weight: normal;    }    .style_openmask__1Iqoy .style_opentip__3Z4Df .style_lay__1ovDQ p {    font-size: 14px;    }    </style>    <style type="text/css">    /* 还是需要定高点 */    /* 中间显示toast */    .style_CMFrontEncryptedValidator-toast__2hRBW {    position: fixed;    top: 50%;    left: 50%;    z-index: 10003;    -webkit-transform: translate(-50%, -50%);    -ms-transform: translate(-50%, -50%);    transform: translate(-50%, -50%);    min-width: 70px;    min-height: 30px;    text-align: center;    border-radius: 4px;    background: rgba(0, 0, 0, 0.8);    opacity: 1;    -webkit-transition: all 200ms linear;    -o-transition: all 200ms linear;    transition: all 200ms linear;    /* 动画设置 */    }    .style_CMFrontEncryptedValidator-toast__2hRBW.style_toast-entering__2f54c {    opacity: 0;    }    .style_CMFrontEncryptedValidator-toast__2hRBW.style_toast-entered__1M1Hx {    opacity: 1;    }    .style_CMFrontEncryptedValidator-toast__2hRBW.style_toast-exiting__LG8YG {    opacity: 1;    }    .style_CMFrontEncryptedValidator-toast__2hRBW.style_toast-exited__1vYPC {    opacity: 0;    }    .style_CMFrontEncryptedValidator-toast__2hRBW .style_text__1FTZu {    padding: 10px 15px;    line-height: 30px;    font-size: 15px;    color: #fff;    }    .style_CMFrontEncryptedValidator-toast-center__1xkCf {    width: 180px;    min-height: 116px;    border-radius: 6px;    }    .style_CMFrontEncryptedValidator-toast-center__1xkCf .style_icn__2KezR {    display: block;    width: 35px;    height: 35px;    margin: 10px auto 15px;    }    .style_CMFrontEncryptedValidator-toast-center__1xkCf .style_text__1FTZu {    line-height: 20px;    padding: 0 15px 0;    margin: 15px 0;    }    .style_CMFrontEncryptedValidator-toast-loading__1Av04 {    margin-top: -100px;    width: 180px;    min-height: 116px;    border-radius: 6px;    }    .style_CMFrontEncryptedValidator-toast-loading__1Av04 .style_icn__2KezR {    display: inline-block;    width: 30px;    height: 30px;    margin: 27px 0 6px;    background: url("https://p3.music.126.net/C9tJEnwLhYm4dvTdsukD0g==/19106213556354168.jpg") no-repeat;    background-size: 30px 240px;    background-position: 0 0;    -webkit-animation: style_toastload__14ZuG 0.72s infinite step-start;    animation: style_toastload__14ZuG 0.72s infinite step-start;    }    .style_CMFrontEncryptedValidator-toast-loading__1Av04 .style_text__1FTZu {    line-height: 20px;    padding: 0 15px 10px;    }    .style_CMFrontEncryptedValidator-toast-iconmiddle__3H8C6 .style_icn__2KezR {    margin-top: 43px;    }    @keyframes style_toastload__14ZuG {    0% {    background-position-y: 0;    }    14.28% {    background-position-y: -30px;    }    28.56% {    background-position-y: -60px;    }    42.84% {    background-position-y: -90px;    }    57.12% {    background-position-y: -120px;    }    71.4% {    background-position-y: -150px;    }    85.68% {    background-position-y: -180px;    }    100% {    background-position-y: -210px;    }    }    @-webkit-keyframes style_toastload__14ZuG {    0% {    background-position-y: 0;    }    14.28% {    background-position-y: -30px;    }    28.56% {    background-position-y: -60px;    }    42.84% {    background-position-y: -90px;    }    57.12% {    background-position-y: -120px;    }    71.4% {    background-position-y: -150px;    }    85.68% {    background-position-y: -180px;    }    100% {    background-position-y: -210px;    }    }    </style>    <style type="text/css">    /* 还是需要定高点 */    .style_wrapper__1p8NA {    position: fixed;    top: 0;    left: 0;    right: 0;    bottom: 0;    -webkit-overflow-scrolling: touch;    z-index: 10002;    font-family: "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif;    }    .style_wrapper__1p8NA * {    -webkit-tap-highlight-color: transparent;    }    .style_wrapper__1p8NA .style_modalwrap__27JAU {    position: absolute;    top: 0;    left: 0;    right: 0;    bottom: 0;    opacity: 0.6;    background-color: #000;    }    .style_wrapper__1p8NA .style_body__3otNa {    position: absolute;    top: 50%;    left: 50%;    -webkit-transform: translate(-50%, -50%);    -ms-transform: translate(-50%, -50%);    transform: translate(-50%, -50%);    width: 100%;    max-width: 270px;    height: auto;    overflow: hidden;    background-color: #fff;    border-radius: 8px;    z-index: 1;    }    .style_wrapper__1p8NA .style_title__2QK1w,    .style_wrapper__1p8NA .style_content__1tas6 {    font-size: 18px;    padding: 15px 22px 0;    line-height: 1.2;    margin: 0;    }    .style_wrapper__1p8NA .style_title__2QK1w {    font-weight: 700;    }    .style_wrapper__1p8NA .style_content__1tas6 {    overflow: hidden;    height: 100%;    padding: 0 22px;    margin-top: 5px;    min-height: 40px;    font-size: 14px;    display: -webkit-box;    display: -ms-flexbox;    display: flex;    -webkit-box-pack: center;    -ms-flex-pack: center;    justify-content: center;    -webkit-box-align: center;    -ms-flex-align: center;    align-items: center;    }    .style_wrapper__1p8NA .style_footer__3VGqx {    overflow: hidden;    position: relative;    margin-top: 15px;    height: 44px;    min-height: 44px;    line-height: 1;    text-align: center;    }    .style_wrapper__1p8NA .style_footer__3VGqx::after {    content: " ";    position: absolute;    left: 0;    top: 0;    width: 200%;    -webkit-transform: scale(0.5);    -ms-transform: scale(0.5);    transform: scale(0.5);    -webkit-transform-origin: left top;    -ms-transform-origin: left top;    transform-origin: left top;    height: 1px;    background-color: #dbdbdb;    }    .style_wrapper__1p8NA .style_button__14tP8 {    cursor: pointer;    display: inline-block;    width: 50%;    height: 100%;    color: #0076ff;    font-size: 14px;    position: relative;    vertical-align: middle;    }    .style_wrapper__1p8NA .style_button__14tP8 .style_btntext__2s0cj {    position: absolute;    top: 50%;    left: 50%;    -webkit-transform: translate(-50%, -50%);    -ms-transform: translate(-50%, -50%);    transform: translate(-50%, -50%);    }    .style_wrapper__1p8NA .style_button__14tP8.style_cancel__v69gK::after {    content: " ";    position: absolute;    top: 0;    right: 0;    width: 1px;    height: 200%;    -webkit-transform: scale(0.5);    -ms-transform: scale(0.5);    transform: scale(0.5);    -webkit-transform-origin: left top;    -ms-transform-origin: left top;    transform-origin: left top;    background-color: #dbdbdb;    }    .style_wrapper__1p8NA.style_m-mobile__q2nA9 .style_body__3otNa,    .style_wrapper__1p8NA.style_m-app__3xype .style_body__3otNa {    max-width: 6.48148148em;    border-radius: 0.22222222em;    }    .style_wrapper__1p8NA.style_m-mobile__q2nA9 .style_title__2QK1w,    .style_wrapper__1p8NA.style_m-app__3xype .style_title__2QK1w {    font-size: 0.41666667em;    padding: 0.27777778em 0.2037037em 0.27777778em;    }    .style_wrapper__1p8NA.style_m-mobile__q2nA9 .style_content__1tas6,    .style_wrapper__1p8NA.style_m-app__3xype .style_content__1tas6 {    padding: 0.09259259em 0.37037037em;    min-height: 0.92592593em;    font-size: 0.37037037em;    text-align: center;    }    .style_wrapper__1p8NA.style_m-mobile__q2nA9 .style_footer__3VGqx,    .style_wrapper__1p8NA.style_m-app__3xype .style_footer__3VGqx {    margin-top: 0.46296296em;    height: 1.11111111em;    min-height: 1.11111111em;    line-height: 0em;    }    .style_wrapper__1p8NA.style_m-mobile__q2nA9 .style_button__14tP8,    .style_wrapper__1p8NA.style_m-app__3xype .style_button__14tP8 {    font-size: 0.33333333em;    }    @media screen and (-webkit-min-device-pixel-ratio: 3) {    .style_footer__3VGqx:after {    width: 300%;    }    .style_button__14tP8.style_cancel__v69gK:after,    .style_footer__3VGqx:after {    -webkit-transform: scale(0.33);    -ms-transform: scale(0.33);    transform: scale(0.33);    }    .style_button__14tP8.style_cancel__v69gK:after {    height: 300%;    }    }    </style>    <style type="text/css">    .style_loadingctn__3dRwX {    width: 100%;    height: 100%;    display: -webkit-box;    display: -ms-flexbox;    display: flex;    -webkit-box-align: center;    -ms-flex-align: center;    align-items: center;    -webkit-box-pack: center;    -ms-flex-pack: center;    justify-content: center;    }    .style_loadingctn__3dRwX .style_loading__1qz1r {    line-height: 0;    text-align: center;    }    .style_loadingctn__3dRwX .style_loadingimg__1pUq8 {    width: 18px;    height: 18px;    }    .style_loadingctn__3dRwX .style_icon__12G4j {    width: 30px;    height: 30px;    fill: #555;    margin: 0 auto;    }    .style_loadingctn__3dRwX .style_textwrapper__2XQ5y {    margin-top: 10px;    }    .style_loadingctn__3dRwX .style_text__1q5wH {    font-size: 13px;    color: #888;    text-indent: 6px;    }    .style_loadingctn__3dRwX .style_text__1q5wH.style_reloadMsg__3AV24 {    margin-top: 10px;    }    .style_loadingctn__3dRwX.style_m-mobile__33Sny .style_icon__12G4j,    .style_loadingctn__3dRwX.style_m-app__3H8c3 .style_icon__12G4j {    width: 0.55555556em;    height: 0.55555556em;    }    .style_loadingctn__3dRwX.style_m-mobile__33Sny .style_loadingimg__1pUq8,    .style_loadingctn__3dRwX.style_m-app__3H8c3 .style_loadingimg__1pUq8 {    width: 0.37037037em;    height: 0.37037037em;    }    .style_loadingctn__3dRwX.style_m-mobile__33Sny .style_textwrapper__2XQ5y,    .style_loadingctn__3dRwX.style_m-app__3H8c3 .style_textwrapper__2XQ5y {    margin-top: 0.18518519em;    }    .style_loadingctn__3dRwX.style_m-mobile__33Sny .style_text__1q5wH,    .style_loadingctn__3dRwX.style_m-app__3H8c3 .style_text__1q5wH {    font-size: 0.37037037em;    line-height: 1.3;    }    .style_loadingctn__3dRwX.style_m-mobile__33Sny .style_text__1q5wH.style_reloadMsg__3AV24,    .style_loadingctn__3dRwX.style_m-app__3H8c3 .style_text__1q5wH.style_reloadMsg__3AV24 {    margin-top: 0.18518519em;    }    </style>    <style type="text/css">    /* 还是需要定高点 */    /* 透明遮罩层，防止用户可以操作 */    .style_validatorwrapper__2pnes {    position: fixed;    top: 0;    left: 0;    width: 100%;    height: 100%;    z-index: 10000;    }    .style_validatorwrapper__2pnes.style_m-mobile__3Zrin,    .style_validatorwrapper__2pnes.style_m-app__RzjAe {    background-color: rgba(0, 0, 0, 0.6);    }    .style_closebtn__2wfqf {    position: absolute;    top: 0;    width: 40px;    height: 40px;    cursor: pointer;    fill: #000;    text-align: left;    }    .style_closebtn__2wfqf.style_m-other__2v8MD {    left: 0;    }    .style_closebtn__2wfqf.style_m-pc__2Z_0E {    right: 6px;    }    .style_closebtn__2wfqf svg {    position: relative;    top: 19px;    left: 19px;    }    .style_closeIcon__1OXT- {    width: 12px !important;    height: 10px !important;    }    .style_validatorctn__3qGia.style_m-web__ZI-DV {    position: fixed;    top: 50%;    left: 50%;    -webkit-transform: translate(-50%, -50%);    -ms-transform: translate(-50%, -50%);    transform: translate(-50%, -50%);    width: 380px;    min-height: 400px;    background: #FFFFFF;    border: 1px solid rgba(0, 0, 0, 0.08);    -webkit-box-shadow: 0 2px 24px 0 rgba(0, 0, 0, 0.2);    box-shadow: 0 2px 24px 0 rgba(0, 0, 0, 0.2);    border-radius: 15px;    padding: 30px;    text-align: center;    z-index: 10001;    }    .style_validatorctn__3qGia.style_m-desktop__3naM9 {    width: 300px;    min-height: 350px;    }    .style_validatorctn__3qGia.style_m-mobile__3Zrin,    .style_validatorctn__3qGia.style_m-app__RzjAe {    position: fixed;    top: 50%;    left: 50%;    -webkit-transform: translate(-50%, -50%);    -ms-transform: translate(-50%, -50%);    transform: translate(-50%, -50%);    width: 80%;    min-height: 8.50925926em;    background: #FFFFFF;    border: 1px solid rgba(0, 0, 0, 0.08);    border: 0.01851852em solid rgba(0, 0, 0, 0.08);    -webkit-box-shadow: 0 2px 24px 0 rgba(0, 0, 0, 0.2);    box-shadow: 0 2px 24px 0 rgba(0, 0, 0, 0.2);    border-radius: 0.41666667em;    padding: 0.0462963em;    text-align: center;    z-index: 10001;    padding-bottom: 1em;    }    .style_validatorctn__3qGia.style_m-mobile__3Zrin .style_closebtn__2wfqf,    .style_validatorctn__3qGia.style_m-app__RzjAe .style_closebtn__2wfqf {    width: 0.86111111em;    height: 0.86111111em;    bottom: -2.13888889em;    -webkit-transform: translateX(-50%);    -ms-transform: translateX(-50%);    transform: translateX(-50%);    left: 50%;    top: auto;    line-height: 1;    }    .style_validatorctn__3qGia.style_m-mobile__3Zrin .style_closebtn__2wfqf svg,    .style_validatorctn__3qGia.style_m-app__RzjAe .style_closebtn__2wfqf svg {    top: 0;    left: 0;    width: 100%;    height: 100%;    }    </style>    <style type="text/css">    .style_sliderctn__PyyvO {    width: 100%;    height: 100%;    }    .style_sliderctn__PyyvO.style_hide__11z8Y {    display: none;    }    .style_sliderctn__PyyvO .style_title__KfPiP {    font-size: 22px;    color: #333333;    margin: 20px auto 40px;    font-weight: 500;    }    .style_sliderctn__PyyvO .style_loadingwrapper__1aVK6 {    width: 100%;    height: 340px;    }    .style_sliderctn__PyyvO.style_m-mobile__3VJvw,    .style_sliderctn__PyyvO.style_m-app__2ZKer {    width: 90%;    height: 100%;    margin: 0 auto;    }    .style_sliderctn__PyyvO.style_m-mobile__3VJvw .style_title__KfPiP,    .style_sliderctn__PyyvO.style_m-app__2ZKer .style_title__KfPiP {    font-size: 0.46296296em;    margin-top: 1.03703704em;    margin-bottom: 0.55555556em;    line-height: 1.1;    }    .style_sliderctn__PyyvO.style_m-mobile__3VJvw .style_loadingwrapper__1aVK6,    .style_sliderctn__PyyvO.style_m-app__2ZKer .style_loadingwrapper__1aVK6 {    height: 7.50925926em;    }    .style_sliderctn__PyyvO.style_m-app__2ZKer {    width: 85%;    }    .style_sliderctn__PyyvO.style_validatePage__ysWZB .style_loadingwrapper__1aVK6 {    height: 100%;    }    </style>    <style type="text/css">    .style_qrcodectn__GLxAI {    width: 100%;    height: 100%;    }    .style_qrcodectn__GLxAI p {    margin: 0;    }    .style_qrcodectn__GLxAI .style_loadingwrapper__3TSVs {    width: 100%;    height: 340px;    }    .style_qrcodectn__GLxAI .style_title__3gz0o {    font-size: 22px;    color: #333333;    font-weight: 500;    margin: 20px auto 35px;    }    .style_qrcodectn__GLxAI .style_text__aQImb {    color: #fff;    margin: 0;    }    .style_qrcodectn__GLxAI .style_btn__1I6TE {    background: #FF3A3A;    border-radius: 20px;    margin: 0 auto;    color: #fff;    font-size: 14px;    cursor: pointer;    }    .style_qrcodectn__GLxAI .style_qrcode__2d7dF {    position: relative;    margin: 0 auto;    width: 170px;    height: 170px;    }    .style_qrcodectn__GLxAI .style_qrcode__2d7dF .style_loadingctn__2VyDG {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;    z-index: 1;    background-color: #fff;    }    .style_qrcodectn__GLxAI img {    display: inline-block;    width: auto;    max-width: 100%;    height: 100%;    }    .style_qrcodectn__GLxAI .style_expired__JErG6 {    position: relative;    width: 100%;    height: 100%;    text-align: center;    }    .style_qrcodectn__GLxAI .style_expired__JErG6 .style_expiredwrapper__2Rr5A {    width: 100%;    height: 100%;    background-image: url('data:image/gif;base64,R0lGODdhcABwAIAAAAAAAP///ywAAAAAcABwAAAC/4yPqcvtD6OctNqLs968+w+G4kiW5olCwMq27gsj8Awwrczi9B4//O/SAW25w80ITKqSQ6RycTREA8ymo/oTZqFFaZeK3S1XmOk46PuaJ2tFO/Imvs7C8ldeu8S58zTZmWex5/UneOeHdqV2KDEIVvhIU8cXGDnptgi5RViJp9XD6Ql4mTBlykMqyjmTOuoaSkm6aYn42QeLqZnZ+Uq7CurbcCrWizfMq6hLjCu8y1pMeUxx/MysGlkdbLw77QzsSP3NWCoOSQeYDe59qx1djkyuLAmdWzmrvtxeb5uoH2+Pit6/dONkBbQWC927MwTNJfzFDh+8c/t6vZGmp6BAiv//DDpk5uiaSDbjMCIEqTHZxI21Hga7yC3jx4Fh+pl8GRNizZn8dnoEKO/nTolDc+IMarFov21FfzpNqjRliWz8qqa4SlWhvJBXO2TVabXria/Y1q000dBmybVb2Z5txlMrULUzYbatK3VkvXBIK/otizeuSoZmW508upTlYEQ3bxoGbAXyLMJ9EeuVfBBzPspzn/7tmdknyYhG7cITrXOyzHmHTfOdq/owZ8cC074my3XvQpdhIYNm93i20ce2zeLOKze3P463a3bb3NJQ5ajKY8N9e615mOes4SD/qx2LnXzhuTPFrvh62t/oWwPjyH198u/+yF4WPj0zfLnmGRf/5g0VbMPVRl9xgZ1W2m6fpdfbcQcKNaB7gtF0F4IPBkibhO35xh+BE1YB4RMqvUacVCBiyARnDbqFH10Ciqjefxq22Jhz0dXnlnzgJUjahxHiSB6LAa7oY2UlBnkhShUGNySAqf1Y45LpmXafO0iK12EjQi44Ymg2gjWahWLG5+V2WXqXZEdh3vMlh2JxaZmTaoL55px2UnmjfV3hOWOe79UJZGdyhrghdTn+6NlyUxoqZoZ3IrqooecxqaSgi3XZlJWWXpdolbLdyNyWnH6gHKWPpulpBaUy2CScpvYnXaFQmkhfqFcSSuiJuhX5oou4omjmrm+V16qbiKFG4bDGnPHYa64pamprd1H2aqCswLnEZn4VVksmr+wlGh6Ja9K6LbPO9pgYpsqWa+R82m7Knp6V6pjstEdiealm8Lq7qaPIZldmowrGKax1r2J76LU7oiuvovm69ufCLja8aqXnSURkd6kCfCDFMupL47N0gowwqpFSl7GD+/apLrLV8hloqow2yy/HYw4KaM4678xzzz7/DHTQQg9NNAkFAAA7');    background-position: center;    background-repeat: no-repeat;    background-size: cover;    text-align: center;    -webkit-filter: blur(3px);    /* Chrome, Opera */    -moz-filter: blur(3px);    -ms-filter: blur(3px);    filter: blur(3px);    }    .style_qrcodectn__GLxAI .style_expiremsg__1-GKI {    position: absolute;    top: 50px;    font-size: 18px;    color: #FFFFFF;    width: 100%;    margin: 0;    }    .style_qrcodectn__GLxAI .style_expirebtn__3rk3b {    position: absolute;    bottom: 50px;    left: 45px;    width: 80px;    height: 32px;    line-height: 32px;    }    .style_qrcodectn__GLxAI .style_float__1u9XQ {    position: absolute;    width: 100%;    height: 100%;    color: #000;    top: 50%;    left: 50%;    -webkit-transform: translate(-50%, -50%);    -ms-transform: translate(-50%, -50%);    transform: translate(-50%, -50%);    border: 1px solid #ccc;    }    .style_qrcodectn__GLxAI .style_footer__3SDFM {    margin: 20px 33px 0;    font-size: 14px;    color: #666;    }    .style_qrcodectn__GLxAI .style_music163__1xS-J {    color: #3072a5;    }    .style_qrcodectn__GLxAI .style_failbtn__2Hp0l {    margin-top: 40px;    width: 220px;    height: 40px;    line-height: 40px;    }    .style_qrcodectn__GLxAI.style_m-mobile__wxNWK,    .style_qrcodectn__GLxAI.style_m-app__2MG6Q {    width: 90%;    margin: 0 auto;    }    .style_qrcodectn__GLxAI.style_m-mobile__wxNWK .style_loadingwrapper__3TSVs,    .style_qrcodectn__GLxAI.style_m-app__2MG6Q .style_loadingwrapper__3TSVs {    height: 7.32407407em;    }    .style_qrcodectn__GLxAI.style_m-mobile__wxNWK .style_title__3gz0o,    .style_qrcodectn__GLxAI.style_m-app__2MG6Q .style_title__3gz0o {    font-size: 0.46296296em;    margin-top: 1.03703704em;    margin-bottom: 0.55555556em;    line-height: 1.1;    }    .style_qrcodectn__GLxAI.style_m-mobile__wxNWK .style_qrcode__2d7dF,    .style_qrcodectn__GLxAI.style_m-app__2MG6Q .style_qrcode__2d7dF {    width: 3.62962963em;    height: 3.62962963em;    }    .style_qrcodectn__GLxAI.style_m-mobile__wxNWK .style_footer__3SDFM,    .style_qrcodectn__GLxAI.style_m-app__2MG6Q .style_footer__3SDFM {    margin: 0.37037037em 0.30555556em 0em;    font-size: 0.37037037em;    color: #666;    }    .style_qrcodectn__GLxAI.style_m-mobile__wxNWK .style_expiremsg__1-GKI,    .style_qrcodectn__GLxAI.style_m-app__2MG6Q .style_expiremsg__1-GKI {    font-size: 0.55555556em;    top: 1.57407407em;    }    .style_qrcodectn__GLxAI.style_m-mobile__wxNWK .style_expirebtn__3rk3b,    .style_qrcodectn__GLxAI.style_m-app__2MG6Q .style_expirebtn__3rk3b {    width: 2.40740741em;    font-size: 0.41666667em;    top: 2.77777778em;    left: 1.15740741em;    height: 0.83333333em;    line-height: 0.83333333em;    }    </style>    <style type="text/css">    .captcha_captcha-ctn__NUoZl {    position: fixed;    top: 0;    right: 0;    bottom: 0;    left: 0;    background-color: #fff;    }    .captcha_captcha-ctn__NUoZl .captcha_tip__eTYs0 {    padding: 0.36111111em 0.44444444em;    background: #fffbe5;    color: #333;    font-size: 0.30555556em;    }    .captcha_captcha-ctn__NUoZl .captcha_phone-number__1rQy2 {    display: -webkit-box;    display: -ms-flexbox;    display: flex;    -webkit-box-pack: justify;    -ms-flex-pack: justify;    justify-content: space-between;    margin: 0.83333333em 0.55555556em 1.38888889em 0.44444444em;    }    .captcha_captcha-ctn__NUoZl .captcha_phone-number__1rQy2 .captcha_left__3yxAc {    text-align: left;    }    .captcha_captcha-ctn__NUoZl .captcha_phone-number__1rQy2 .captcha_left__3yxAc .captcha_title__1Ip4l {    margin-bottom: 0.27777778em;    color: #333;    font-weight: 500;    font-size: 0.47222222em;    }    .captcha_captcha-ctn__NUoZl .captcha_phone-number__1rQy2 .captcha_left__3yxAc .captcha_number__12Mfe {    color: #999;    font-size: 0.41666667em;    }    .captcha_captcha-ctn__NUoZl .captcha_phone-number__1rQy2 .captcha_right__2sN2h {    display: -webkit-box;    display: -ms-flexbox;    display: flex;    -webkit-box-align: center;    -ms-flex-align: center;    align-items: center;    }    .captcha_captcha-ctn__NUoZl .captcha_phone-number__1rQy2 .captcha_right__2sN2h .captcha_text__3c8PN {    color: #333;    font-size: 0.33333333em;    }    .captcha_captcha-ctn__NUoZl .captcha_phone-number__1rQy2 .captcha_right__2sN2h .captcha_send__3Uy5f {    border: 1px solid rgba(0, 0, 0, 0.1);    border-width: 0.02777778em;    border-radius: 0.33333333em;    width: 1.83333333em;    padding: 0.16666667em 0em;    text-align: center;    }    .captcha_captcha-ctn__NUoZl .captcha_phone-number__1rQy2 .captcha_right__2sN2h .captcha_senderr__2c5hn {    padding: 2px 10px;    color: #ff2525;    font-size: 12px;    }    .captcha_captcha-ctn__NUoZl .captcha_phone-number__1rQy2 .captcha_right__2sN2h.captcha_count__1fID4 {    -webkit-box-align: end;    -ms-flex-align: end;    align-items: flex-end;    }    .captcha_captcha-ctn__NUoZl .captcha_phone-number__1rQy2 .captcha_right__2sN2h.captcha_count__1fID4 .captcha_count-down__3hapC {    font-size: 0.41666667em;    color: #999;    }    .captcha_captcha-ctn__NUoZl .captcha_capthca__sMVz3 {    margin: 0em 1.38888889em 0em 1.38888889em;    display: -webkit-box;    display: -ms-flexbox;    display: flex;    -webkit-box-pack: justify;    -ms-flex-pack: justify;    justify-content: space-between;    height: 0.83333333em;    }    .captcha_captcha-ctn__NUoZl .captcha_capthca__sMVz3 .captcha_code__1lUWS {    position: relative;    width: 1.38888889em;    text-align: center;    font-size: 0.55555556em;    }    .captcha_captcha-ctn__NUoZl .captcha_capthca__sMVz3 .captcha_code__1lUWS::after {    /* 用图片方式 */    content: ' ';    position: absolute;    left: 0;    top: 100%;    width: 100%;    height: 1px;    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAECAYAAABP2FU6AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAB5JREFUeNpiPnH8zH/GMzAxAAHTyRNn/wMEGABpvQm9g9TJ1QAAAABJRU5ErkJggg==");    background-repeat: repeat-x;    z-index: 0;    }    .captcha_captcha-ctn__NUoZl .captcha_capthca__sMVz3 .captcha_code__1lUWS.captcha_focus__1X-Sd {    color: #333;    }    .captcha_captcha-ctn__NUoZl .captcha_capthca__sMVz3 .captcha_code__1lUWS.captcha_focus__1X-Sd::after {    /* 用图片方式 */    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVR4nGNiAAAABgADNjd8qAAAAABJRU5ErkJggg==");    }    .captcha_captcha-ctn__NUoZl .captcha_deprecated__UtPL6 {    text-align: center;    margin-top: 0.55555556em;    color: #999;    font-size: 0.36111111em;    }    .captcha_captcha-ctn__NUoZl .captcha_deprecated__UtPL6 .captcha_arrow__T6Cm4 {    display: inline-block;    -ms-flex-negative: 0;    flex-shrink: 0;    margin-left: 0.11111111em;    width: 0.14814815em;    height: 0.25em;    background: url(https://p1.music.126.net/bZcc9l_4cd6cKSRHkJQx5w==/109951164367908552.png);    background-size: contain;    background-repeat: no-repeat;    }    .captcha_captcha-ctn__NUoZl .captcha_shadow-input__3rgUL {    position: absolute;    top: -9999px;    left: 0;    z-index: -1;    -webkit-tap-highlight-color: transparent;    }    </style>    <style type="text/css">    /* 存放验证器全局样式 */    /* 验证器根容器 */    .global_container__10fOb * {    -webkit-box-sizing: border-box;    box-sizing: border-box;    font-family: "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif;    }    </style>    <style>.mrc-modal {    position: absolute;    z-index: 1000;    display: none;    }    .mrc-modal-visbh {    position: absolute;    z-index: 1000;    visibility: hidden;    }    .mrc-modal-visbs {    visibility: visible;    }    .mrc-modal-mask {    position: fixed;    top: 0;    right: 0;    left: 0;    bottom: 0;    background-color: rgba(0, 0, 0, 0.65);    }    .mrc-modal-wrapper {    position: fixed;    top: 0;    left: 0;    right: 0;    bottom: 0;    display: -webkit-box;    display: -webkit-flex;    display: flex;    -webkit-overflow-scrolling: touch;    pointer-events: none;    }    .mrc-modal-wrapper.mrc-modal-center {    -webkit-box-pack: center;    -webkit-justify-content: center;    justify-content: center;    -webkit-box-align: center;    -webkit-align-items: center;    align-items: center;    }    .mrc-modal-wrapper.mrc-modal-center .mrc-modal-container {    position: relative;    }    .mrc-modal-container {    position: absolute;    background: #fff;    pointer-events: auto;    }    .mrc-modal-container .mrc-header {    position: relative;    }    .mrc-modal-show {    display: block;    }    .mrc-modal-enter,    .mrc-modal-appear {    opacity: 0;    }    .mrc-modal-enter-active,    .mrc-modal-appear-active {    opacity: 1;    -webkit-transition: all 200ms ease-out;    transition: all 200ms ease-out;    }    .mrc-modal-enter-done,    .mrc-modal-exit {    opacity: 1;    }    .mrc-modal-exit-active {    opacity: 0;    -webkit-transition: all 200ms ease-out;    transition: all 200ms ease-out;    }    .mrc-modal-parent-overflow-hidden {    position: fixed;    top: 0;    left: 0;    height: 100%;    width: 100%;    z-index: 1002;    }    </style>  </head>  <body>    <div id="player" style="width: 845px; height: 763px;">      <div class="player player-mid f-cb f-pr">        <div class="cover cover-sm f-pr">          <img id="cover" src="https://p2.music.126.net/Rgsivbj0lv8yrtGHZkMfCg==/2324367581182373.jpg?param=90y90">          <div class="mask"></div>          <div id="play" class="bg play-bg" data-action="play"></div>          <div id="pause" class="bg pause-bg f-hide" data-action="pause"></div>        </div>        <div id="mid-ctrl" class="ctrlBox" style="width: 759px;">          <h2 class="f-pr"><i data-action="home" class="bg logo"></i>          <div id="title" class="title" style="width: 735px;">Do no wrong<span class="sub"> - Thirteen Senses</span></div>          </h2>          <div id="bar" class="bar" style="width: 715px;">            <div class="played j-flag" style="width: 0%;"><span class="bg thumb j-flag" id="auto-id-uDsgaK9AiRXiVkqr"></span></div>          </div>        </div>        <span id="time" class="time">- 00:00</span>      </div>    </div>    <script src="https://s3.music.126.net/web/s/core_050407d65d5815ae2bd931706e05cb10.js?050407d65d5815ae2bd931706e05cb10" type="text/javascript"></script>    <!-- <script type="text/javascript" src="https://acstatic-dun.126.net/tool.min.js"></script> -->    <!-- <script src="https://s3.music.126.net/web/s/pt_outchain_player_5ac7386907c00670759c2f7d4755765c.js?5ac7386907c00670759c2f7d4755765c" type="text/javascript"></script> -->    <script type="text/javascript">    var _gaq = _gaq || [];    _gaq.push(['_setAccount', 'UA-38766552-1'], ['_setLocalGifPath', '/UA-38766552-1/__utm.gif'], ['_setLocalRemoteServerMode']);    _gaq.push(['_trackPageview']);    //fix ipad下的一个bug    if (navigator.userAgent.indexOf('iPad') != -1) {    iframeHeight = Math.max(    Math.max(document.body.scrollHeight, document.documentElement.scrollHeight),    Math.max(document.body.offsetHeight, document.documentElement.offsetHeight),    Math.max(document.body.clientHeight, document.documentElement.clientHeight)    );    top.document.body.style.height = iframeHeight + 20 + 'px';    }    </script>    <div></div>    <div></div>    <div class="global_container__10fOb"></div>  </body>  <div style="all: initial;">    <div id="__hcfy__" style="all: initial;"></div>  </div></html>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>Gallery</title>
      <link href="/gallery/index.html"/>
      <url>/gallery/index.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css">]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>About Me</title>
      <link href="/about/index.html"/>
      <url>/about/index.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><p>目前的博客框架是<a href="https://hexo.io/">Hexo</a>,  主题是<a href="https://github.com/viosey/hexo-theme-material">Material</a> <del>(魔改)</del>，Markdown编辑器是<a href="https://www.typora.io/">Typora</a> .</p><h2 id="我的称呼"><a href="#我的称呼" class="headerlink" title="我的称呼"></a>我的称呼</h2><p><strong>XJUNZ</strong>  ( 读作: <em>&#x2F;eksdʒʌnz&#x2F;</em> )</p><h2 id="我来自"><a href="#我来自" class="headerlink" title="我来自"></a>我来自</h2><p>浙江</p><h2 id="年龄"><a href="#年龄" class="headerlink" title="年龄"></a>年龄</h2><p>95后  狮子座</p><h2 id="爱好"><a href="#爱好" class="headerlink" title="爱好"></a>爱好</h2><p>自由、和平以及一切美好的事物</p><h2 id="特长"><a href="#特长" class="headerlink" title="特长"></a>特长</h2><p><em>（不是每个人都有特长的啦~）</em></p><h2 id="联系到我"><a href="#联系到我" class="headerlink" title="联系到我"></a>联系到我</h2><p><strong>Telegram</strong>: <a href="https://t.me/xjunz">xjunz</a></p>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>Tagcloud</title>
      <link href="/tagcloud/index.html"/>
      <url>/tagcloud/index.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css">]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>Timeline</title>
      <link href="/timeline/index.html"/>
      <url>/timeline/index.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css">]]></content>
      
    </entry>
    
    
  
</search>
