<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <meta name="google-site-verification" content="Is5NCRh3gMI3ic8PKbNsXzLtoQu1b2ywfIoPhkv3JYA" />
    <!--
        © Material Theme
        https://github.com/bollnh/hexo-theme-material
        Version: 1.5.6 -->
    <script>
        window.materialVersion = "1.5.6"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0',
            '1.5.2',
            '1.5.5'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">



    <link rel="dns-prefetch" href="https://busuanzi.ibruce.info"/>



    <link rel="dns-prefetch" href="https://www-xjunz-top.disqus.com"/>





    <link rel="dns-prefetch" href="https://fonts.googleapis.com"/>





    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            使用Ktor Server部署无人值守免签收款系统 | 
        
        Me, xjunz&#39;s blog
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.svg">
    <link rel="icon" href="/img/favicon.svg">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="xjunz&#39;s blog">
    <meta name="keywords" content="">
    <meta name="theme-color" content="#ffc3ac">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?uVzgA6RLrOm13Ukw8Qgy+A==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        
            
                <style id="prettify_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_css","/css/prettify.min.css?zp8STOU9v89XWFEnN+6YmQ==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
                <style id="prettify_theme"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_theme","/css/prettify/github-v2.min.css?AfzKxt++K+/lhZBlSjnxwg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
            
        

    
    <style id="xjunz-mod_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("xjunz-mod_css","/css/xjunz-mod.css?sDj92AsaMRZVywCdU5S2Og==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Noto Serif SC, Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "微软雅黑", "Microsoft YaHei", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    letter-spacing: .0em !important;
  }

  a {
    color: #ff4e58;
    letter-spacing: .1em;
  }

  p.article-headline-p{
   font-family: Roboto !important;
  }

  p {
    letter-spacing: .15em;
    font-family: Noto Serif SC !important;
  }

  div {
    letter-spacing: .15em;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #ff4e58 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #ff4e58 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #ff4e58 !important;
  }

  .toTop {
    background: #ff4e58 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #ff4e58;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #ff4e58;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #ff4e58;
  }

  .post-toc a:hover {
    color: #ff4e58;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body {
        background-color: #faf2f1;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text {
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <!-- "https://fonts.googleapis.com/css?family=Roboto:300,400,500" -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap" rel="stylesheet">




<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?ezyEvm8ST5CGfpA+kFFi1g==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Me, xjunz&#39;s blog">
    <meta name="msapplication-starturl" content="http://www.xjunz.top/post/payment-backends-with-ktor-server/">
    <meta name="msapplication-navbutton-color" content="#ffc3ac">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Me, xjunz&#39;s blog">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.svg">

    <!-- Site Verification -->
    <meta name="google-site-verification" content="Is5NCRh3gMI3ic8PKbNsXzLtoQu1b2ywfIoPhkv3JYA" />
    

    <!-- RSS -->
    
        
            <link rel=alternate type="application/atom+xml" href="atom.xml">
        
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://www.xjunz.top/post/payment-backends-with-ktor-server/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="使用Ktor Server部署无人值守免签收款系统 | Me, xjunz&#39;s blog">
    <meta property="og:image" content="/img/favicon.svg">
    <meta property="og:description" content="xjunz&#39;s blog">
    

    
        <meta property="article:published_time" content="Fri Sep 16 2022 05:33:57 GMT+0800">
        <meta property="article:modified_time" content="Sat Sep 16 2023 05:33:57 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://www.xjunz.top/post/payment-backends-with-ktor-server/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://www.xjunz.top/post/payment-backends-with-ktor-server/index.html",
    "headline": "使用Ktor Server部署无人值守免签收款系统",
    "datePublished": "Fri Sep 16 2022 05:33:57 GMT+0800",
    "dateModified": "Sat Sep 16 2023 05:33:57 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "xjunz",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.webp"
        },
        "description": ""
    },
    "publisher": {
        "@type": "Organization",
        "name": "Me, xjunz&#39;s blog",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.svg"
        }
    },
    "keywords": "",
    "description": "xjunz&#39;s blog",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head -->
    
        
            
        
    
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="/custom_css_source.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span id="MD-burger-id" class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E4%BD%BF%E7%94%A8Ktor-Server%E9%83%A8%E7%BD%B2%E6%97%A0%E4%BA%BA%E5%80%BC%E5%AE%88%E5%85%8D%E7%AD%BE%E6%94%B6%E6%AC%BE%E7%B3%BB%E7%BB%9F"><span class="post-toc-text">使用Ktor Server部署无人值守免签收款系统</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%9C%80%E6%B1%82"><span class="post-toc-text">需求</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">实现</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BC%98%E5%8A%A3%E5%88%86%E6%9E%90"><span class="post-toc-text">优劣分析</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">服务端实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BD%BF%E7%94%A8Ktor-Server"><span class="post-toc-text">使用Ktor Server</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%9C%A8%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E6%90%AD%E5%BB%BAPostgres%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="post-toc-text">在云服务器上搭建Postgres数据库</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%88%B0Postgres%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="post-toc-text">连接到Postgres数据库</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2pgAdmin4"><span class="post-toc-text">部署pgAdmin4</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BD%BF%E7%94%A8Exposed%E6%A1%86%E6%9E%B6%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="post-toc-text">使用Exposed框架进行数据库操作</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AE%9A%E4%B9%89%E8%AE%A2%E5%8D%95%E8%A1%A8"><span class="post-toc-text">定义订单表</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AE%9A%E4%B9%89DTO"><span class="post-toc-text">定义DTO</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AE%9A%E4%B9%89DAO"><span class="post-toc-text">定义DAO</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82"><span class="post-toc-text">处理请求</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%B5%8B%E8%AF%95"><span class="post-toc-text">本地测试</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2%E7%A8%8B%E5%BA%8F%E5%88%B0%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="post-toc-text">部署程序到云服务器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%89%93%E5%8C%85"><span class="post-toc-text">打包</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%89%8B%E5%8A%A8%E9%83%A8%E7%BD%B2"><span class="post-toc-text">手动部署</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2"><span class="post-toc-text">自动部署</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%89%E5%85%A8%E7%BB%84%E8%A7%84%E5%88%99"><span class="post-toc-text">安全组规则</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Android%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="post-toc-text">Android客户端</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%9B%91%E5%90%AC%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5"><span class="post-toc-text">监听系统通知</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%A4%84%E7%90%86%E9%80%9A%E7%9F%A5"><span class="post-toc-text">处理通知</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E6%80%BB%E7%BB%93"><span class="post-toc-text">业务逻辑总结</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%80%BB%E7%BB%93"><span class="post-toc-text">总结</span></a></li></ol></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        <!-- Custom Thumbnail -->
        <div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(/post/payment-backends-with-ktor-server/thumbnail.webp)">
    
            <p class="article-headline-p">
                使用Ktor Server部署无人值守免签收款系统
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.webp" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>xjunz</strong>
        <span>9月 16, 2022</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    
        <button id="article-functions-qrcode-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">devices other</i>
    <span class="visuallyhidden">devices other</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-qrcode-button">
    <li class="mdl-menu__item">在其它设备中阅读本文章</li>
    
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAAC1klEQVR42u3ay27bMBAFUP//T7fbAqnle4dKqpKHK0ORLB4GyGQer19Hrhc2NjY2NjY2Njb2I9mveP3li75c//PKu8/Xb/96/d23tXvGxsbG3pv94U//5T3X+OuncnByiB92hY2NjX0A+3or1/dfh5aVI2uDGTY2NjZ2zk42l+Bnh4uNjY2NvcJuy0krB9p+PzY2NvbJ7PyVOaYNe8lx/INaGjY2Nvbj2XnT9Dmff7S/jY2Njf1gdrtWRnnahm4btD7sHBsbG3tTdptmtKX/lVQnP/roKWxsbOxN2W3omoWrtlR01+AONjY29gnsPElIwskszLSN4Ty4YmNjY5/GbpOKZHNtKyI/3LqwhY2Njb01O0k2VsY028bALIDV/W1sbGzs7djr+DbNWGkDt61fbGxs7L3ZCTUv7rdX8qSl/Sk2Njb2Cey23H9DSnDTYFBeTsLGxsbemz0br0lC3aydkBzKbHAHGxsbe2/2bAhyNsqTBMW8zbwUwLCxsbG3ZrdF/3ZDbcKz8hQ2Njb23uxZS2CWNqyEpTZBwsbGxj6TPSvc5OObbUFqVoR6+xZsbGzsTdmzok+bqHxHepP8krCxsbFPYOfbTco6+VZmY51LO8TGxsbelN0W9+/lrbeZsbGxsbGTQZx2+HKW6iThcAbGxsbG3pvdBqR2i+04ThK68jEdbGxs7HPYs3/3Zy2BvDHctntvyMCwsbGxt2DPhmySlCYZ+skTpDx0YWNjY5/Dbhl5cJqN46wvbGxs7BPY7crDz8qQzb1BDhsbG3tv9iwYtOFnFtLyZ6OyFzY2NvbW7CRozVKXvGh173DPsJaGjY2N/Z+z88CTYL6vVDRsRWNjY2Njx43VNpnJW85L6Q02NjY2dnx/njDMmr55AwMbGxv7NPZ6aEkCSbLF/MiKohU2Njb21uy2WDNr/bZjPe0AUDF8iY2Njb0R+5yFjY2NjY2NjY2N/Zj1GwFTpLcw/HS8AAAAAElFTkSuQmCC">
    
</ul>

    

    <!-- Tags (bookmark) -->
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    
        
            <!-- Busuanzi Views -->
            <a class="post_share-link" href="#">
                <li class="mdl-menu__item">
                    <span id="busuanzi_container_page_pv">
                        <span id="busuanzi_value_page_pv"></span>&nbsp;浏览量
                    </span>
                </li>
            </a>
        
    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=使用Ktor Server部署无人值守免签收款系统&url=http://www.xjunz.top/post/payment-backends-with-ktor-server/index.html&pic=http://www.xjunz.top/img/favicon.svg&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=使用Ktor Server部署无人值守免签收款系统&url=http://www.xjunz.top/post/payment-backends-with-ktor-server/index.html&via=xjunz" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://www.xjunz.top/post/payment-backends-with-ktor-server/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=Me, xjunz&#39;s blog&title=使用Ktor Server部署无人值守免签收款系统&summary=xjunz&#39;s blog&pics=http://www.xjunz.top/img/favicon.svg&url=http://www.xjunz.top/post/payment-backends-with-ktor-server/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
        <a class="post_share-link" href="https://telegram.me/share/url?url=http://www.xjunz.top/post/payment-backends-with-ktor-server/index.html&text=使用Ktor Server部署无人值守免签收款系统" target="_blank">
            <li class="mdl-menu__item">
                分享到 Telegram
            </li>
        </a>
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
            
         <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="使用Ktor-Server部署无人值守免签收款系统"><a href="#使用Ktor-Server部署无人值守免签收款系统" class="headerlink" title="使用Ktor Server部署无人值守免签收款系统"></a>使用Ktor Server部署无人值守免签收款系统</h1><blockquote>
<p>本文可能出现错误和疏漏，欢迎批评斧正</p>
</blockquote>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>构建一个无人值守的免签支付宝收款系统，采用的技术栈为Ktor Server后端 + Postgres数据库 + Android客户端。所谓无人值守，即该系统不需要开发者手动操作便能完成整套的收款流程，所谓免签指的是不利用官方的收款平台或者任何第三方收款平台进行收款。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>我们的思路是，使用Ktor Server处理客户端请求和业务逻辑，使用Postgres数据库储存用户信息和订单信息，使用Android客户端接收收款并上报服务端。</p>
<p>其中有一个关键逻辑在于，如何使用客户端区分不同用户的收款而无需入侵支付宝本身。我们采用的方法为，使用收款金额区分。假如我们允许商品的价格随机折扣0至1元，而收款金额的粒度为“分”。也就是说，仅至多1元的折扣，就可以区分100个不同的订单。订单并不是瞬间失效的，我们需要给予用户充足的时间用于付款，假设订单的有效时长是5分钟，那就意味着，5分钟内允许100个不同的订单，即该系统最多能处理平均3秒一个订单，当然折扣额度和订单有效时间存在竞争关系，如何制定取决于你对订单有效时间和订单折扣之间的取舍。</p>
<p>还有一个需要解决的问题是，如何在客户端上即时获取支付宝的收款信息。这很简单，我们只需要开启收款提醒助手，这就是你在商店使用支付宝付款时经常会听到的“支付宝已到账XXX元”的语音提示所采用的服务。因为此服务涉及到广大商户的切实利益，它被设计得非常可靠和即时，而这正是我们所需要的。</p>
<h2 id="优劣分析"><a href="#优劣分析" class="headerlink" title="优劣分析"></a>优劣分析</h2><ul>
<li>优势</li>
</ul>
<p>不需要任何资质</p>
<p>不需要支付任何中间费用</p>
<p>接入简单</p>
<ul>
<li>劣势</li>
</ul>
<p>需要收款客户端保持在线</p>
<p>要用折扣来区分订单</p>
<p>需要开发者自己的云服务器</p>
<p>接口容易受到攻击</p>
<h2 id="服务端实现"><a href="#服务端实现" class="headerlink" title="服务端实现"></a>服务端实现</h2><h3 id="使用Ktor-Server"><a href="#使用Ktor-Server" class="headerlink" title="使用Ktor Server"></a>使用Ktor Server</h3><blockquote>
<p>Ktor是Kotlin官方推出的网络请求库，同时支持后端和客户端乃至前端，其健壮性和可维护性都有官方背书。更为重要的是，对于Android开发者而言，我们不需要额外学习新的语言，就能以较低的准入门槛使用Ktor。官方网站：<a target="_blank" rel="noopener" href="https://ktor.io/">https://ktor.io/</a></p>
</blockquote>
<p>首先，我们需要使用Intellij IDEA创建一个Ktor项目，如果您拥有Intellij IDEA Ultimate，可以使用其自带的脚手架工具，请参考<a target="_blank" rel="noopener" href="https://ktor.io/docs/intellij-idea.html#create_ktor_project">https://ktor.io/docs/intellij-idea.html#create_ktor_project</a>.</p>
<p>如果您和我一样是平民用户，用的是社区版，那么可以访问 <a target="_blank" rel="noopener" href="https://start.ktor.io/#/settings">https://start.ktor.io/#/settings</a> 快速创建Ktor项目。Ktor包含众多的插件模块用于实现各式各样的功能，我们需要自行选择需要的插件。对于我们的项目，只需要勾选<code>kotlinx.serialization</code>，<code>Content Negotiation</code>，<code>Exposed</code>,  <code>Postgres</code>：</p>
<img src="/post/payment-backends-with-ktor-server/image-1.png" alt="image-1" style="zoom:50%;">

<p>点击 <code>Generate project</code> 按钮之后，在IDEA中打开刚刚下载的空项目，该项目的依赖项应该包括这些：</p>
<pre><code class="kotlin">dependencies &#123;
    implementation(&quot;io.ktor:ktor-server-content-negotiation-jvm:$ktorVersion&quot;)
    implementation(&quot;io.ktor:ktor-server-core-jvm:$ktorVersion&quot;)
    implementation(&quot;io.ktor:ktor-serialization-kotlinx-json-jvm:$ktorVersion&quot;)
    implementation(&quot;io.ktor:ktor-server-auth-jvm:$ktorVersion&quot;)
    implementation(&quot;io.ktor:ktor-server-host-common-jvm:$ktorVersion&quot;)
    implementation(&quot;io.ktor:ktor-server-netty-jvm:$ktorVersion&quot;)

    implementation(&quot;org.jetbrains.exposed:exposed-core:$exposedVersion&quot;)
    implementation(&quot;org.jetbrains.exposed:exposed-jdbc:$exposedVersion&quot;)
    implementation(&quot;org.jetbrains.exposed:exposed-dao:$exposedVersion&quot;)

    implementation(&quot;org.postgresql:postgresql:$postgresqlVersion&quot;)

    implementation(&quot;ch.qos.logback:logback-classic:$logbackVersion&quot;)
&#125;
</code></pre>
<h3 id="在云服务器上搭建Postgres数据库"><a href="#在云服务器上搭建Postgres数据库" class="headerlink" title="在云服务器上搭建Postgres数据库"></a>在云服务器上搭建Postgres数据库</h3><blockquote>
<p>声明：我的云服务器搭载的是ubuntu20.04 64位系统，因此，以下所有命令都基于此系统。</p>
</blockquote>
<ul>
<li>安装Postgres</li>
</ul>
<pre><code class="shell">sudo apt update
sudo apt install postgresql postgresql-contrib
</code></pre>
<ul>
<li>启动Postgres服务</li>
</ul>
<pre><code class="shell">systemctl start postgresql
</code></pre>
<ul>
<li>创建数据库</li>
</ul>
<pre><code class="shell"># 若在root用户下，则先切换到postgres用户下(postgressql自动创建的用户)
# postgres会自动创建一个名为postgres的角色(role)
# 角色是一个可以拥有数据库对象和权限的实体
sudo -u postgres
# 进入sql命令行
psql
# 默认情况下，postgres角色密码为空，请修改密码
/password;
# 创建数据库
CREATE DATABASE 数据库名称;
</code></pre>
<ul>
<li>或者创建新的角色（可选）</li>
</ul>
<pre><code class="shell"># 当然你也可以使用CREATE ROLE命令在postgres中创建新的角色
CREATE ROLE 角色名 WITH LOGIN PASSWORD ‘密码’
# 赋予该角色创建数据库的权限
ALTER ROLE 角色名 CREATEDB; 
# 切换到该角色
psql -U 角色名
# 在该角色下创建数据库
CREATE DATABASE 数据库名;
</code></pre>
<h3 id="连接到Postgres数据库"><a href="#连接到Postgres数据库" class="headerlink" title="连接到Postgres数据库"></a>连接到Postgres数据库</h3><p>回到我们的IDEA，我们尝试在项目中连接到刚刚创建的数据库，创建一个<code>.kt</code>文件，在其中定义：</p>
<pre><code class="kotlin">fun Application.configureDatabases() &#123;
    // 连接到数据库
    val config = environment.config
    val driverClassName = config.property(&quot;storage.driverClassName&quot;).getString()
    val jdbcURL = config.property(&quot;storage.jdbcURL&quot;).getString()
    val database = Database.connect(jdbcURL, driverClassName)
    // 创建缺失的表和列，Orders表我们在后面会定义
    transaction(database) &#123;
       SchemaUtils.createMissingTablesAndColumns(Orders)
    &#125;
&#125;
</code></pre>
<p>这个方法会从项目配置中读取<code>storage.driverClassName</code>和<code>storage.jdbcURL</code>，这两个属性是<code>JDBC</code>连接到Postgres数据库的参数。</p>
<p>我们可以在项目<code>resources</code>目录下的<code>application.conf</code>中找到这两个属性的定义：</p>
<pre><code class="kotlin">storage &#123;
  driverClassName = &quot;org.postgresql.Driver&quot;
  jdbcURL = &quot;jdbc:postgresql://localhost:5432/数据库名?user=角色名&amp;password=密码&quot;
&#125;
</code></pre>
<p>注意，要想成功读取该配置文件，我们需要在<code>Applicatio.kt</code>中将主方法定义为：</p>
<pre><code class="kotlin">fun main(args: Array&lt;String&gt;): Unit = EngineMain.main(args)
</code></pre>
<p>这样写的目的是用 <code>EngineMain</code> 来启动一个嵌入式的 <code>Netty</code> 服务器，并从配置文件中加载应用程序环境和模块，而不用在代码中硬编码。</p>
<h3 id="部署pgAdmin4"><a href="#部署pgAdmin4" class="headerlink" title="部署pgAdmin4"></a>部署pgAdmin4</h3><blockquote>
<p>pgAdmin4是Postgres数据库的可视化管理工具，它可以被部署在云服务器上让我们远程访问数据库，而不用大费周章地远程连接到终端然后使用psql进行管理，官方网站：<a target="_blank" rel="noopener" href="https://www.pgadmin.org/">https://www.pgadmin.org/</a></p>
</blockquote>
<pre><code class="shell"># 安装 pgAdmin
sudo apt install pgadmin4
# 启动 webserver
sudo /usr/pgadmin4/bin/setup-web.sh
</code></pre>
<p>然后，你就可以使用<u>http:&#x2F;&#x2F;[host]&#x2F;pgadmin4&#x2F;</u>来远程管理数据库了。</p>
<p>需要注意的是，如果某个表不存在主键，那么pgAdmin4将无法用可视化的方式修改这个表。</p>
<h3 id="使用Exposed框架进行数据库操作"><a href="#使用Exposed框架进行数据库操作" class="headerlink" title="使用Exposed框架进行数据库操作"></a>使用Exposed框架进行数据库操作</h3><blockquote>
<p>Exposed框架是一个用于Kotlin语言的轻量级SQL库，它基于JDBC驱动，并且由JetBrains官方开发和维护。官方网站：<a target="_blank" rel="noopener" href="https://github.com/JetBrains/Exposed">https://github.com/JetBrains/Exposed</a></p>
</blockquote>
<h4 id="定义订单表"><a href="#定义订单表" class="headerlink" title="定义订单表"></a>定义订单表</h4><pre><code class="kotlin">class Order(id: EntityID&lt;Int&gt;) : IntEntity(id) &#123;

    companion object : IntEntityClass&lt;Order&gt;(Orders)

    var orderId: String by Orders.orderId

    var remoteAddress: String by Orders.remoteAddress

    var createTimestamp: Long by Orders.createTimestamp

    var expirationDuration: Int by Orders.expirationDuration

    var randomDiscount: Int by Orders.randomDiscount

    var priceAfterDiscount: Int by Orders.priceAfterDiscount

    var isPaid: Boolean by Orders.isPaid
        private set

    private var paidAt: String? by Orders.paidAt

    val isExpired: Boolean
        get() &#123;
            return createTimestamp + expirationDuration &lt; System.currentTimeMillis()
        &#125;

    fun markAsPaid() &#123;
        isPaid = true
        paidAt = formatCurrentTime()
    &#125;
&#125;

object Orders : IntIdTable() &#123;
    val orderId = varchar(&quot;orderId&quot;, 128).uniqueIndex()
    val createTimestamp = long(&quot;createTimestamp&quot;)
    val expirationDuration = integer(&quot;expirationDuration&quot;)
    val randomDiscount = integer(&quot;randomDiscount&quot;)
    val priceAfterDiscount = integer(&quot;priceAfterDiscount&quot;)
    val isPaid = bool(&quot;isPaid&quot;).default(false)
    val paidAt = varchar(&quot;paidAt&quot;, 128).nullable()
&#125;
</code></pre>
<p>其中<code>Orders</code>类代表订单在数据库中的Table，而<code>Order</code>类则是代表一个订单的实体类，它可以直接使用<code>by</code>关键字代理<code>Orders</code>中的列。我们的订单需要一个<code>randomDiscount</code>字段用于区分每个订单。</p>
<h4 id="定义DTO"><a href="#定义DTO" class="headerlink" title="定义DTO"></a>定义DTO</h4><pre><code class="kotlin">@Serializable
data class OrderDTO(
    val orderId: String,
    val createTimestamp: Long,
    val remainingMills: Int,
    val priceAfterDiscount: Int,
    val randomDiscount: Int,
    val alipayUrl: String
)

fun Order.toDTO(): OrderDTO &#123;
    return OrderDTO(
        orderId = orderId,
        createTimestamp = createTimestamp,
        remainingMills = (createTimestamp + expirationDuration - System.currentTimeMillis()).toInt(),
        priceAfterDiscount = priceAfterDiscount,
        randomDiscount = randomDiscount,
        alipayUrl = Configurator.ALIPAY_URL
    )
&#125;
</code></pre>
<p><code>OrderDTO</code>是<code>Order</code>类的数据类，它保留了<code>Order</code>中一些我们希望返回给客户端的字段，并且使用<code>@Serializable</code>注解，这代表这个类可以被序列化为<code>JSON</code>。注意这是<code>kotlinx.serialization</code>插件所包含的注解，而不是<code>JDK</code>中的<code>Serializable</code>。</p>
<h4 id="定义DAO"><a href="#定义DAO" class="headerlink" title="定义DAO"></a>定义DAO</h4><p>我们需要定义一个DAO类对数据库进行增删改查，感谢Exposed为我们提供了非常方便的DAO方法，使得我们可以从繁琐易错的<code>SQL</code>中解脱:</p>
<pre><code class="kotlin">object OrderDao &#123;

    fun createNewOrder(deviceId: String, price: Price, discount: Int): Order &#123;
        return Order.new &#123;
            this.expirationDuration = Configurator.ORDER_EXPIRATION_DURATION
            this.createTimestamp =  System.currentTimeMillis()
            this.createTime = currentTimestamp.formatTime()
            this.randomDiscount = discount
            this.priceAfterDiscount = price.currentValue - discount
        &#125;
    &#125;
    
    fun finOrderByDiscount(discount: Int): Order? &#123;
        return Order.find(Orders.discount eq discount).singleOrNull()
    &#125;
&#125;
</code></pre>
<h3 id="处理请求"><a href="#处理请求" class="headerlink" title="处理请求"></a>处理请求</h3><p>在Ktor Server中，我们使用<code>routing</code>方法来处理请求，定义一个方法<code>Application.routeOrders</code>:</p>
<pre><code class="kotlin">val mutex = Mutex()
fun Application.routeOrders() &#123;
 routing &#123;
     post(&quot;/createOrder&quot;) &#123;
        mutex.withLock &#123;
           newSuspendedTransaction &#123;
                 val discount = RandomDiscountDao.getRandomDiscount()
                 if (discount &lt; 0) &#123;
                     // Too many requests!
                     call.respond(HttpStatusCode.TooManyRequests)
                 &#125; else &#123;
                     val created = OrderDao.createNewOrder(
                         deviceId,
                         PriceDao.getActivePrice(),
                         discount
                     )
                     RandomDiscountDao.insertDiscount(discount, created)
                     call.respond(created.toDTO())
                 &#125;
             &#125;
         &#125;
    &#125;
&#125;
</code></pre>
<p>这个方法会处理路径为<u>http:&#x2F;&#x2F;[host]&#x2F;createOrder</u>的<code>POST</code>请求。我们使用<code>newSuspendedTransaction</code>方法来开启一段可挂起的事务（在协程中使用）。需要注意的是，面对可能的并发，为了处理创建订单时可能出现的竞态关系，我们使用<code>Mutex</code>进行加锁，保证并发情况下订单仍然能被安全地创建。如果随机折扣池已经填满，那么我们返回<code>TooManyRequests</code>告知客户端当前订单过多。</p>
<p>不是你是否注意到，我们直接返回了<code>created.toDTO()</code>。这便是<code>Content Negotiation</code>这个插件带给我们的能力，它会自动将<code>OrderDTO</code>转为<code>JSON</code>字符串返回给客户端，不过前提是，我们需要先安装这个插件：</p>
<pre><code class="kotlin">fun Application.configureSerialization() &#123;
    install(ContentNegotiation) &#123;
        json()
    &#125;
&#125;
</code></pre>
<h3 id="本地测试"><a href="#本地测试" class="headerlink" title="本地测试"></a>本地测试</h3><p>显然，我们不能每次都将程序部署到服务器再进行测试，我们需要在本地先进行测试。那么，引入以下两个库：</p>
<pre><code class="kotlin">testImplementation(&quot;io.ktor:ktor-server-tests-jvm:$ktorVersion&quot;)
testImplementation(&quot;org.jetbrains.kotlin:kotlin-test-junit:$kotlinVersion&quot;)
</code></pre>
<p>现在我们来测试一下并发情况下我们的所有订单是否被正常创建了：</p>
<p>首先在项目的<code>test</code>目录下创建测试入口类<code>ApplicationTest</code>：<img src="/post/payment-backends-with-ktor-server/image-2.png" alt="image-2" style="zoom: 50%;"></p>
<p>然后在其中定义</p>
<pre><code class="kotlin">@Test
fun testCreateOrdersConcurrently() = testApplication &#123;
    val orders = coroutineScope &#123;
        (0..9).map &#123;
            async &#123;
                val response = client.post(&quot;/createOrder&quot;)
                assertEquals(HttpStatusCode.OK, response.status)
                Json.decodeFromString&lt;OrderDTO&gt;(response.bodyAsText())
            &#125;
        &#125;.awaitAll()
    &#125;
    assertEquals(10, orders.size)
    val discounts = orders.map &#123; it.randomDiscount &#125;.distinct()
    assertEquals(10, discounts.size)
&#125;
</code></pre>
<p>上述代码以客户端的身份并发地请求了10次创建订单，我们判断每次请求是否成功，并且判断返回的订单数量是否为10，最为重要的是，判断所有订单的折扣是否不同（别忘了，这是我们区分订单的依据！）</p>
<p>当然，直接运行上述测试代码是会报错的，因为我们本地并没有安装Postgres数据库。所以，请先在本地安装并启动Postgres数据库。本地开发环境以Windows为例：</p>
<p>先去下载官网的Windows端安装器，安装好后打开安装位置，比如我安装的位置是：<code>D:\Program Files\PostgreSQL</code>，在这里打开终端，初始化Postgres：</p>
<pre><code class="powershell">.\pg_ctl -D &quot;D:\Program Files\PostgreSQL\14\data&quot; init
</code></pre>
<p>完成后，启动Postgres服务</p>
<pre><code class="powershell">.\pg_ctl -D &quot;D:\Program Files\PostgreSQL\14\data&quot; start
</code></pre>
<p>为了方便使用<code>pg_ctl</code>命令，也可以将他的父目录加入环境变量的<code>path</code>里或者创建<code>PGDATA</code>环境变量，这样就不用手动输入<code>-D</code>参数了。<del>但是悲催的是，由于我的安装路径里存在空格，导致就算指定了<code>PGDATA</code>，也没法正常使用</del>。不出意外的话，服务就已经启动了，默认部署在<code>5432</code>端口。接下来创建数据库：</p>
<pre><code class="powershell">.\psql -U 角色名
CREATE DATABASE 数据库名;
</code></pre>
<p>这样，就可以在本地连接到Postgres数据库了。如果你在安装Postgres时勾选了<code>pgAdmin4</code>，那么便可以使用它来管理数据库。只要打开<code>D:\Program Files\PostgreSQL\14\pgAdmin 4\bin\pgAdmin4.exe</code>即可。</p>
<p>还有一种情况是，我们不希望以客户端的身份进行测试，而是直接测试服务端代码，那么，请使用<code>application</code>包裹代码块：</p>
<pre><code class="kotlin">fun testCreateDiscountsConcurrently() = testApplication &#123;
    application &#123;
        GlobalScope.launch &#123;
            val discounts = (0..9).map &#123;
                async &#123;
                    RandomDiscountDao.getRandomDiscount()
                &#125;
            &#125;.awaitAll()
            assertEquals(10, discounts.distinct().size)
        &#125;
    &#125;
</code></pre>
<p>最后，运行测试代码，然后调试代码直到所有测试通过。</p>
<h3 id="部署程序到云服务器"><a href="#部署程序到云服务器" class="headerlink" title="部署程序到云服务器"></a>部署程序到云服务器</h3><h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><p>在<code>application.conf</code>中，我们需要定义当前程序的模块入口、版本、部署端口和主机：</p>
<pre><code class="kotlin">ktor &#123;
  application &#123;
    modules = [xxx.xxx.xxx.ApplicationKt.module]
    version = 1
  &#125;
  deployment &#123;
    port = 8081
    host = 0.0.0.0
  &#125;
&#125;
</code></pre>
<p>我们需要定义和模块入口相同名称的方法，这个方法会在程序初始化的时候被执行：</p>
<pre><code class="kotlin">fun Application.module() &#123;
    // 配置Content Negotiation
    configureSerialization()
    // 配置数据库
    configureDatabases()
    // 处理请求
    configureRouting()
&#125;
</code></pre>
<p>接下来，我们需要将当前程序打为<code>jar</code>包，我使用的是<code>shadowJar</code>插件，在<code>build.gradle.kts</code>中添加：</p>
<pre><code class="kotlin">plugins &#123;
       // ...
    id(&quot;com.github.johnrengelman.shadow&quot;) version &quot;7.1.2&quot;
&#125;
</code></pre>
<p>然后使用<code>./gradlew shadowJar</code> 进行打包，最终文件将会输出在<code>/build/libs</code>目录下。</p>
<h4 id="手动部署"><a href="#手动部署" class="headerlink" title="手动部署"></a>手动部署</h4><p>最后，就是将<code>jar</code>包推到服务器上然后运行即可。可以使用命令行，也可以使用可视化工具，比如在Windows上我推荐使用<a target="_blank" rel="noopener" href="https://winscp.net/eng/index.php">WinSCP :: Official Site :: Free SFTP and FTP client for Windows</a> ，非常方便快捷。</p>
<p>我们将<code>jar</code>包推到<code>/home/backends/service.jar</code>目录下，接下来我们在该目录价创建一个<code>restart.sh</code>脚本文件用于启动它（请提前在云服务器上安装<code>JRE</code>）：</p>
<pre><code class="shell"># Find the process ID of the process containing &quot;service.jar&quot;
PID=$(ps aux | grep &quot;service.jar&quot; | grep -v grep | awk &#39;&#123;print $2&#125;&#39;)

# Check if the process exists
if [ -z &quot;$PID&quot; ]; then
    echo &quot;No process containing &#39;service.jar&#39; found.&quot;
else
    # Kill the process
    kill $PID
    echo &quot;Process containing &#39;service.jar&#39; has been killed.&quot;
fi

nohup java -jar service.jar &gt; nohup.log 2&gt;&amp;1 &amp;
echo &quot;Service started...&quot;
</code></pre>
<p>这段脚本会判断当前服务是否正在运行，如果是，停止该进程，然后重新启动该服务，程序产生的日志将会被输出到当前目录的<code>nohup.log</code>文件里。</p>
<h4 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h4><p>我使用的是阿里云的ECS服务器，阿里云在IDEA提供了一个插件叫做：<u>Alibaba Cloud Toolkit</u>，它可以帮助我们实现一键部署。</p>
<p>首先在顶栏上找到此插件的图标，点击<code>deploy to ECS</code>：<img src="/post/payment-backends-with-ktor-server/image-3.png" alt="image-3" style="zoom:67%;"></p>
<p>然后如下进行配置：</p>
<img src="/post/payment-backends-with-ktor-server/image-4.png" alt="image-4" style="zoom: 50%;">

<p>我们将<code>File</code>指定为生成的<code>jar</code>包的路径，然后将<code>Target Directory</code>指定为云服务器上的路径，<code>Command</code>指定为我们之间创建的<code>sh</code>脚本文件的路径。通常情况下，每次<code>shadowJar</code>打包都会生成不同的<code>jar</code>文件名（根据程序的版本号），因此我们每次都要重新填写路径，相当麻烦，可以用以下方法解决，在<code>build.gradlew.kts</code>中添加：</p>
<pre><code class="kotlin">import com.github.jengelman.gradle.plugins.shadow.tasks.ShadowJar

tasks.withType&lt;ShadowJar&gt; &#123;
    archiveFileName.set(&quot;service.jar&quot;)
&#125;
</code></pre>
<p>这样，每次打包生成的文件都将保持不变。点击<code>Run</code>按钮即可一键部署！</p>
<h3 id="安全组规则"><a href="#安全组规则" class="headerlink" title="安全组规则"></a>安全组规则</h3><p>虽然我们部署了服务，但是你会发现服务器仍然无法处理相应的请求，这是因为云服务器的安全组规则并未放行我们部署的端口，现在去供应商的控制台配置安全组规则，以阿里云为例：</p>
<img src="/post/payment-backends-with-ktor-server/image-5.png" alt="image-5" style="zoom:67%;">

<p>登录后，在控制台主页左栏找到<code>安全组</code>选项，找到云服务器实例，点击进入，按如下方式或者你的需求配置（注意端口范围和授权对象）：</p>
<p><img src="/post/payment-backends-with-ktor-server/image-6.png" alt="image-6"></p>
<p>配置完成后，如果不出意外，服务器就能正常响应请求了！</p>
<h2 id="Android客户端"><a href="#Android客户端" class="headerlink" title="Android客户端"></a>Android客户端</h2><blockquote>
<p>我们需要客户端处理收款并上报收款信息</p>
</blockquote>
<h3 id="监听系统通知"><a href="#监听系统通知" class="headerlink" title="监听系统通知"></a>监听系统通知</h3><p>Android系统很贴心地为我们提供了这样一个服务叫做 <code>NotificationListenerService</code>，顾名思义，就是监听系统通知的服务类。</p>
<p>使用它，我们变可以实时地获取到支付宝的收款通知，并提取出其中的金额。</p>
<p>首先定义一个服务继承自</p>
<pre><code class="kotlin">class NotificationMonitorService : NotificationListenerService() &#123;
     companion object &#123;

        val COMPONENT_NAME = ComponentName(app, NotificationMonitorService::class.java)

         // 判断我们是否拥有了监听系统通知的权限
        fun isPermissionGranted(): Boolean &#123;
            val packageNames: Set&lt;String&gt; =
                NotificationManagerCompat.getEnabledListenerPackages(app)
            return packageNames.contains(BuildConfig.APPLICATION_ID)
        &#125;

         // 强制重新启动服务
        fun toggleService() &#123;
            val pm: PackageManager = app.packageManager
            pm.setComponentEnabledSetting(
                COMPONENT_NAME,
                PackageManager.COMPONENT_ENABLED_STATE_DISABLED, PackageManager.DONT_KILL_APP
            )
            pm.setComponentEnabledSetting(
                COMPONENT_NAME,
                PackageManager.COMPONENT_ENABLED_STATE_ENABLED, PackageManager.DONT_KILL_APP
            )
        &#125;
    &#125;
&#125;
</code></pre>
<p>然后在清单文件中声明：</p>
<pre><code class="xml">&lt;service
    android:name=&quot;.NotificationMonitorService&quot;
    android:exported=&quot;true&quot;
    android:label=&quot;@string/app_name&quot;
    android:permission=&quot;android.permission.BIND_NOTIFICATION_LISTENER_SERVICE&quot;&gt;
    &lt;intent-filter&gt;
        &lt;action android:name=&quot;android.service.notification.NotificationListenerService&quot; /&gt;
    &lt;/intent-filter&gt;
&lt;/service&gt;
</code></pre>
<p>这个服务当然不是任何应用都能随便启动的，它需要一个特殊的权限<code>android.permission.BIND_NOTIFICATION_LISTENER_SERVICE</code>，当APP启动时，我们直接请求用户授予此权限，因为用户也就我们自己了，这段逻辑不用太过复杂。</p>
<pre><code class="kotlin">override fun onCreate(savedInstanceState: Bundle?) &#123;
    if(!NotificationMonitorService.isPermissionGranted())&#123;
        registerForActivityResult(ActivityResultContracts.StartActivityForResult()) &#123;
            if (NotificationMonitorService.isPermissionGranted()) &#123;
                    toast(R.string.permission_granted)
                    NotificationMonitorService.toggleService()
                &#125;
            &#125; else &#123;
                toast(R.string.permission_denied)
            &#125;
            &#125;.launch(
                Intent(Settings.ACTION_NOTIFICATION_LISTENER_SETTINGS).putExtra(
                Settings.EXTRA_NOTIFICATION_LISTENER_COMPONENT_NAME,
                NotificationMonitorService.COMPONENT_NAME
       		)
        )
    &#125;
&#125;
</code></pre>
<p>当用户授权后，我们的服务将会被系统自动拉起，在<code>NotificationMonitorService</code>的<code>onCreate</code>方法中，我们将该服务提升为前台服务，这样可以在通知栏显示一个通知并保活：</p>
<pre><code class="kotlin">override fun onCreate() &#123;
    val channel = NotificationChannelCompat.Builder(
        CHANNEL_ID_FOREGROUND, NotificationManagerCompat.IMPORTANCE_DEFAULT
    ).setName(applicationInfo.labelRes.str).setShowBadge(false).build()
    notificationManager.createNotificationChannel(channel)
    startForeground(FOREGROUND_SERVICE_ID, buildForegroundNotification(State.IDLE))
 &#125;
</code></pre>
<blockquote>
<p>很有趣的是，其实Android系统会自动保活这个服务，并且会自动在开机时自动启动这个服务，可见这是Android系统开发人员是考虑到了类似于我们这样的需求而适配的特殊策略。</p>
</blockquote>
<p>当通知服务成功连接时，系统会调用<code>onListenerConnected</code>方法，我们在这里获取唤醒锁保证设备不会在熄屏时休眠CPU：</p>
<pre><code class="kotlin">override fun onListenerConnected() &#123;
    super.onListenerConnected()
    wakeLock = powerManager.newWakeLock(
        PowerManager.PARTIAL_WAKE_LOCK, &quot;NotificationMonitorService:Lock&quot;
    )
    wakeLock.acquire()
&#125;
</code></pre>
<p>相应地，在通知服务断开时，释放唤醒锁，如果是意外停止（通过我们自定义的<code>willQuit</code>标志来判断），则尝试重新绑定服务：</p>
<pre><code class="kotlin">override fun onListenerDisconnected() &#123;
    super.onListenerDisconnected()
    if (willQuit) &#123;
        stopForeground(STOP_FOREGROUND_REMOVE)
        serviceState.removeObserver(stateObserver)
        releaseWakeLockIfNeeded()
    &#125; else &#123;
        requestRebind(ComponentName(app, NotificationMonitorService::class.java))
    &#125;
&#125;
</code></pre>
<h3 id="处理通知"><a href="#处理通知" class="headerlink" title="处理通知"></a>处理通知</h3><p>最重要的部分在于处理通知，当系统收到通知时，会回调<code>onNotificationPosted</code>方法：</p>
<pre><code class="kotlin">override fun onNotificationPosted(sbn: StatusBarNotification?) &#123;
     super.onNotificationPosted(sbn)
     sbn?.let &#123; notification -&gt;
         debugLogcat(&quot;Notification received: $sbn&quot;)
         if (notification.packageName == victimPackageName) &#123;
             val extras: Bundle = notification.notification?.extras ?: return
             val title = extras.getString(Notification.EXTRA_TITLE, &quot;&quot;)
             logcat(title)
             val content = extras.getString(Notification.EXTRA_TEXT, &quot;&quot;)
             logcat(content)
             if (receivedNotificationIds.contains(notification.id)) &#123;
                 logcat(&quot;Duplicated notification post event received, distinct!&quot;)
                 return
             &#125;
             if (title != &quot;支付宝收款&quot;) return
             val ret = content.firstGroupValue(&quot;支付宝到账(.+?)元&quot;)
             if (ret != null) &#123;
                 receivedNotificationIds.add(notification.id)
                 callbacks.forEach &#123;
                     it.onPaymentReceived(ret)
                 &#125;
                 if (previousKey != null) &#123;
                     cancelNotification(previousKey)
                 &#125;
                 previousKey = notification.key
             &#125; else &#123;
                 logcat(&quot;Unmatched notification: title = $title&quot;)
             &#125;
         &#125;
     &#125;
&#125;
</code></pre>
<p>在这个方法中，我们使用正则表达式匹配并捕获收款的金额。需要注意的是，系统可能会对同一个通知多次进行回调，我们需要通过通知的<code>id</code>字段来判断此通知是否已经被处理过。在提取到金额之后，我们便可以将金额上报给服务器，服务器通过金额查询到订单，然后将该订单标记为已支付。同时，在用户侧，可以通过手动查询或者轮询来更新订单状态。</p>
<h2 id="业务逻辑总结"><a href="#业务逻辑总结" class="headerlink" title="业务逻辑总结"></a>业务逻辑总结</h2><p>以上便是一个简化版的免签收款系统：用户在产品客户端内点击创建订单——&gt;向我们的服务端发送一个创建订单的请求——&gt;服务端获取折扣金额并创建订单返回给客户端——&gt;产品客户端根据订单的支付链接拉起支付宝进行付款——&gt;用户付款——&gt;收款客户端会收到来自支付宝的通知——&gt;收款客户端提取收款金额并上报给服务端——&gt;服务端将订单标记为已支付——&gt;用户刷新订单状态——&gt;完成支付。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>得益于Kotlin生态的茁壮发展，我们不用切换到其他语言即可完成服务端和客户端的开发，这是一件幸事。还有需要注意的是，以上代码只是这个系统的高度简化版，无论是服务端还是客户端，都还需要更多的业务逻辑以满足不同的需求。</p>
<p>有任何问题请在下方评论，谢谢！</p>

        
                <blockquote style="margin: 2em 0 0;padding: 0.5em 1em;border-left: 3px solid #F44336;background-color: #F5F5F5;list-style: none;">
                    <p><strong>
                        
                            <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a><br />本作品采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
                        </strong>
                        <br>
                        <strong>本文链接：</strong><a href="http://www.xjunz.top/post/payment-backends-with-ktor-server/">http://www.xjunz.top/post/payment-backends-with-ktor-server/</a>
                    </p>
                </blockquote>
        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #ff4e58;
            text-shadow: 0;
            display: none
        }
</style>
	
<div class="btn_click_load"> 
    <button class="disqus_click_btn">阅读评论（请确保 disqus 可以正常加载）</button>
</div>

<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://www.xjunz.top/post/payment-backends-with-ktor-server/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://www.xjunz.top/post/payment-backends-with-ktor-server/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/ls-javascript" id="disqus-lazy-load-script">
    $.ajax({
        url: 'https://disqus.com/next/config.json',
        timeout: 4000,
        type: 'GET',
        success: (function() {
            var d = document;
            var s = d.createElement('script');
            s.src = '//www-xjunz-top.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
            $('.disqus_click_btn').css('display','none');
        })(),
        error: function() {
          $('.disqus_click_btn').css('display','block');
        }
    });
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//www-xjunz-top.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.disqus_click_btn').css('display','none');
    });
</script>
  	

</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>

                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/post/thinking-about-gpt/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/post/DatabaseIPC/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.webp" alt="xjunz's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="" target="_blank" title="Mailto">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Mailto
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2023/03/">三月 2023<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2023/02/">二月 2023<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2022/09/">九月 2022<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2022/07/">七月 2022<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2022/03/">三月 2022<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2021/03/">三月 2021<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/04/">四月 2019<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Android-Dev/">Android Dev<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/categories/Android-UI-UX/">Android UI/UX<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/%E6%9D%82%E8%B0%88/">杂谈<span class="sidebar_archives-count">3</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/timeline" title="时•光">
                
                    <i class="material-icons sidebar-material-icons">history</i>
                
                时•光
            </a>
        </li>
        
    
        <li>
            <a href="/tags/trite" title="牙慧">
                
                    <i class="material-icons sidebar-material-icons">book</i>
                
                牙慧
            </a>
        </li>
        
    
        <li>
            <a href="/gallery" title="画廊">
                
                    <i class="material-icons sidebar-material-icons">local_florist</i>
                
                画廊
            </a>
        </li>
        
    
        <li>
            <a href="/about" title="关于">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                关于
            </a>
        </li>
        
    
        <li>
            <a href="/atom.xml" title="RSS订阅">
                
                    <i class="material-icons sidebar-material-icons">rss_feed</i>
                
                RSS订阅
            </a>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">9</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->


<!-- Help & Support -->
<!--

    <a href="mailto:ibh@live.com" class="sidebar-footer-text-a">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
        sidebar.help
        <span class="mdl-button__ripple-container">
          <span class="mdl-ripple"></span>
        </span>
      </div>
    </a>

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/xjunz" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    
        <a href="https://space.bilibili.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-bilibili">
                <span class="visuallyhidden">Bilibili</span>
            </button><!--
     --></a>
    

    <!-- Telegram -->
    
        <a href="https://t.me/xjunz" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-telegram">
                <span class="visuallyhidden">Telegram</span>
            </button><!--
     --></a>
    

    <!-- V2EX -->
    

    <!-- Segmentfault -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;<span year></span>&nbsp;Me, xjunz's blog
            
                <br>
                
                    <b>The confession of an average man</b>
                
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/bollnh/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?wgjW/HuQG9JDgvPDPoRAng==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?LT4t6iE6m8TO1BLGGiNJqA==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#ff4e58'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #ff4e58, 0 0 15px #ff4e58'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#ff4e58',
        'border-left-color': '#ff4e58'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>



    
        <script>lsloader.load("sm_js","/js/smoothscroll.js?tNQK2Tw2SUL8a1Scn/Mgew==", true)</script>
    





    <!-- Busuanzi -->
    <script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



   <!-- 使用 DISQUS js 代码 -->






<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('
<link rel="stylesheet" href="/css/uc.css">
');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->

    
        
            <script>lsloader.load("prettify_js","/js/prettify.min.js?WN07fivHQSMKWy7BmHBB6w==", true)</script>
        
    



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
        
            $(function() {
                $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
                prettyPrint();
                })
        
    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->

<script type="text/ls-javascript" id="Bing-Background-script">
    queue.offer(function(){
        $('body').attr('data-original', 'https://api.i-meto.com/bing?S');
    });
</script>


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->


    
        
    


<script>
    var copyrightNow = new Date().getFullYear();
    var textContent = document.querySelector('span[year]')

    copyrightSince = 2019;
    if (copyrightSince === copyrightNow||copyrightSince === 0000) {
        textContent.textContent = copyrightNow
    } else {
        textContent.textContent = copyrightSince + ' - ' + copyrightNow
    }

    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.6 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
